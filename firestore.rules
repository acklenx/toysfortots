rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS FOR AUTHORIZATION AND RBAC ---

    // Authorization is granted ONLY if the user's UID is found in the
    // private authorizedVolunteers collection.
    function isAuthorizedVolunteer() {
      return exists(/databases/$(database)/documents/artifacts/toysfortots-eae4d/private/01/data/01/authorizedVolunteers/$(request.auth.uid));
    }

    // Get user's role from authorizedVolunteers collection
    function getUserRole() {
      let volunteer = get(/databases/$(database)/documents/artifacts/toysfortots-eae4d/private/01/data/01/authorizedVolunteers/$(request.auth.uid));
      return volunteer.data.role;
    }

    // Check if user is a volunteer (any authorized user)
    function isVolunteer() {
      return isAuthorizedVolunteer();
    }

    // Check if user is an admin or root user
    function isAdmin() {
      return isAuthorizedVolunteer() && getUserRole() in ['admin', 'root'];
    }

    // Check if user is the root user (super admin)
    function isRoot() {
      return isAuthorizedVolunteer() && getUserRole() == 'root';
    }

    // --- Public Data ---
    match /artifacts/toysfortots-eae4d/public/01/data/01 {

      // Allow ANY authenticated user to read
      // Admins/root can see deleted items (for realtime listener), volunteers see filtered view client-side
      match /locations/{boxId} {
        allow get, list: if request.auth != null;
        allow create: if false; // Only Cloud Functions can create

        // Allow any authenticated user to update ONLY the analytics field
        allow update: if request.auth != null &&
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['analytics']);

        // Allow authorized volunteers to update location data (but not delete fields)
        allow update: if isVolunteer() &&
                         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['deleted', 'deletedAt', 'deletedBy']);

        // Allow volunteers to soft-delete ONLY their own boxes
        allow update: if isVolunteer() &&
                         request.resource.data.deleted == true &&
                         resource.data.volunteer == get(/databases/$(database)/documents/artifacts/toysfortots-eae4d/private/01/data/01/authorizedVolunteers/$(request.auth.uid)).data.displayName;

        // Allow admins to soft delete (any delete-related fields)
        allow update: if isAdmin();

        // Allow root to restore soft deletes (set deleted=false)
        allow update: if isRoot() &&
                         request.resource.data.deleted == false &&
                         resource.data.get('deleted', false) == true;

        // Hard delete only for root (purging soft deletes)
        allow delete: if isRoot();

        // Allow any authenticated user to create analytics events (page views, clicks)
        match /events/{eventId} {
          allow create: if request.auth != null;
          allow read: if isAuthorizedVolunteer();
        }
      }

      // --- TOTSREPORTS RULE ---
      // Volunteers can read all reports (filtering happens client-side)
      match /totsReports/{reportId} {
        allow create: if request.auth != null;
        allow list, get: if isVolunteer();

        // EXPERIMENT 2: Allow admins to update ANY fields (including deleted/deletedAt/deletedBy)
        allow update: if isAdmin();

        // Allow root to restore soft deletes
        allow update: if isRoot() &&
                         request.resource.data.deleted == false &&
                         resource.data.get('deleted', false) == true;

        // Hard delete (purge) only for root
        allow delete: if isRoot();
      }

      // --- LOCATION SUGGESTIONS (for autocomplete) ---
      // Read-only for any authenticated user (needed for setup page autocomplete)
      match /locationSuggestions/{suggestionId} {
        allow get, list: if request.auth != null;
        allow write: if false; // Only Cloud Functions can write
      }
    }

    // --- Private Data ---
    match /artifacts/toysfortots-eae4d/private/01/data/01 {

      match /contacts/{contactId} {
        // REMOVED GOOGLE.COM CHECK: Allow any authenticated user to list/get contacts
        allow list, get: if request.auth != null;
        allow write: if false;
      }

      match /metadata/config {
         allow read, write: if false;
      }

      // This is the collection checked by the isAuthorizedVolunteer function.
      // Volunteers can read, admins can manage (with restrictions)
      match /authorizedVolunteers/{userId} {
        // Allow users to read their OWN document (needed for getUserRole() helper to work)
        // NO deleted check here - must be able to read own document for role-based permissions
        allow get: if request.auth != null &&
                      request.auth.uid == userId;

				// Allow users to update ONLY their displayName in their own document
				allow update: if request.auth != null &&
											 request.auth.uid == userId &&
											 request.resource.data.diff(resource.data).affectedKeys().hasOnly(['displayName']);

        // Allow volunteers to list all volunteers (filtering happens client-side)
        allow list: if isVolunteer();

        allow create: if false; // Only Cloud Functions can create

        // Admins can update volunteers (but not self or root user) - wide open for all fields including soft delete
        allow update: if isAdmin() &&
                         userId != request.auth.uid && // Can't modify self
                         (resource == null || resource.data.role != 'root'); // Can't modify root user

        // Root can restore soft deletes
        allow update: if isRoot() &&
                         request.resource.data.deleted == false &&
                         resource.data.get('deleted', false) == true;

        // Hard delete (purge) - only root
        allow delete: if isRoot();

        // Allow authorized volunteers to write analytics events to their own subcollections
        match /actions/{actionId} {
          allow create: if isAuthorizedVolunteer() && userId == request.auth.uid;
          allow read: if isAuthorizedVolunteer();
        }

        match /events/{eventId} {
          allow create: if isAuthorizedVolunteer() && userId == request.auth.uid;
          allow read: if isAuthorizedVolunteer();
        }
      }

      // --- AUDIT LOGS ---
      // Immutable log of all sensitive operations
      // Only admins can read, only authenticated users can create, only root can purge
      match /auditLogs/{logId} {
        allow create: if request.auth != null; // Anyone authenticated can write logs
        // Admins can read all audit logs (filtering happens client-side)
        allow list, get: if isAdmin();
        allow update, delete: if false; // Immutable, except for root purge

        // Root can soft delete audit logs
        allow update: if isRoot() &&
                         request.resource.data.deleted == true &&
                         resource.data.get('deleted', false) == false;

        // Root can hard delete (purge)
        allow delete: if isRoot();
      }
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
