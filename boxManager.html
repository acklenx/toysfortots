<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Drop Box Action Center</title>
		<!-- Load Tailwind CSS for easy, responsive styling -->
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			/* Custom styling for the slide-down effect */
			.collapsible-content {
				max-height: 0;
				overflow: hidden;
				transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
				padding: 0 1rem;
			}
			.collapsible-content.open {
				max-height: 1000px; /* Large enough value to cover content */
				padding-top: 1rem;
				padding-bottom: 1rem;
			}
		</style>
		<script>
			tailwind.config = {
				theme: {
					extend: {
						fontFamily: {
							sans: ['Inter', 'sans-serif'],
						},
						colors: {
							'tots-red': '#cc0000',
							'tots-green': '#008000',
							'tots-light': '#fcebeb',
						}
					}
				}
			}
		</script>
	</head>
	<body class="bg-gray-50 font-sans p-4">

		<div class="max-w-md mx-auto bg-white shadow-xl rounded-xl overflow-hidden">

			<!-- Header and Location Display -->
			<header class="bg-tots-red p-6">
				<h1 class="text-3xl font-extrabold text-white text-center">Tots Box Action Center</h1>
			</header>

			<main class="p-6">
				<div id="location-display" class="mb-6">
					<!-- Location details inserted here by JavaScript -->
					<p id="loading-message" class="text-center text-gray-500">Loading location data...</p>
				</div>

				<div id="main-actions" class="space-y-4">

					<!-- Pickup Action Button -->
					<button id="pickup-btn" class="w-full py-3 bg-tots-green hover:bg-green-700 text-white font-bold text-lg rounded-lg shadow-md transition duration-200 flex items-center justify-center space-x-2 disabled:opacity-50" disabled>
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
						<span>Request Immediate Pickup</span>
					</button>
					<div id="pickup-confirmation" class="hidden text-sm text-center bg-green-100 text-tots-green p-3 rounded-lg border border-green-300">
						✅ **Pickup Requested!** The team has been alerted.
					</div>

					<!-- Pickup Detail Form (Collapsible) -->
					<div id="pickup-details-section" class="collapsible-content bg-tots-light rounded-lg border border-tots-red/30">
						<p class="text-sm font-semibold text-tots-red mb-3 text-center">
							<span class="font-extrabold">OPTIONAL:</span> Add more details below (e.g., location, contact).
						</p>
						<form id="pickup-details-form" name="pickup-details-form" data-netlify="true" method="POST" class="space-y-3">
							<input type="hidden" name="form-name" value="pickup-details-form">
							<!-- HIDDEN FIELD carrying the essential box ID/info -->
							<input type="hidden" id="pickup-box-id-detail" name="box-info">

							<!-- DEBUG FIELD (Visible for testing) -->
							<label for="debug-pickup-info" class="block text-sm font-medium text-gray-700">Current Box Info (Read-Only):</label>
							<input type="text" id="debug-pickup-info" readonly class="w-full border border-gray-300 bg-gray-100 rounded-md p-2 text-sm text-gray-600 mb-4 cursor-default">

							<label for="pickup-notes-input" class="block text-sm font-medium text-gray-700">Detailed Notes:</label>
							<textarea id="pickup-notes-input" name="notes" rows="3" placeholder="Example: The boxes are full and located behind the counter." class="w-full border border-gray-300 rounded-md p-2 focus:ring-tots-red focus:border-tots-red"></textarea>

							<fieldset class="p-3 border rounded-md">
								<legend class="text-sm font-medium text-gray-700 px-1">Follow-up Contact (Optional):</legend>
								<input type="text" name="contact-name" placeholder="Your Name" class="mt-2 w-full border border-gray-300 rounded-md p-2 text-sm">
								<input type="email" name="contact-email" placeholder="Email" class="mt-2 w-full border border-gray-300 rounded-md p-2 text-sm">
							</fieldset>

							<button type="submit" class="w-full py-2 bg-tots-red hover:bg-red-700 text-white font-semibold rounded-lg transition duration-200">
								Send Detail Report
							</button>
						</form>
						<div id="pickup-details-success" class="hidden mt-3 text-sm text-center bg-green-100 text-tots-green p-3 rounded-lg border border-green-300">
							Thanks! Your detailed notes have been added.
						</div>
					</div>

					<!-- Divider -->
					<div class="h-px bg-gray-200"></div>

					<!-- Problem Action Button -->
					<button id="problem-btn" class="w-full py-3 bg-gray-700 hover:bg-gray-800 text-white font-bold text-lg rounded-lg shadow-md transition duration-200 flex items-center justify-center space-x-2 disabled:opacity-50" disabled>
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
						<span>Report a Problem (Urgent Alert)</span>
					</button>
					<div id="problem-confirmation" class="hidden text-sm text-center bg-red-100 text-tots-red p-3 rounded-lg border border-red-300">
						⚠️ **Problem Alert Sent!** Please add details below.
					</div>

					<!-- Problem Detail Form (Collapsible) -->
					<div id="problem-details-section" class="collapsible-content bg-red-50 rounded-lg border border-red-300">
						<form id="problem-details-form" name="problem-details-form" data-netlify="true" method="POST" class="space-y-3">
							<input type="hidden" name="form-name" value="problem-details-form">
							<!-- HIDDEN FIELD carrying the essential box ID/info -->
							<input type="hidden" id="problem-box-id-detail" name="box-info">

							<!-- DEBUG FIELD (Visible for testing) -->
							<label for="debug-problem-info" class="block text-sm font-medium text-gray-700">Current Box Info (Read-Only):</label>
							<input type="text" id="debug-problem-info" readonly class="w-full border border-gray-300 bg-gray-100 rounded-md p-2 text-sm text-gray-600 mb-4 cursor-default">

							<label for="problem-description-input" class="block text-sm font-medium text-gray-700">What is the problem? <span class="text-tots-red">*</span></label>
							<textarea id="problem-description-input" name="description" rows="4" placeholder="Example: The box was vandalized, or the location is closed unexpectedly." class="w-full border border-gray-300 rounded-md p-2 focus:ring-tots-red focus:border-tots-red" required></textarea>

							<fieldset class="p-3 border rounded-md">
								<legend class="text-sm font-medium text-gray-700 px-1">Follow-up Contact (Optional):</legend>
								<input type="text" name="contact-name" placeholder="Your Name" class="mt-2 w-full border border-gray-300 rounded-md p-2 text-sm">
								<input type="email" name="contact-email" placeholder="Email" class="mt-2 w-full border border-gray-300 rounded-md p-2 text-sm">
							</fieldset>

							<button type="submit" class="w-full py-2 bg-tots-red hover:bg-red-700 text-white font-semibold rounded-lg transition duration-200">
								Send Full Problem Report
							</button>
						</form>
						<div id="problem-details-success" class="hidden mt-3 text-sm text-center bg-green-100 text-tots-green p-3 rounded-lg border border-green-300">
							✅ Thank you! The full problem report has been submitted.
						</div>
					</div>

				</div>
			</main>
		</div>

		<!-- Hidden Forms for Instant Submission via Fetch -->
		<!-- Netlify registers these forms when the page is deployed/viewed -->
		<form name="instant-pickup" data-netlify="true" method="POST" hidden>
			<input type="hidden" name="form-name" value="instant-pickup">
			<input type="text" name="box-info" id="instant-pickup-id">
		</form>
		<form name="instant-problem" data-netlify="true" method="POST" hidden>
			<input type="hidden" name="form-name" value="instant-problem">
			<input type="text" name="box-info" id="instant-problem-id">
		</form>


		<script>
			// --- Data & Initialization ---

			// Data from your locations.json file
			const locations = [
				{ "label": "Solecto Lindo", "address": "4430 Wade Green Rd.", "city": "Kennesaw", "state": "GA", "boxes": 1, "volunteer": "Quincy", "id": "003" },
				{ "label": "Starbucks North", "address": "123 Main St.", "city": "Marietta", "state": "GA", "boxes": 3, "volunteer": "Alice", "id": "001" },
				{ "label": "Local Library", "address": "456 Oak Ave.", "city": "Smyrna", "state": "GA", "boxes": 2, "volunteer": "Bob", "id": "002" }
			];

			// --- DOM Elements ---
			const listDiv = document.getElementById('location-display');
			const loadingMessage = document.getElementById('loading-message');
			const pickupBtn = document.getElementById('pickup-btn');
			const problemBtn = document.getElementById('problem-btn');

			const pickupConf = document.getElementById('pickup-confirmation');
			const problemConf = document.getElementById('problem-confirmation');

			const pickupDetailsSection = document.getElementById('pickup-details-section');
			const problemDetailsSection = document.getElementById('problem-details-section');

			const pickupDetailsForm = document.getElementById('pickup-details-form');
			const problemDetailsForm = document.getElementById('problem-details-form');

			const pickupDetailsSuccess = document.getElementById('pickup-details-success');
			const problemDetailsSuccess = document.getElementById('problem-details-success');

			// --- Utility Functions ---

			// Helper to serialize form data for fetch submission
			const encode = (data) => {
				return Object.keys(data)
						.map(key => encodeURIComponent(key) + "=" + encodeURIComponent(data[key]))
						.join("&");
			}

			// Handles the submission via fetch (for instant, non-page-reloading actions)
			const submitForm = async (formName, data) => {
				try {
					// Targeting the canonical Netlify Forms API endpoint for robust AJAX submission.
					const targetUrl = window.location.origin + "/.netlify/forms";

					const response = await fetch(targetUrl, {
						method: "POST",
						headers: { "Content-Type": "application/x-www-form-urlencoded" },
						// The form-name field is crucial for Netlify's processing
						body: encode({ "form-name": formName, ...data })
					});

					// Netlify's Forms endpoint usually returns 200/204 on success.
					if (response.ok || response.status === 204) {
						return true;
					} else {
						console.error("Netlify form submission failed.", response);
						return false;
					}
				} catch (error) {
					console.error("Network or fetch error:", error);
					return false;
				}
			};


			// --- Main Logic ---

			document.addEventListener('DOMContentLoaded', () => {
				const params = new URLSearchParams(window.location.search);
				const boxId = params.get('id'); // Reads the ID from the URL parameter '?id=003'

				if (!boxId) {
					loadingMessage.className = 'text-center text-tots-red font-bold p-4';
					loadingMessage.textContent = "Error: Box ID missing from the link. Cannot proceed.";
					return;
				}

				console.log(`[DEBUG] Box ID found in URL: ${boxId}`);

				const location = locations.find(loc => loc.id === boxId);

				if (!location) {
					loadingMessage.className = 'text-center text-tots-red font-bold p-4';
					loadingMessage.textContent = `Error: Location with ID "${boxId}" not found.`;
					return;
				}

				const boxInfoString = `${location.label} (ID: ${location.id}) @ ${location.address}`;
				console.log(`[DEBUG] Box Info String: ${boxInfoString}`);

				// 1. Display the location information
				loadingMessage.remove(); // Remove loading message
				listDiv.innerHTML = `
                <div class="bg-tots-light p-4 rounded-lg border border-tots-red shadow-inner">
                    <h2 class="text-xl font-bold text-tots-red">${location.label}</h2>
                    <p class="text-sm text-gray-700 mt-1">${location.address}, ${location.city}, ${location.state}</p>
                    <p class="text-sm font-semibold mt-3">Box ID: <span class="text-tots-red">${location.id}</span></p>
                    <p class="text-sm font-semibold">Assigned Volunteer: ${location.volunteer}</p>
                </div>
            `;

				// 2. Populate ALL hidden and debug fields for form submissions
				document.getElementById('instant-pickup-id').value = boxInfoString;
				document.getElementById('instant-problem-id').value = boxInfoString;
				document.getElementById('pickup-box-id-detail').value = boxInfoString;
				document.getElementById('problem-box-id-detail').value = boxInfoString;

				// Populate Debug Fields
				document.getElementById('debug-pickup-info').value = boxInfoString;
				document.getElementById('debug-problem-info').value = boxInfoString;


				// 3. Enable buttons
				pickupBtn.disabled = false;
				problemBtn.disabled = false;
			});

			// --- Event Listeners for Instant Actions ---

			// --- PICKUP BUTTON HANDLER ---
			pickupBtn.addEventListener('click', async () => {
				pickupBtn.disabled = true;
				pickupBtn.innerHTML = 'Sending...';

				// Get the value from the hidden field
				const boxInfo = document.getElementById('instant-pickup-id').value;
				// Submit to Netlify form 'instant-pickup' with 'box-info' data
				const success = await submitForm('instant-pickup', { "box-info": boxInfo });

				if (success) {
					// 1. Show confirmation for instant submission
					pickupConf.classList.remove('hidden');

					// 2. Slide open the optional detail form
					pickupDetailsSection.classList.add('open');

					// 3. Update button text and enable problem button
					pickupBtn.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg> <span>Pickup Request Sent!</span>';
					pickupBtn.classList.remove('bg-tots-green');
					pickupBtn.classList.add('bg-green-600');
				} else {
					pickupBtn.disabled = false;
					pickupBtn.innerHTML = 'Error! Try Again.';
				}
			});

			// --- PROBLEM BUTTON HANDLER ---
			problemBtn.addEventListener('click', async () => {
				problemBtn.disabled = true;
				problemBtn.innerHTML = 'Sending Urgent Alert...';

				// Get the value from the hidden field
				const boxInfo = document.getElementById('instant-problem-id').value;
				// Submit to Netlify form 'instant-problem' with 'box-info' data
				const success = await submitForm('instant-problem', { "box-info": boxInfo });

				if (success) {
					// 1. Show confirmation that the alert was sent
					problemConf.classList.remove('hidden');

					// 2. Slide open the required detail form
					problemDetailsSection.classList.add('open');

					// 3. Update button text (silent action is complete)
					problemBtn.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg> <span>Urgent Problem Alert Sent!</span>';
				} else {
					problemBtn.disabled = false;
					problemBtn.innerHTML = 'Error! Try Again.';
				}
			});

			// --- Event Listeners for Detail Forms (Optional/Required) ---

			// --- PICKUP DETAILS SUBMISSION ---
			pickupDetailsForm.addEventListener('submit', async (e) => {
				e.preventDefault();
				const form = e.target;
				const submitButton = form.querySelector('button[type="submit"]');

				submitButton.disabled = true;
				submitButton.textContent = 'Submitting...';

				// Uses the form's natural action (Netlify processing) combined with fetch
				const formData = new FormData(form);
				const success = await submitForm(form.name, Object.fromEntries(formData.entries()));

				if (success) {
					// 1. Show final success message
					pickupDetailsSuccess.classList.remove('hidden');
					form.remove(); // Remove the form once submitted
				} else {
					submitButton.disabled = false;
					submitButton.textContent = 'Error sending details. Try again.';
				}
			});

			// --- PROBLEM DETAILS SUBMISSION ---
			problemDetailsForm.addEventListener('submit', async (e) => {
				e.preventDefault();
				const form = e.target;
				const submitButton = form.querySelector('button[type="submit"]');

				submitButton.disabled = true;
				submitButton.textContent = 'Submitting...';

				// Uses the form's natural action (Netlify processing) combined with fetch
				const formData = new FormData(form);
				const success = await submitForm(form.name, Object.fromEntries(formData.entries()));

				if (success) {
					// 1. Show final success message
					problemDetailsSuccess.classList.remove('hidden');
					form.remove(); // Remove the form once submitted
				} else {
					submitButton.disabled = false;
					submitButton.textContent = 'Error sending report. Try again.';
				}
			});
		</script>
	</body>
</html>
