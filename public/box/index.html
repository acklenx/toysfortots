<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: https: blob:; font-src 'self' data: https://unpkg.com; connect-src 'self' http://localhost:* ws://localhost:* https://*.gstatic.com https://unpkg.com https://*.googleapis.com https://*.cloudfunctions.net https://*.firebaseapp.com https://*.firebaseio.com https://*.google.com https://tile.openstreetmap.org wss://*.firebaseio.com; frame-src 'self' https://*.google.com; object-src 'none'; base-uri 'self'; form-action 'self'">
		<meta name="description" content="Report issues with Toys for Tots donation boxes. Request immediate pickup for full boxes or report problems. Run by the Marine Corps Reserve and supported locally by Marine Corps League Detachment 1311 in North Metro Atlanta.">
		<title>Drop Box Action Center</title>
		<link rel="stylesheet" href="/css/style.min.css?v=1.0.7">
		<script type="module">
			import { auth, db, functions, locationsCollectionPath, reportsCollectionPath } from '../js/firebase-init.js';
			import {
				signInAnonymously,
				onAuthStateChanged
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
			import {
				doc,
				getDoc
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
			import {
				httpsCallable
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js';

			let currentBoxInfo;
			const setupFirebase = () =>
			{
				try
				{
					let appInitialized = false;
					onAuthStateChanged( auth, ( user ) =>
					{
						if( user && !appInitialized )
						{
							appInitialized = true;
							window.initApp();
						}
						else if( !user )
						{
							signInAnonymously( auth ).catch( ( err ) =>
							{
								console.error( 'Anonymous sign-in failed:', err );
								document.getElementById( 'loading-message' ).textContent = `ERROR: Sign-in failed. ${ err.message }`;
							} );
						}
					} );
				}
				catch( error )
				{
					console.error( 'Firebase Initialization Error:', error );
					document.getElementById( 'loading-message' ).textContent = `ERROR: Firebase setup failed. ${ error.message }`;
				}
			};
			window.initApp = async() =>
			{
				const listDiv = document.getElementById( 'location-display' );
				const loadingMessage = document.getElementById( 'loading-message' );
				const pickupBtn = document.getElementById( 'pickup-btn' );
				const problemBtn = document.getElementById( 'problem-btn' );
				const pickupBtnText = document.getElementById( 'pickup-btn-text' );
				const pickupConf = document.getElementById( 'pickup-confirmation' );
				const problemConf = document.getElementById( 'problem-confirmation' );
				const problemDetailsSection = document.getElementById( 'problem-details-section' );
				const problemDetailsForm = document.getElementById( 'problem-details-form' );
				const problemSubmitBtn = document.getElementById( 'problem-submit-btn' );
				const problemDetailsSuccess = document.getElementById( 'problem-details-success' );
				const params = new URLSearchParams( window.location.search );
				const boxId = params.get( 'id' );
				if( !boxId )
				{
					loadingMessage.className = 'text-center text-tots-red font-bold p-4';
					loadingMessage.textContent = 'Error: ID missing from the link. Cannot display info.';
					return;
				}
				try
				{
					const locRef = doc( db, locationsCollectionPath, boxId );
					const locSnap = await getDoc( locRef );
					if( !locSnap.exists() )
					{
						window.location.href = `/setup/?id=${ boxId }`;
						return;
					}
					const location = locSnap.data();
					currentBoxInfo = `${ location.label } (ID: ${ boxId }) @ ${ location.address }`;
					loadingMessage.remove();
					let volunteerDisplayName = 'MCL 1311';
					if( location.volunteer )
					{
						volunteerDisplayName = location.volunteer;
						const atIndex = volunteerDisplayName.indexOf( '@' );
						if( atIndex !== -1 )
						{
							volunteerDisplayName = volunteerDisplayName.substring( 0, atIndex );
						}
					}

					// XSS Protection: Escape HTML to prevent script injection
					const escapeHtml = (unsafe) => {
						if (!unsafe) return '';
						return String(unsafe)
							.replace(/&/g, '&amp;')
							.replace(/</g, '&lt;')
							.replace(/>/g, '&gt;')
							.replace(/"/g, '&quot;')
							.replace(/'/g, '&#039;');
					};

					listDiv.innerHTML = `
                   <div class="info-box">
                       <h2 class="info-title">${ escapeHtml(location.label) }</h2>
                       <p class="info-text">${ escapeHtml(location.address) }, ${ escapeHtml(location.city) }, ${ escapeHtml(location.state) }</p>
                       <p class="info-detail">Box ID: <span class="text-tots-red font-semibold">${ escapeHtml(boxId) }</span></p>
                       <p class="info-detail">Assigned Volunteer: <span class="font-semibold">${ escapeHtml(volunteerDisplayName) }</span></p>
                   </div>
               `;
					document.getElementById( 'problem-box-id-detail' ).value = currentBoxInfo;
					pickupBtn.disabled = false;
					problemBtn.disabled = false;
					const getFormData = ( form ) =>
					{
						const formData = new FormData( form );
						const data = {};
						formData.forEach( ( value, key ) =>
						{
							data[ key ] = value;
						} );
						return data;
					};
					const toggleSection = ( sectionToShow, confToShow, sectionToHide, confToHide ) =>
					{
						if( sectionToShow )
						{
							sectionToShow.classList.add( 'open' );
						}
						if( confToShow )
						{
							confToShow.classList.remove( 'hidden' );
						}
						if( sectionToHide )
						{
							sectionToHide.classList.remove( 'open' );
						}
						if( confToHide )
						{
							confToHide.classList.add( 'hidden' );
						}
					};
					pickupBtn.addEventListener( 'click', () =>
					{
						const quickReport = {
							reportType: 'pickup_alert',
							description: 'Immediate pickup requested via button click.'
						};
						submitReportToFirestore( quickReport, boxId, location );
						pickupBtnText.textContent = 'A volunteer has been notified!';
						pickupBtn.disabled = true;
						pickupBtn.classList.add( 'opacity-50', 'cursor-not-allowed' );
						pickupConf.classList.remove( 'hidden' );
						pickupConf.textContent = 'âœ… Message Sent! A volunteer has been notified.';
						if( problemDetailsSection )
						{
							problemDetailsSection.classList.remove( 'open' );
						}
						if( problemConf )
						{
							problemConf.classList.add( 'hidden' );
						}
					} );
					problemBtn.addEventListener( 'click', () =>
					{
						toggleSection(
								problemDetailsSection,
								null,
								pickupConf
						);
					} );
					if( problemSubmitBtn )
					{
						problemSubmitBtn.addEventListener( 'click', async( e ) =>
						{
							const submitButton = e.target;
							submitButton.disabled = true;
							submitButton.textContent = 'Sending...';
							const description = problemDetailsForm.querySelector( 'textarea[name="description"]' ).value;
							if( !description || description.trim() === '' )
							{
								alert( 'Please fill out the problem description.' );
								submitButton.disabled = false;
								submitButton.textContent = 'Send Full Problem Report';
								return;
							}
							const reportData = getFormData( problemDetailsForm );
							const success = await submitReportToFirestore( reportData, boxId, location );
							if( success )
							{
								problemDetailsSuccess.classList.remove( 'hidden' );
								submitButton.textContent = 'Report Sent!';
							}
							else
							{
								alert( 'There was an error submitting your report. Please try again.' );
								submitButton.disabled = false;
								submitButton.textContent = 'Send Full Problem Report';
							}
						} );
					}
					else
					{
						console.error( 'Could not find the problem submit button (#problem-submit-btn)' );
					}
				}
				catch( error )
				{
					console.error( 'Error fetching location:', error );
					if( loadingMessage )
					{
						loadingMessage.className = 'text-center text-tots-red font-bold p-4';
						loadingMessage.textContent = `Error loading location data: ${ error.message }`;
					}
				}
			};
			const submitReportToFirestore = async( reportData, boxId, location ) =>
			{
				if( !functions || !auth.currentUser )
				{
					console.error( 'Functions not initialized or user not authenticated.' );
					return false;
				}
				try
				{
					const userId = auth.currentUser.uid;
					const reporterNameFromForm = reportData.contactName;
					const reporterEmailFromForm = reportData.contactEmail;
					delete reportData.contactName;
					delete reportData.contactEmail;

					// Call Cloud Function to create report with sequential ID
					const createReport = httpsCallable( functions, 'createReportV2' );
					const result = await createReport( {
						boxId: boxId,
						reportData: {
							...reportData,
							reporterId: userId,
							reporterName: reporterNameFromForm || null,
							reporterEmail: reporterEmailFromForm || null
						}
					} );

					if( result.data && result.data.success )
					{
						return true;
					}
					else
					{
						console.error( 'Report creation failed:', result.data );
						return false;
					}
				}
				catch( error )
				{
					console.error( 'Report submission failed:', error );
					return false;
				}
			};
			setupFirebase();
		</script>
	</head>
	<body class="bg-gray-100">
		<div id="header-placeholder"></div>

		<main class="page-container">
			<div class="main-content">
			<div class="content-box">
				<h1 class="page-title">Toys for Tots Drop Box</h1>

				<div id="location-display" class="mb-6">
					<p id="loading-message" class="text-center text-gray-500">Loading location data...</p>
				</div>

				<div id="main-actions">
					<!-- Green pickup button box -->
					<div class="action-box">
						<button id="pickup-btn" class="action-button" disabled>
							<span id="pickup-btn-text">ðŸšš Request Immediate Pickup</span>
						</button>
						<p class="action-description">Click here if this box is full and needs to be picked up right away.</p>
					</div>

					<div id="pickup-confirmation" class="hidden confirmation-message success">
						âœ… Message Sent! A volunteer has been notified.
					</div>

					<!-- Problem report link -->
					<div style="text-align: right; margin-top: 1.5rem;">
						<a href="#" id="problem-btn" class="text-link" disabled>Report a Problem</a>
					</div>

					<!-- Problem details form -->
					<div id="problem-details-section" class="collapsible-content mt-4">
						<form id="problem-details-form" class="form-container">
							<input type="hidden" id="problem-box-id-detail" name="boxInfo">
							<input type="hidden" name="reportType" value="problem_report">

							<div class="form-group">
								<label class="form-label" for="problemDescription">
									What is the problem? <span class="text-tots-red">*</span>
								</label>
								<textarea
									name="description"
									id="problemDescription"
									rows="4"
									placeholder="Example: The box was vandalized, or the location is closed unexpectedly."
									class="form-input"
									required></textarea>
							</div>

							<fieldset class="form-fieldset">
								<legend>Follow-up Contact (Optional):</legend>
								<div class="form-group">
									<label for="problemContactName" class="sr-only">Your Name</label>
									<input type="text" id="problemContactName" name="contactName" placeholder="Your Name" class="form-input">
								</div>
								<div class="form-group">
									<label for="problemContactEmail" class="sr-only">Email</label>
									<input type="email" id="problemContactEmail" name="contactEmail" placeholder="Email" class="form-input">
								</div>
							</fieldset>

							<button type="button" id="problem-submit-btn" class="submit-button">
								Send Problem Report
							</button>
						</form>

						<div id="problem-details-success" class="hidden confirmation-message success mt-3">
							âœ… Thank you! The problem has been recorded instantly!
						</div>
					</div>
				</div>
			</div>
			</div>
		</main>

		<div id="footer-placeholder"></div>
		<script src="/js/loader.min.js" defer></script>
	</body>
</html>