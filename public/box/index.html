<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Drop Box Action Center</title>
		<link rel="stylesheet" href="/css/style.css?v=1.0.7">
		<script type="module">
			import { auth, db, locationsCollectionPath, reportsCollectionPath } from '../js/firebase-init.js';
			import {
				signInAnonymously,
				onAuthStateChanged
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
			import {
				doc,
				getDoc,
				addDoc,
				collection
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

			let currentBoxInfo;
			const setupFirebase = () =>
			{
				console.log( 'Setting up Firebase...' );
				try
				{
					let appInitialized = false;
					onAuthStateChanged( auth, ( user ) =>
					{
						console.log( 'Auth state changed. User:', user ? user.uid : 'null' );
						if( user && !appInitialized )
						{
							appInitialized = true;
							console.log( 'User is authenticated. Initializing main app...' );
							window.initApp();
						}
						else if( !user )
						{
							console.log( 'No user found. Attempting anonymous sign-in...' );
							signInAnonymously( auth ).catch( ( err ) =>
							{
								console.error( 'Anonymous sign-in failed:', err );
								document.getElementById( 'loading-message' ).textContent = `ERROR: Sign-in failed. ${ err.message }`;
							} );
						}
					} );
				}
				catch( error )
				{
					console.error( 'Firebase Initialization Error:', error );
					document.getElementById( 'loading-message' ).textContent = `ERROR: Firebase setup failed. ${ error.message }`;
				}
			};
			window.initApp = async() =>
			{
				const listDiv = document.getElementById( 'location-display' );
				const loadingMessage = document.getElementById( 'loading-message' );
				const pickupBtn = document.getElementById( 'pickup-btn' );
				const problemBtn = document.getElementById( 'problem-btn' );
				const pickupBtnText = document.getElementById( 'pickup-btn-text' );
				const pickupConf = document.getElementById( 'pickup-confirmation' );
				const problemConf = document.getElementById( 'problem-confirmation' );
				const problemDetailsSection = document.getElementById( 'problem-details-section' );
				const problemDetailsForm = document.getElementById( 'problem-details-form' );
				const problemSubmitBtn = document.getElementById( 'problem-submit-btn' );
				const problemDetailsSuccess = document.getElementById( 'problem-details-success' );
				const params = new URLSearchParams( window.location.search );
				const boxId = params.get( 'id' );
				if( !boxId )
				{
					loadingMessage.className = 'text-center text-tots-red font-bold p-4';
					loadingMessage.textContent = 'Error: ID missing from the link. Cannot display info.';
					return;
				}
				try
				{
					const locRef = doc( db, locationsCollectionPath, boxId );
					const locSnap = await getDoc( locRef );
					if( !locSnap.exists() )
					{
						console.log( `Box ID ${ boxId } not found. Redirecting to setup page...` );
						window.location.href = `/setup/?id=${ boxId }`;
						return;
					}
					const location = locSnap.data();
					currentBoxInfo = `${ location.label } (ID: ${ boxId }) @ ${ location.address }`;
					loadingMessage.remove();
					let volunteerDisplayName = 'MCL 1311';
					if( location.volunteer )
					{
						volunteerDisplayName = location.volunteer;
						const atIndex = volunteerDisplayName.indexOf( '@' );
						if( atIndex !== -1 )
						{
							volunteerDisplayName = volunteerDisplayName.substring( 0, atIndex );
						}
					}
					listDiv.innerHTML = `
                   <div class="bg-tots-light p-4 rounded-lg border border-tots-red shadow-inner">
                       <h2 class="text-xl font-bold text-tots-red">${ location.label }</h2>
                       <p class="text-sm text-gray-700 mt-1">${ location.address }, ${ location.city }, ${ location.state }</p>
                       <p class="text-sm font-semibold mt-3">Box ID: <span class="text-tots-red">${ boxId }</span></p>
                       <p class="text-sm font-semibold">Assigned Volunteer: ${ volunteerDisplayName }</p>
                   </div>
               `;
					document.getElementById( 'problem-box-id-detail' ).value = currentBoxInfo;
					pickupBtn.disabled = false;
					problemBtn.disabled = false;
					const getFormData = ( form ) =>
					{
						const formData = new FormData( form );
						const data = {};
						formData.forEach( ( value, key ) =>
						{
							data[ key ] = value;
						} );
						return data;
					};
					const toggleSection = ( sectionToShow, confToShow, sectionToHide, confToHide ) =>
					{
						if( sectionToShow )
						{
							sectionToShow.classList.add( 'open' );
						}
						if( confToShow )
						{
							confToShow.classList.remove( 'hidden' );
						}
						if( sectionToHide )
						{
							sectionToHide.classList.remove( 'open' );
						}
						if( confToHide )
						{
							confToHide.classList.add( 'hidden' );
						}
					};
					pickupBtn.addEventListener( 'click', () =>
					{
						const quickReport = {
							reportType: 'pickup_alert',
							description: 'Immediate pickup requested via button click.'
						};
						submitReportToFirestore( quickReport, boxId, location );
						pickupBtnText.textContent = 'A volunteer has been notified!';
						pickupBtn.disabled = true;
						pickupBtn.classList.add( 'opacity-50', 'cursor-not-allowed' );
						pickupConf.classList.remove( 'hidden' );
						pickupConf.textContent = '✅ Message Sent! A volunteer has been notified.';
						if( problemDetailsSection )
						{
							problemDetailsSection.classList.remove( 'open' );
						}
						if( problemConf )
						{
							problemConf.classList.add( 'hidden' );
						}
					} );
					problemBtn.addEventListener( 'click', () =>
					{
						toggleSection(
								problemDetailsSection,
								problemConf,
								pickupConf
						);
					} );
					if( problemSubmitBtn )
					{
						problemSubmitBtn.addEventListener( 'click', async( e ) =>
						{
							const submitButton = e.target;
							submitButton.disabled = true;
							submitButton.textContent = 'Sending...';
							const description = problemDetailsForm.querySelector( 'textarea[name="description"]' ).value;
							if( !description || description.trim() === '' )
							{
								alert( 'Please fill out the problem description.' );
								submitButton.disabled = false;
								submitButton.textContent = 'Send Full Problem Report';
								return;
							}
							const reportData = getFormData( problemDetailsForm );
							const success = await submitReportToFirestore( reportData, boxId, location );
							if( success )
							{
								problemDetailsSuccess.classList.remove( 'hidden' );
								submitButton.textContent = 'Report Sent!';
							}
							else
							{
								alert( 'There was an error submitting your report. Please try again.' );
								submitButton.disabled = false;
								submitButton.textContent = 'Send Full Problem Report';
							}
						} );
					}
					else
					{
						console.error( 'Could not find the problem submit button (#problem-submit-btn)' );
					}
				}
				catch( error )
				{
					console.error( 'Error fetching location:', error );
					if( loadingMessage )
					{
						loadingMessage.className = 'text-center text-tots-red font-bold p-4';
						loadingMessage.textContent = `Error loading location data: ${ error.message }`;
					}
				}
			};
			const submitReportToFirestore = async( reportData, boxId, location ) =>
			{
				if( !db || !auth.currentUser )
				{
					console.error( 'Firestore not initialized or user not authenticated.' );
					return false;
				}
				try
				{
					const userId = auth.currentUser.uid;
					const timestamp = new Date().toISOString();
					const reportCollectionRef = collection( db, reportsCollectionPath );
					const reporterNameFromForm = reportData.contactName;
					const reporterEmailFromForm = reportData.contactEmail;
					delete reportData.contactName;
					delete reportData.contactEmail;
					const fullReport = {
						...reportData,
						...location,
						boxId: boxId,
						timestamp: timestamp,
						reporterId: userId,
						status: 'new',
						reporterName: reporterNameFromForm || null,
						reporterEmail: reporterEmailFromForm || null
					};
					await addDoc( reportCollectionRef, fullReport );
					return true;
				}
				catch( error )
				{
					console.error( 'Firestore submission failed:', error );
					return false;
				}
			};
			setupFirebase();
		</script>
	</head>
	<body>
		<header>
			<div class="header-content">
				<a href="https://www.toysfortots.org" target="_blank" rel="noopener noreferrer">
					<img src="/images/t4t-logo.png" height="60" alt="Toys for Tots Logo" class="logo t4t-logo">
				</a>
				<div class="header-text">
					<a href="https://toysfortots.mcl1311.com/" rel="noopener noreferrer" style="color: var(--marine-blue);">
						<h1>Toys for Tots Drop-Off Locations</h1>
					</a>
					<a href="https://northatlanta.toysfortots.org/" target="_blank" rel="noopener noreferrer" style="color: var(--t4t-red);">
						<h2>North Metro Atlanta Area</h2>
					</a>
					<p class="sub-header">Coordinated by Marine Corps League Detachment #1311, Woodstock, GA</p>
				</div>
				<a href="/dashboard">
					<img src="/images/mcl-logo.png" height="80" alt="Marine Corps League Logo" class="logo mcl-logo">
				</a>
			</div>
		</header>
		<div class="max-w-md mx-auto bg-white shadow-xl rounded-xl overflow-hidden" style="margin-top: 20px; margin-bottom: 20px;">
			<div class="bg-tots-red p-6">
				<h1 class="text-3xl font-extrabold text-white text-center">Tots Box Action Center</h1>
			</div>
			<main class="p-6">
				<div id="location-display" class="mb-6">
					<p id="loading-message" class="text-center text-gray-500">Loading location data...</p>
				</div>
				<div id="main-actions" class="space-y-4">
					<button id="pickup-btn" class="w-full py-3 bg-tots-green hover:bg-green-700 text-white font-bold text-lg rounded-lg shadow-md transition duration-200 flex items-center justify-center space-x-2 disabled:opacity-50" disabled>
						<span id="pickup-btn-text">Request Immediate Pickup</span>
					</button>
					<div id="pickup-confirmation" class="hidden text-sm text-center bg-green-100 text-tots-green p-3 rounded-lg border border-green-300">
						✅ Message Sent! Would you like to send any additional details?
					</div>
					<div class="h-px bg-gray-200"></div>
					<button id="problem-btn" class="w-full py-2 text-center text-sm font-medium text-gray-600 hover:text-tots-red hover:underline transition duration-200 disabled:opacity-50" disabled>
						<span id="problem-btn-text">Report a Problem</span>
					</button>
					<div id="problem-confirmation" class="hidden text-sm text-center bg-red-100 text-tots-red p-3 rounded-lg border border-red-300">
						⚠️ Please tell us the nature of the problem.
					</div>
					<div id="problem-details-section" class="collapsible-content bg-red-50 rounded-lg border border-red-300">
						<form id="problem-details-form" class="space-y-3">
							<input type="hidden" id="problem-box-id-detail" name="boxInfo">
							<input type="hidden" name="reportType" value="problem_report">
							<label class="block text-sm font-medium text-gray-700" for="problemDescription">What is the
								problem? <span class="text-tots-red">*</span></label>
							<textarea name="description" id="problemDescription" rows="4" placeholder="Example: The box was vandalized, or the location is closed unexpectedly." class="w-full border border-gray-300 rounded-md p-2 focus:ring-tots-red focus:border-tots-red" required></textarea>
							<fieldset class="problem-contact-fieldset">
								<legend>Follow-up Contact (Optional):</legend>

								<div class="input-wrapper">
									<label for="problemContactName" class="sr-only">Your Name</label>
									<input type="text" id="problemContactName"  name="contactName" placeholder="Your Name">
								</div>

								<div class="input-wrapper">
									<label for="problemContactEmail" class="sr-only">Email</label>
									<input type="email" id="problemContactEmail"  name="contactEmail" placeholder="Email">
								</div>
							</fieldset>
							<button type="button" id="problem-submit-btn" class="w-full py-2 bg-tots-red hover:bg-red-700 text-white font-semibold rounded-lg transition duration-200">
								Send Full Problem Report
							</button>
						</form>
						<div id="problem-details-success" class="hidden mt-3 text-sm text-center bg-green-100 text-tots-green p-3 rounded-lg border border-green-300">
							✅ Thank you! The problem has been recorded instantly!
						</div>
					</div>
				</div>
			</main>
		</div>
		<div id="footer-placeholder"></div>
		<script src="/js/loader.js" defer></script>
	</body>
</html>