<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: https: blob:; font-src 'self' data: https://unpkg.com; connect-src 'self' http://localhost:* ws://localhost:* https://*.gstatic.com https://unpkg.com https://*.googleapis.com https://*.cloudfunctions.net https://*.firebaseapp.com https://*.firebaseio.com https://*.google.com https://tile.openstreetmap.org wss://*.firebaseio.com; frame-src 'self' https://*.google.com; object-src 'none'; base-uri 'self'; form-action 'self'">
		<meta name="description" content="View Toys for Tots donation box status and history. Track pickups and issues for donation boxes in North Metro Atlanta. Run by the Marine Corps Reserve with local support from Marine Corps League Detachment 1311.">
		<title>Box History</title>
		<link rel="stylesheet" href="/css/style.min.css?v=1.0.7">

		<script type="module">
			// --- 1. IMPORTS ---
			import { auth, db, functions, locationsCollectionPath, reportsCollectionPath } from '../js/firebase-init.js';
			import {
				signInAnonymously,
				onAuthStateChanged
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
			import {
				doc,
				getDoc,
				collection,
				getDocs,
				query,
				where,
				orderBy,
				updateDoc,
				increment,
				setDoc,
				addDoc,
				serverTimestamp
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
			import { httpsCallable } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js';
			import { formatDate } from '/js/utils.min.js';
			// --- 2. CONFIG & TOP-LEVEL VARS ---
			// Config is now imported

			// --- 3. FIREBASE SETUP ---
			const setupFirebase = () =>
			{
				try
				{
					let appInitialized = false;
					onAuthStateChanged( auth, ( user ) =>
					{
						if( user && !appInitialized )
						{
							appInitialized = true;
							window.initApp();
						}
						else if( !user )
						{
							signInAnonymously( auth ).catch( ( err ) =>
							{
								console.error( 'Anonymous sign-in failed:', err );
							} );
						}
					} );
				}
				catch( error )
				{
					console.error( 'Firebase Initialization Error:', error );
				}
			};

			// XSS Protection: Escape HTML to prevent script injection
			const escapeHtml = (unsafe) => {
				if (!unsafe) return '';
				return String(unsafe)
					.replace(/&/g, '&amp;')
					.replace(/</g, '&lt;')
					.replace(/>/g, '&gt;')
					.replace(/"/g, '&quot;')
					.replace(/'/g, '&#039;');
			};

			// --- MODIFIED: Uses new CSS classes ---
			const renderReportItem = ( reportId, report ) =>
			{
				const reportTypeName = report.reportType || report[ 'report-type' ] || 'unknown_report';
				const STATUS_RESOLVED_TEXT = 'Resolved'; // Variable for status text

				const isProblem = reportTypeName.includes( 'problem' );
				const isResolved = report.status === 'cleared';
				const statusText = report.status === 'new' ? 'New' : STATUS_RESOLVED_TEXT;

				let reporterInfoHtml = '';
				if (report.reporterName || report.reporterEmail) {
					reporterInfoHtml = `
                <div class="report-reporter-info">
                   <p><strong>Reported by:</strong></p>
                   ${ report.reporterName ? `<p>Name: ${ escapeHtml(report.reporterName) }</p>` : '' }
                   ${ report.reporterEmail ? `<p>Email: ${ escapeHtml(report.reporterEmail) }</p>` : '' }
                </div>
            `;
				}

				// Add Resolve button for unresolved reports
				let resolveButtonHtml = '';
				if (report.status === 'new') {
					resolveButtonHtml = `
						<button class="resolve-report-btn" data-report-id="${ escapeHtml(reportId) }" style="margin-top: 10px; padding: 8px 16px; background-color: var(--t4t-green); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
							Mark as Resolved
						</button>
					`;
				}

				// Apply styling: problem reports stay red, resolved reports get green, new pickups stay white
				let itemClasses = 'report-item';
				if (isResolved) {
					itemClasses += ' is-resolved';
				} else if (isProblem && report.status === 'new') {
					itemClasses += ' is-problem';
				}

				const reportTypeDisplay = escapeHtml(reportTypeName).replace( /_/g, ' ' );
				const reportDesc = escapeHtml(report.description || report.notes || 'No details provided.');

				return `
                <li class="${ itemClasses }">
                    <div class="report-item-header">
                        <span class="report-title">${ reportTypeDisplay }</span>
                        <span class="report-status ${ report.status === 'new' ? 'is-new' : 'is-cleared' }">${ statusText }</span>
                    </div>
                    <p class="report-description">
                        ${ reportDesc }
                    </p>
                    <p class="report-timestamp">
                       Report Time: ${ formatDate( report.timestamp ) }
                    </p>
                    ${reporterInfoHtml}
                    ${resolveButtonHtml}
                </li>
            `;
			};

			// --- 5. MAIN APP LOGIC ---
			window.initApp = async() =>
			{
				const listDiv = document.getElementById( 'location-display' );
				const loadingMessage = document.getElementById( 'loading-message' );
				const historyContainer = document.getElementById( 'history-container' );
				const historyLoading = document.getElementById( 'history-loading' );

				const params = new URLSearchParams( window.location.search );
				const boxId = params.get( 'id' );

				if( !boxId )
				{
					loadingMessage.style.color = 'var(--t4t-red)';
					loadingMessage.style.fontWeight = '700';
					loadingMessage.textContent = 'Error: Box ID missing from the link.';
					return;
				}

				// Check if user is authenticated and authorized
				const user = auth.currentUser;
				if (!user || user.isAnonymous) {
					// Not authenticated or anonymous - redirect to box page
					window.location.href = `/box/?id=${ boxId }`;
					return;
				}

				// Check authorization
				try {
					const isAuthorizedVolunteer = httpsCallable(functions, 'isAuthorizedVolunteerV2');
					const result = await isAuthorizedVolunteer();

					if (!result.data.isAuthorized) {
						// Authenticated but not authorized - redirect to box page
						window.location.href = `/box/?id=${ boxId }`;
						return;
					}
				} catch (error) {
					console.error('Authorization check failed:', error);
					// On error, redirect to box page to be safe
					window.location.href = `/box/?id=${ boxId }`;
					return;
				}

				// Use imported 'db' and 'reportsCollectionPath'
				const reportsRef = collection( db, reportsCollectionPath );

				try
				{
					// --- Task 1: Get Box Info ---
					// Use imported 'db' and 'locationsCollectionPath'
					const locRef = doc( db, locationsCollectionPath, boxId );
					const locSnap = await getDoc( locRef );

					if( locSnap.exists() )
					{
						const location = locSnap.data();
						loadingMessage.remove();

						// Logic to strip volunteer email
						let volunteerDisplayName = 'N/A';
						if (location.volunteer) {
							volunteerDisplayName = location.volunteer;
							const atIndex = volunteerDisplayName.indexOf('@');
							if (atIndex !== -1) {
								volunteerDisplayName = volunteerDisplayName.substring(0, atIndex);
							}
						}

						// --- MODIFIED: Uses new CSS ---
						listDiv.innerHTML = `
                        <div class="bg-tots-light">
                            <h2>${ escapeHtml(location.label) }</h2>
                            <p>${ escapeHtml(location.address) }, ${ escapeHtml(location.city) }, ${ escapeHtml(location.state) }</p>
                            <p class="box-id">Box ID: <span>${ escapeHtml(boxId) }</span></p>
                            <p class="volunteer">Assigned Volunteer: ${ escapeHtml(volunteerDisplayName) }</p>
                            <div class="contact-info">
                                <h3>Location Contact:</h3>
                                <p><strong>Name:</strong> ${ escapeHtml(location.contactName || 'N/A') }</p>
                                <p><strong>Email:</strong> ${ escapeHtml(location.contactEmail || 'N/A') }</p>
                                <p><strong>Phone:</strong> ${ escapeHtml(location.contactPhone || 'N/A') }</p>
                            </div>
                        </div>
                    `;
					}
					else
					{
						loadingMessage.style.color = 'var(--t4t-red)';
						loadingMessage.style.fontWeight = '700';
						loadingMessage.textContent = `Error: Box ID not found. Redirecting to setup page in 2 seconds...`;
						historyLoading.remove();

						setTimeout( () =>
						{
							window.location.href = `/setup/?id=${ boxId }`;
						}, 2000 );
						return;
					}

					// --- Task 2: Get reports ---
					const q = query( reportsRef,
							where( 'boxId', '==', boxId ),
							orderBy( 'timestamp', 'desc' )
					);

					const querySnapshot = await getDocs( q );
					historyLoading.remove();

					if( querySnapshot.empty )
					{
						historyContainer.innerHTML = '<p style="text-align: center; color: #6b7281;">No reports found for this box.</p>';
						return;
					}

					let historyHtml = '';
					querySnapshot.forEach( docSnap =>
					{
						historyHtml += renderReportItem( docSnap.id, docSnap.data() );
					} );
					historyContainer.innerHTML = historyHtml;

				}
				catch( error )
				{
					console.error( 'Error loading data:', error );
					loadingMessage.textContent = `Error: ${ error.message }`;
				}
			};

			// --- 6. EVENT HANDLERS FOR RESOLVE BUTTONS ---
			document.addEventListener('click', async (e) => {
				// Handle individual resolve button
				if (e.target && e.target.classList.contains('resolve-report-btn')) {
					const button = e.target;
					const reportId = button.dataset.reportId;
					button.disabled = true;
					button.textContent = 'Resolving...';

					try {
						const reportRef = doc(db, reportsCollectionPath, reportId);
						const reportSnap = await getDoc(reportRef);
						const reportData = reportSnap.exists() ? reportSnap.data() : null;

						await updateDoc(reportRef, { status: 'cleared' });

						// Track analytics
						if (reportData && auth.currentUser && !auth.currentUser.isAnonymous) {
							const volunteersPath = 'artifacts/toysfortots-eae4d/private/01/data/01/authorizedVolunteers';
							const volunteerRef = doc(db, volunteersPath, auth.currentUser.uid);

							await setDoc(volunteerRef, {
								analytics: { resolvedCount: increment(1) }
							}, { merge: true });

							const actionsPath = `${volunteersPath}/${auth.currentUser.uid}/actions`;
							await addDoc(collection(db, actionsPath), {
								actionType: reportData.reportType === 'pickup_alert' ? 'resolve_pickup' : 'resolve_problem',
								reportId: reportId,
								boxId: reportData.boxId,
								timestamp: serverTimestamp()
							});
						}

						location.reload();
					} catch (err) {
						console.error('Error resolving report:', err);
						alert('Error resolving report. Please try again.');
						button.disabled = false;
						button.textContent = 'Mark as Resolved';
					}
				}

				// Handle resolve all button
				if (e.target && e.target.id === 'resolve-all-btn') {
					const button = e.target;
					if (!confirm('Are you sure you want to resolve ALL open reports for this box?')) {
						return;
					}

					button.disabled = true;
					button.textContent = 'Resolving...';

					try {
						const params = new URLSearchParams(window.location.search);
						const boxId = params.get('id');

						const reportsRef = collection(db, reportsCollectionPath);
						const q = query(reportsRef, where('boxId', '==', boxId), where('status', '==', 'new'));
						const querySnapshot = await getDocs(q);

						const updatePromises = [];
						querySnapshot.forEach((docSnap) => {
							const reportRef = doc(db, reportsCollectionPath, docSnap.id);
							updatePromises.push(updateDoc(reportRef, { status: 'cleared' }));
						});

						await Promise.all(updatePromises);

						// Track analytics for each resolved report
						if (auth.currentUser && !auth.currentUser.isAnonymous) {
							const volunteersPath = 'artifacts/toysfortots-eae4d/private/01/data/01/authorizedVolunteers';
							const volunteerRef = doc(db, volunteersPath, auth.currentUser.uid);

							await setDoc(volunteerRef, {
								analytics: { resolvedCount: increment(querySnapshot.size) }
							}, { merge: true });
						}

						location.reload();
					} catch (err) {
						console.error('Error resolving all reports:', err);
						alert('Error resolving all reports. Please try again.');
						button.disabled = false;
						button.textContent = 'Resolve All';
					}
				}
			});

			// Show/hide Resolve All button based on whether there are unresolved reports
			window.addEventListener('load', () => {
				const observer = new MutationObserver(() => {
					const unresolvedButtons = document.querySelectorAll('.resolve-report-btn');
					const resolveAllBtn = document.getElementById('resolve-all-btn');
					if (resolveAllBtn) {
						resolveAllBtn.style.display = unresolvedButtons.length > 0 ? 'block' : 'none';
					}
				});

				const historyContainer = document.getElementById('history-container');
				if (historyContainer) {
					observer.observe(historyContainer, { childList: true, subtree: true });
				}
			});

			// --- 7. CALL SETUP FUNCTION ---
			setupFirebase();
		</script>

	</head>
	<body class="bg-gray-100">
		<div id="header-placeholder"></div>

		<main class="page-container">
			<div class="status-page-container">
			<div class="status-header">
				<h1>Box Report History</h1>
			</div>

			<main class="status-main-content">
				<section id="location-display" class="mb-6">
					<p id="loading-message">Loading location data...</p>
				</section>

				<section id="history">
					<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
					<h2 style="margin: 0;">Report Log</h2>
					<button id="resolve-all-btn" style="display: none; padding: 10px 20px; background-color: var(--t4t-green); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1rem;">
						Resolve All
					</button>
				</div>
					<p id="history-loading">Loading history...</p>
					<ul id="history-container">
					</ul>
				</section>
			</div>
		</main>

		<div id="footer-placeholder"></div>

		<script src="/js/loader.min.js" defer></script>
	</body>
</html>