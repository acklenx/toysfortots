<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Box History</title>
		<link rel="stylesheet" href="/css/style.css?v=1.0.7">

		<script type="module">
			// --- 1. IMPORTS ---
			import { auth, db, locationsCollectionPath, reportsCollectionPath } from '../js/firebase-init.js';
			import {
				signInAnonymously,
				onAuthStateChanged
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
			import {
				doc,
				getDoc,
				collection,
				getDocs,
				query,
				where,
				orderBy
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
			import { formatDate } from '/js/utils.js';
			// --- 2. CONFIG & TOP-LEVEL VARS ---
			// Config is now imported

			// --- 3. FIREBASE SETUP ---
			const setupFirebase = () =>
			{
				try
				{
					let appInitialized = false;
					onAuthStateChanged( auth, ( user ) =>
					{
						if( user && !appInitialized )
						{
							appInitialized = true;
							window.initApp();
						}
						else if( !user )
						{
							signInAnonymously( auth ).catch( ( err ) =>
							{
								console.error( 'Anonymous sign-in failed:', err );
							} );
						}
					} );
				}
				catch( error )
				{
					console.error( 'Firebase Initialization Error:', error );
				}
			};

			// --- MODIFIED: Uses new CSS classes ---
			const renderReportItem = ( report ) =>
			{
				const reportTypeName = report.reportType || report[ 'report-type' ] || 'unknown_report';
				const STATUS_RESOLVED_TEXT = 'Resolved'; // Variable for status text

				const isProblem = reportTypeName.includes( 'problem' );
				const isResolved = report.status === 'cleared';
				const statusText = report.status === 'new' ? 'New' : STATUS_RESOLVED_TEXT;

				let reporterInfoHtml = '';
				if (report.reporterName || report.reporterEmail) {
					reporterInfoHtml = `
                <div class="report-reporter-info">
                   <p><strong>Reported by:</strong></p>
                   ${ report.reporterName ? `<p>Name: ${ report.reporterName }</p>` : '' }
                   ${ report.reporterEmail ? `<p>Email: ${ report.reporterEmail }</p>` : '' }
                </div>
            `;
				}

				// Apply styling: problem reports stay red, resolved reports get green, new pickups stay white
				let itemClasses = 'report-item';
				if (isResolved) {
					itemClasses += ' is-resolved';
				} else if (isProblem && report.status === 'new') {
					itemClasses += ' is-problem';
				}

				return `
                <li class="${ itemClasses }">
                    <div class="report-item-header">
                        <span class="report-title">${ reportTypeName.replace( /_/g, ' ' ) }</span>
                        <span class="report-status ${ report.status === 'new' ? 'is-new' : 'is-cleared' }">${ statusText }</span>
                    </div>
                    <p class="report-description">
                        ${ report.description || report.notes || 'No details provided.' }
                    </p>
                    <p class="report-timestamp">
                       Report Time: ${ formatDate( report.timestamp ) }
                    </p>
                    ${reporterInfoHtml}
                </li>
            `;
			};

			// --- 5. MAIN APP LOGIC ---
			window.initApp = async() =>
			{
				const listDiv = document.getElementById( 'location-display' );
				const loadingMessage = document.getElementById( 'loading-message' );
				const historyContainer = document.getElementById( 'history-container' );
				const historyLoading = document.getElementById( 'history-loading' );

				const params = new URLSearchParams( window.location.search );
				const boxId = params.get( 'id' );

				if( !boxId )
				{
					loadingMessage.style.color = 'var(--t4t-red)';
					loadingMessage.style.fontWeight = '700';
					loadingMessage.textContent = 'Error: Box ID missing from the link.';
					return;
				}

				// Use imported 'db' and 'reportsCollectionPath'
				const reportsRef = collection( db, reportsCollectionPath );

				try
				{
					// --- Task 1: Get Box Info ---
					// Use imported 'db' and 'locationsCollectionPath'
					const locRef = doc( db, locationsCollectionPath, boxId );
					const locSnap = await getDoc( locRef );

					if( locSnap.exists() )
					{
						const location = locSnap.data();
						loadingMessage.remove();

						// Logic to strip volunteer email
						let volunteerDisplayName = 'N/A';
						if (location.volunteer) {
							volunteerDisplayName = location.volunteer;
							const atIndex = volunteerDisplayName.indexOf('@');
							if (atIndex !== -1) {
								volunteerDisplayName = volunteerDisplayName.substring(0, atIndex);
							}
						}

						// --- MODIFIED: Uses new CSS ---
						listDiv.innerHTML = `
                        <div class="bg-tots-light">
                            <h2>${ location.label }</h2>
                            <p>${ location.address }, ${ location.city }, ${ location.state }</p>
                            <p class="box-id">Box ID: <span>${ boxId }</span></p>
                            <p class="volunteer">Assigned Volunteer: ${ volunteerDisplayName }</p>
                            <div class="contact-info">
                                <h3>Location Contact:</h3>
                                <p><strong>Name:</strong> ${ location.contactName || 'N/A' }</p>
                                <p><strong>Email:</strong> ${ location.contactEmail || 'N/A' }</p>
                                <p><strong>Phone:</strong> ${ location.contactPhone || 'N/A' }</p>
                            </div>
                        </div>
                    `;
					}
					else
					{
						loadingMessage.style.color = 'var(--t4t-red)';
						loadingMessage.style.fontWeight = '700';
						loadingMessage.textContent = `Error: Box ID not found. Redirecting to setup page in 2 seconds...`;
						historyLoading.remove();

						setTimeout( () =>
						{
							window.location.href = `/setup/?id=${ boxId }`;
						}, 2000 );
						return;
					}

					// --- Task 2: Get reports ---
					const q = query( reportsRef,
							where( 'boxId', '==', boxId ),
							orderBy( 'timestamp', 'desc' )
					);

					const querySnapshot = await getDocs( q );
					historyLoading.remove();

					if( querySnapshot.empty )
					{
						historyContainer.innerHTML = '<p style="text-align: center; color: #6b7281;">No reports found for this box.</p>';
						return;
					}

					let historyHtml = '';
					querySnapshot.forEach( docSnap =>
					{
						historyHtml += renderReportItem( docSnap.data() );
					} );
					historyContainer.innerHTML = historyHtml;

				}
				catch( error )
				{
					console.error( 'Error loading data:', error );
					loadingMessage.textContent = `Error: ${ error.message }`;
				}
			};

			// --- 6. CALL SETUP FUNCTION ---
			setupFirebase();
		</script>

	</head>
	<body>
		<div id="header-placeholder"></div>

		<div class="status-page-container">
			<div class="status-header">
				<h1>Box Report History</h1>
			</div>

			<main class="status-main-content">
				<section id="location-display" class="mb-6">
					<p id="loading-message">Loading location data...</p>
				</section>

				<section id="history">
					<h2>Report Log</h2>
					<p id="history-loading">Loading history...</p>
					<ul id="history-container">
					</ul>
				</section>
			</main>
		</div>

		<div id="footer-placeholder"></div>

		<script src="/js/loader.js" defer></script>
	</body>
</html>