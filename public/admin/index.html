<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: https: blob:; font-src 'self' data: https://unpkg.com; connect-src 'self' http://localhost:* ws://localhost:* https://*.gstatic.com https://unpkg.com https://*.googleapis.com https://*.cloudfunctions.net https://*.firebaseapp.com https://*.firebaseio.com https://*.google.com https://tile.openstreetmap.org wss://*.firebaseio.com; frame-src 'self' https://*.google.com; object-src 'none'; base-uri 'self'; form-action 'self'">
	<meta name="description" content="Admin panel for managing Toys for Tots donation boxes, locations, and volunteers. Run by the Marine Corps Reserve and coordinated locally by Marine Corps League Detachment 1311.">
	<title>Admin Panel - Toys for Tots</title>
	<link rel="stylesheet" href="/css/style.min.css?v=1.0.20">
	<style>
		.admin-container {
			max-width: 1400px;
			margin: 20px auto;
			padding: 0 20px;
		}

		.admin-header {
			background: white;
			padding: 20px;
			border-radius: 8px;
			margin-bottom: 30px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		.admin-header h1 {
			color: var(--marine-blue);
			margin: 0 0 10px 0;
		}

		.admin-header p {
			color: var(--text-secondary);
			margin: 0;
		}

		.admin-section {
			background: white;
			padding: 20px;
			border-radius: 8px;
			margin-bottom: 20px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		.section-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
			padding-bottom: 15px;
			border-bottom: 2px solid var(--t4t-red);
		}

		.section-header h2 {
			color: var(--marine-blue);
			margin: 0;
		}

		.danger-btn {
			background-color: var(--t4t-red);
			color: white;
			padding: 8px 16px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-weight: 600;
		}

		.danger-btn:hover {
			background-color: var(--t4t-red-hover);
		}

		.primary-btn {
			background-color: var(--marine-blue);
			color: white;
			padding: 8px 16px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-weight: 600;
		}

		.primary-btn:hover {
			background-color: #001a3d;
		}

		.secondary-btn {
			background-color: var(--gray-500);
			color: white;
			padding: 8px 16px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-weight: 600;
		}

		.secondary-btn:hover {
			background-color: var(--gray-600);
		}

		.data-table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 15px;
		}

		.data-table th {
			background-color: var(--gray-100);
			color: var(--marine-blue);
			padding: 12px;
			text-align: left;
			font-weight: 600;
			border-bottom: 2px solid var(--t4t-red);
		}

		.data-table td {
			padding: 12px;
			border-bottom: 1px solid var(--gray-200);
		}

		.data-table tr:hover {
			background-color: var(--gray-50);
		}

		.action-buttons {
			display: flex;
			gap: 8px;
		}

		.action-buttons button {
			padding: 6px 12px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 0.9rem;
		}

		.edit-btn {
			background-color: var(--marine-blue);
			color: white;
		}

		.edit-btn:hover {
			background-color: #001a3d;
		}

		.delete-btn {
			background-color: var(--t4t-red);
			color: white;
		}

		.delete-btn:hover {
			background-color: var(--t4t-red-hover);
		}

		.modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.5);
			z-index: 1000;
			align-items: center;
			justify-content: center;
		}

		.modal.active {
			display: flex;
		}

		.modal-content {
			background: white;
			padding: 30px;
			border-radius: 8px;
			max-width: 500px;
			width: 90%;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}

		.modal-content h3 {
			color: var(--marine-blue);
			margin-top: 0;
		}

		.modal-content p {
			color: var(--text-secondary);
			margin: 15px 0;
		}

		.modal-buttons {
			display: flex;
			gap: 10px;
			justify-content: flex-end;
			margin-top: 20px;
		}

		.edit-form {
			display: none;
			margin-top: 15px;
			padding: 20px;
			background-color: var(--gray-50);
			border-radius: 8px;
		}

		.edit-form.active {
			display: block;
		}

		.form-group {
			margin-bottom: 15px;
		}

		.form-group label {
			display: block;
			color: var(--marine-blue);
			font-weight: 600;
			margin-bottom: 5px;
		}

		.form-group input,
		.form-group select {
			width: 100%;
			padding: 10px;
			border: 1px solid var(--gray-300);
			border-radius: 4px;
			font-size: 1rem;
		}

		.form-buttons {
			display: flex;
			gap: 10px;
			margin-top: 20px;
		}

		.loading {
			text-align: center;
			padding: 20px;
			color: var(--text-secondary);
		}

		.error-message {
			background-color: var(--t4t-red-light);
			color: var(--t4t-red);
			padding: 15px;
			border-radius: 4px;
			margin-bottom: 15px;
		}

		.success-message {
			background-color: #f0fdf4;
			color: var(--t4t-green-dark);
			padding: 15px;
			border-radius: 4px;
			margin-bottom: 15px;
		}

		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
			margin-bottom: 20px;
		}

		.stat-card {
			background-color: var(--gray-50);
			padding: 15px;
			border-radius: 8px;
			text-align: center;
		}

		.stat-card .stat-value {
			font-size: 2rem;
			font-weight: bold;
			color: var(--marine-blue);
		}

		.stat-card .stat-label {
			color: var(--text-secondary);
			font-size: 0.9rem;
			margin-top: 5px;
		}

		.section-controls {
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 15px;
			margin-bottom: 15px;
			flex-wrap: wrap;
		}

		.search-box {
			flex: 0 1 400px;
			min-width: 250px;
		}

		.search-box input {
			width: 100%;
			padding: 10px 15px;
			border: 1px solid var(--gray-300);
			border-radius: 4px;
			font-size: 1rem;
		}

		.search-box input:focus {
			outline: none;
			border-color: var(--marine-blue);
		}

		.control-buttons {
			display: flex;
			gap: 10px;
		}

		.export-btn {
			background-color: var(--t4t-green);
			color: white;
			padding: 8px 16px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-weight: 600;
		}

		.export-btn:hover {
			background-color: var(--t4t-green-dark);
		}

		.data-table th {
			cursor: pointer;
			user-select: none;
			position: relative;
		}

		.data-table th:hover {
			background-color: var(--gray-200);
		}

		.data-table th.sortable::after {
			content: ' ⇅';
			font-size: 0.8em;
			color: var(--gray-400);
		}

		.data-table th.sorted-asc::after {
			content: ' ↑';
			color: var(--marine-blue);
		}

		.data-table th.sorted-desc::after {
			content: ' ↓';
			color: var(--marine-blue);
		}

		.pagination {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 10px;
			margin-top: 20px;
		}

		.pagination button {
			padding: 8px 12px;
			border: 1px solid var(--gray-300);
			background-color: white;
			border-radius: 4px;
			cursor: pointer;
		}

		.pagination button:hover:not(:disabled) {
			background-color: var(--gray-100);
		}

		.pagination button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.pagination .page-info {
			color: var(--text-secondary);
			font-size: 0.9rem;
		}

		@media (max-width: 768px) {
			.data-table {
				font-size: 0.9rem;
			}

			.data-table th,
			.data-table td {
				padding: 8px;
			}

			.action-buttons {
				flex-direction: column;
			}

			.section-header {
				flex-direction: column;
				align-items: flex-start;
				gap: 10px;
			}
		}
	</style>
</head>
<body class="bg-gray-100">
	<div id="header-placeholder"></div>

	<main class="admin-container">
		<div class="admin-header">
			<div style="display: flex; justify-content: space-between; align-items: center;">
				<div>
					<h1>Admin Panel</h1>
					<p>Manage donation boxes, locations, and volunteers</p>
				</div>
				<button id="refresh-cache-btn" class="primary-btn">
					Refresh Map Cache
				</button>
			</div>
			<div id="cache-refresh-result" style="margin-top: 15px; display: none;"></div>
		</div>

		<div id="auth-check" class="loading">
			Checking authorization...
		</div>

		<div id="admin-content" style="display: none;">
			<!-- Statistics -->
			<div class="stats-grid">
				<div class="stat-card">
					<div class="stat-value" id="stat-boxes">0</div>
					<div class="stat-label">Total Boxes</div>
				</div>
				<div class="stat-card">
					<div class="stat-value" id="stat-reports">0</div>
					<div class="stat-label">Total Reports</div>
				</div>
				<div class="stat-card">
					<div class="stat-value" id="stat-volunteers">0</div>
					<div class="stat-label">Authorized Volunteers</div>
				</div>
			</div>

			<!-- Box Management -->
			<div class="admin-section">
				<div class="section-header">
					<h2>Box Management</h2>
					<button class="danger-btn" id="delete-all-boxes-btn">Delete All Boxes</button>
				</div>
				<div class="section-controls">
					<div class="search-box">
						<input type="text" id="boxes-search" placeholder="Search boxes by ID, location, address, city, or volunteer...">
					</div>
					<div class="control-buttons">
						<button class="export-btn" id="export-boxes-btn">Export CSV</button>
					</div>
				</div>
				<div id="boxes-loading" class="loading">Loading boxes...</div>
				<div id="boxes-error" class="error-message" style="display: none;"></div>
				<div id="boxes-container"></div>
				<div id="boxes-pagination" class="pagination" style="display: none;"></div>
			</div>

			<!-- Report Management -->
			<div class="admin-section">
				<div class="section-header">
					<h2>Report Management</h2>
					<button class="danger-btn" id="delete-all-reports-btn">Delete All Reports</button>
				</div>
				<div class="section-controls">
					<div class="search-box">
						<input type="text" id="reports-search" placeholder="Search reports by ID, box ID, type, or status...">
					</div>
					<div class="control-buttons">
						<button class="export-btn" id="export-reports-btn">Export CSV</button>
					</div>
				</div>
				<div id="reports-loading" class="loading">Loading reports...</div>
				<div id="reports-error" class="error-message" style="display: none;"></div>
				<div id="reports-container"></div>
				<div id="reports-pagination" class="pagination" style="display: none;"></div>
			</div>

			<!-- Volunteer Management -->
			<div class="admin-section">
				<div class="section-header">
					<h2>Volunteer Management</h2>
					<button class="danger-btn" id="delete-all-volunteers-btn">Delete All Volunteers</button>
				</div>
				<div class="section-controls">
					<div class="search-box">
						<input type="text" id="volunteers-search" placeholder="Search volunteers by ID, name, or email...">
					</div>
					<div class="control-buttons">
						<button class="export-btn" id="export-volunteers-btn">Export CSV</button>
					</div>
				</div>
				<div id="volunteers-loading" class="loading">Loading volunteers...</div>
				<div id="volunteers-error" class="error-message" style="display: none;"></div>
				<div id="volunteers-container"></div>
				<div id="volunteers-pagination" class="pagination" style="display: none;"></div>
			</div>
		</div>
	</main>

	<!-- Confirmation Modal -->
	<div id="confirmation-modal" class="modal">
		<div class="modal-content">
			<h3 id="modal-title">Confirm Action</h3>
			<p id="modal-message">Are you sure you want to proceed?</p>
			<div class="modal-buttons">
				<button class="secondary-btn" id="modal-cancel">Cancel</button>
				<button class="danger-btn" id="modal-confirm">Confirm</button>
			</div>
		</div>
	</div>

	<!-- Edit Box Modal -->
	<div id="edit-box-modal" class="modal">
		<div class="modal-content">
			<h3>Edit Box</h3>
			<form id="edit-box-form">
				<div class="form-group">
					<label for="edit-box-label">Location Name</label>
					<input type="text" id="edit-box-label" required>
				</div>
				<div class="form-group">
					<label for="edit-box-address">Address</label>
					<input type="text" id="edit-box-address" required>
				</div>
				<div class="form-group">
					<label for="edit-box-city">City</label>
					<input type="text" id="edit-box-city" required>
				</div>
				<div class="form-group">
					<label for="edit-box-state">State</label>
					<input type="text" id="edit-box-state" value="GA" required>
				</div>
				<div class="form-group">
					<label for="edit-box-contact-name">Contact Name</label>
					<input type="text" id="edit-box-contact-name">
				</div>
				<div class="form-group">
					<label for="edit-box-contact-phone">Contact Phone</label>
					<input type="tel" id="edit-box-contact-phone">
				</div>
				<div class="form-group">
					<label for="edit-box-contact-email">Contact Email</label>
					<input type="email" id="edit-box-contact-email">
				</div>
				<div class="form-group">
					<label>GPS Coordinates</label>
					<div id="edit-box-gps" style="display: flex; gap: 10px; align-items: center;">
						<span id="edit-box-coordinates" style="font-family: monospace; color: #666;"></span>
						<a id="edit-box-map-link" href="#" target="_blank" rel="noopener noreferrer" style="display: none; color: var(--t4t-red); text-decoration: none; font-weight: 500;">View on Map →</a>
					</div>
				</div>
				<div class="form-buttons">
					<button type="button" class="secondary-btn" id="edit-box-cancel">Cancel</button>
					<button type="submit" class="primary-btn">Save Changes</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Edit Volunteer Modal -->
	<div id="edit-volunteer-modal" class="modal">
		<div class="modal-content">
			<h3>Edit Volunteer</h3>
			<form id="edit-volunteer-form">
				<div class="form-group">
					<label for="edit-volunteer-name">Display Name</label>
					<input type="text" id="edit-volunteer-name" required>
				</div>
				<div class="form-group">
					<label for="edit-volunteer-email">Email</label>
					<input type="email" id="edit-volunteer-email" disabled>
				</div>
				<div class="form-buttons">
					<button type="button" class="secondary-btn" id="edit-volunteer-cancel">Cancel</button>
					<button type="submit" class="primary-btn">Save Changes</button>
				</div>
			</form>
		</div>
	</div>

	<div id="footer-placeholder"></div>
	<script src="/js/loader.min.js" defer></script>
	<script type="module">
		import { db, auth, functions, locationsCollectionPath, reportsCollectionPath } from '/js/firebase-init.js';
		import {
			collection,
			getDocs,
			doc,
			updateDoc,
			deleteDoc,
			query,
			orderBy
		} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
		import {
			onAuthStateChanged
		} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
		import {
			httpsCallable
		} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js';

		let currentUser = null;
		let currentEditBoxId = null;
		let currentEditVolunteerId = null;
		let confirmCallback = null;

		// Data storage for filtering/sorting/pagination
		let allBoxes = [];
		let filteredBoxes = [];
		let allReports = [];
		let filteredReports = [];
		let allVolunteers = [];
		let filteredVolunteers = [];

		// Pagination settings
		const PAGE_SIZE = 20;
		let currentBoxesPage = 1;
		let currentReportsPage = 1;
		let currentVolunteersPage = 1;

		// Sorting state
		let boxesSortColumn = null;
		let boxesSortDirection = 'asc';
		let reportsSortColumn = null;
		let reportsSortDirection = 'asc';
		let volunteersSortColumn = null;
		let volunteersSortDirection = 'asc';

		// Authorization check
		onAuthStateChanged(auth, async (user) => {
			if (!user || user.isAnonymous) {
				window.location.href = '/login';
				return;
			}

			currentUser = user;

			// Check if authorized
			try {
				const isAuthorized = httpsCallable(functions, 'isAuthorizedVolunteerV2');
				const result = await isAuthorized();

				if (!result.data.isAuthorized) {
					document.getElementById('auth-check').innerHTML = '<div class="error-message">You are not authorized to access the admin panel.</div>';
					return;
				}

				document.getElementById('auth-check').style.display = 'none';
				document.getElementById('admin-content').style.display = 'block';

				// Load all data
				loadBoxes();
				loadReports();
				loadVolunteers();
			} catch (error) {
				document.getElementById('auth-check').innerHTML = '<div class="error-message">Error checking authorization: ' + error.message + '</div>';
			}
		});

		// Cache refresh functionality
		document.getElementById('refresh-cache-btn').addEventListener('click', async () => {
			const btn = document.getElementById('refresh-cache-btn');
			const resultDiv = document.getElementById('cache-refresh-result');

			btn.disabled = true;
			btn.textContent = 'Refreshing...';
			resultDiv.style.display = 'none';

			try {
				// Get Firebase ID token for authorization
				const idToken = await window.auth.currentUser.getIdToken();

				const response = await fetch('https://us-central1-toysfortots-eae4d.cloudfunctions.net/triggerRefreshLocationsCache', {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${idToken}`
					}
				});

				const data = await response.json();

				if (data.success) {
					resultDiv.className = 'success-message';
					resultDiv.innerHTML = `
						<strong>✅ Cache Refreshed Successfully</strong><br>
						<div style="margin-top: 8px; font-size: 0.9em;">
							• Boxes cached: ${data.count || 0}<br>
							• Cache URL: <a href="${data.url}" target="_blank" style="color: var(--t4t-green-dark); text-decoration: underline;">${data.url}</a><br>
							• Message: ${data.message || 'Cache regenerated'}
						</div>
					`;
				} else {
					resultDiv.className = 'error-message';
					resultDiv.innerHTML = `<strong>❌ Cache Refresh Failed</strong><br>${data.message || 'Unknown error'}`;
				}
			} catch (error) {
				resultDiv.className = 'error-message';
				resultDiv.innerHTML = `<strong>❌ Request Failed</strong><br>${error.message}`;
			} finally {
				btn.disabled = false;
				btn.textContent = 'Refresh Map Cache';
				resultDiv.style.display = 'block';

				// Auto-hide success message after 10 seconds
				if (resultDiv.className === 'success-message') {
					setTimeout(() => {
						resultDiv.style.display = 'none';
					}, 10000);
				}
			}
		});

		// Load boxes
		async function loadBoxes() {
			try {
				const locationsRef = collection(db, locationsCollectionPath);
				const q = query(locationsRef, orderBy('created', 'desc'));
				const snapshot = await getDocs(q);

				allBoxes = [];
				snapshot.forEach((doc) => {
					allBoxes.push({ id: doc.id, ...doc.data() });
				});

				document.getElementById('stat-boxes').textContent = allBoxes.length;
				document.getElementById('boxes-loading').style.display = 'none';

				// Setup search
				const searchInput = document.getElementById('boxes-search');
				searchInput.addEventListener('input', () => filterAndRenderBoxes());

				// Setup export
				const exportBtn = document.getElementById('export-boxes-btn');
				exportBtn.addEventListener('click', () => exportBoxesToCSV());

				filterAndRenderBoxes();
			} catch (error) {
				document.getElementById('boxes-loading').style.display = 'none';
				document.getElementById('boxes-error').textContent = 'Error loading boxes: ' + error.message;
				document.getElementById('boxes-error').style.display = 'block';
			}
		}

		function filterAndRenderBoxes() {
			const searchTerm = document.getElementById('boxes-search').value.toLowerCase();
			filteredBoxes = allBoxes.filter(box => {
				return (
					box.id.toLowerCase().includes(searchTerm) ||
					(box.label || '').toLowerCase().includes(searchTerm) ||
					(box.address || '').toLowerCase().includes(searchTerm) ||
					(box.city || '').toLowerCase().includes(searchTerm) ||
					(box.volunteerEmail || '').toLowerCase().includes(searchTerm)
				);
			});

			renderBoxes();
		}

		function renderBoxes() {
			const container = document.getElementById('boxes-container');

			if (filteredBoxes.length === 0) {
				container.innerHTML = '<p class="loading">No boxes found.</p>';
				return;
			}

			// Pagination
			const totalPages = Math.ceil(filteredBoxes.length / PAGE_SIZE);
			const startIndex = (currentBoxesPage - 1) * PAGE_SIZE;
			const endIndex = startIndex + PAGE_SIZE;
			const pageData = filteredBoxes.slice(startIndex, endIndex);

			let tableHTML = '<table class="data-table"><thead><tr>';
			tableHTML += '<th class="sortable" data-sort="id" onclick="sortBoxes(\'id\')">Box ID</th>';
			tableHTML += '<th class="sortable" data-sort="label" onclick="sortBoxes(\'label\')">Location</th>';
			tableHTML += '<th class="sortable" data-sort="address" onclick="sortBoxes(\'address\')">Address</th>';
			tableHTML += '<th class="sortable" data-sort="city" onclick="sortBoxes(\'city\')">City</th>';
			tableHTML += '<th class="sortable" data-sort="volunteerEmail" onclick="sortBoxes(\'volunteerEmail\')">Volunteer</th>';
			tableHTML += '<th>Actions</th>';
			tableHTML += '</tr></thead><tbody>';

			pageData.forEach((box) => {
				const escapedLabel = (box.label || 'N/A').replace(/'/g, "\\'").replace(/"/g, '&quot;');
				tableHTML += '<tr>';
				tableHTML += `<td>${box.id}</td>`;
				tableHTML += `<td>${box.label || 'N/A'}</td>`;
				tableHTML += `<td>${box.address || 'N/A'}</td>`;
				tableHTML += `<td>${box.city || 'N/A'}, ${box.state || 'GA'}</td>`;
				tableHTML += `<td>${box.volunteerEmail || 'N/A'}</td>`;
				tableHTML += `<td><div class="action-buttons">`;
				tableHTML += `<button class="edit-btn" data-box-id="${box.id}">Edit</button>`;
				tableHTML += `<button class="delete-btn" data-box-id="${box.id}" data-box-label="${escapedLabel}">Delete</button>`;
				tableHTML += `</div></td>`;
				tableHTML += '</tr>';
			});

			tableHTML += '</tbody></table>';
			container.innerHTML = tableHTML;

			// Add event listeners to buttons
			container.querySelectorAll('.edit-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					window.editBox(btn.dataset.boxId);
				});
			});
			container.querySelectorAll('.delete-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					window.deleteBox(btn.dataset.boxId, btn.dataset.boxLabel);
				});
			});

			// Update sort indicators
			if (boxesSortColumn) {
				const header = container.querySelector(`th[data-sort="${boxesSortColumn}"]`);
				if (header) {
					header.classList.remove('sortable');
					header.classList.add(boxesSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
				}
			}

			// Render pagination
			const paginationContainer = document.getElementById('boxes-pagination');
			if (totalPages > 1) {
				paginationContainer.style.display = 'flex';
				paginationContainer.innerHTML = `
					<button onclick="changeBoxesPage(${currentBoxesPage - 1})" ${currentBoxesPage === 1 ? 'disabled' : ''}>Previous</button>
					<span class="page-info">Page ${currentBoxesPage} of ${totalPages} (${filteredBoxes.length} items)</span>
					<button onclick="changeBoxesPage(${currentBoxesPage + 1})" ${currentBoxesPage === totalPages ? 'disabled' : ''}>Next</button>
				`;
			} else {
				paginationContainer.style.display = 'none';
			}
		}

		window.sortBoxes = function(column) {
			if (boxesSortColumn === column) {
				boxesSortDirection = boxesSortDirection === 'asc' ? 'desc' : 'asc';
			} else {
				boxesSortColumn = column;
				boxesSortDirection = 'asc';
			}

			filteredBoxes.sort((a, b) => {
				const aVal = a[column] || '';
				const bVal = b[column] || '';
				if (aVal < bVal) return boxesSortDirection === 'asc' ? -1 : 1;
				if (aVal > bVal) return boxesSortDirection === 'asc' ? 1 : -1;
				return 0;
			});

			renderBoxes();
		};

		window.changeBoxesPage = function(page) {
			const totalPages = Math.ceil(filteredBoxes.length / PAGE_SIZE);
			if (page >= 1 && page <= totalPages) {
				currentBoxesPage = page;
				renderBoxes();
			}
		};

		function exportBoxesToCSV() {
			const headers = ['Box ID', 'Location', 'Address', 'City', 'State', 'Volunteer Email', 'Created'];
			const rows = filteredBoxes.map(box => [
				box.id,
				box.label || '',
				box.address || '',
				box.city || '',
				box.state || '',
				box.volunteerEmail || '',
				box.created ? new Date(box.created.seconds * 1000).toLocaleString() : ''
			]);

			let csvContent = headers.join(',') + '\n';
			rows.forEach(row => {
				csvContent += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
			});

			const blob = new Blob([csvContent], { type: 'text/csv' });
			const url = URL.createObjectURL(blob);
			const link = document.createElement('a');
			link.href = url;
			link.download = `boxes_${new Date().toISOString().split('T')[0]}.csv`;
			link.click();
			URL.revokeObjectURL(url);
		}

		// Load reports
		async function loadReports() {
			try {
				const reportsRef = collection(db, reportsCollectionPath);
				const q = query(reportsRef, orderBy('timestamp', 'desc'));
				const snapshot = await getDocs(q);

				allReports = [];
				snapshot.forEach((doc) => {
					allReports.push({ id: doc.id, ...doc.data() });
				});

				document.getElementById('stat-reports').textContent = allReports.length;
				document.getElementById('reports-loading').style.display = 'none';

				// Setup search
				const searchInput = document.getElementById('reports-search');
				searchInput.addEventListener('input', () => filterAndRenderReports());

				// Setup export
				const exportBtn = document.getElementById('export-reports-btn');
				exportBtn.addEventListener('click', () => exportReportsToCSV());

				filterAndRenderReports();
			} catch (error) {
				document.getElementById('reports-loading').style.display = 'none';
				document.getElementById('reports-error').textContent = 'Error loading reports: ' + error.message;
				document.getElementById('reports-error').style.display = 'block';
			}
		}

		function filterAndRenderReports() {
			const searchTerm = document.getElementById('reports-search').value.toLowerCase();
			filteredReports = allReports.filter(report => {
				return (
					report.id.toLowerCase().includes(searchTerm) ||
					(report.boxId || '').toLowerCase().includes(searchTerm) ||
					(report.reportType || '').toLowerCase().includes(searchTerm) ||
					(report.status || '').toLowerCase().includes(searchTerm)
				);
			});

			renderReports();
		}

		function renderReports() {
			const container = document.getElementById('reports-container');

			if (filteredReports.length === 0) {
				container.innerHTML = '<p class="loading">No reports found.</p>';
				return;
			}

			// Pagination
			const totalPages = Math.ceil(filteredReports.length / PAGE_SIZE);
			const startIndex = (currentReportsPage - 1) * PAGE_SIZE;
			const endIndex = startIndex + PAGE_SIZE;
			const pageData = filteredReports.slice(startIndex, endIndex);

			let tableHTML = '<table class="data-table"><thead><tr>';
			tableHTML += '<th class="sortable" data-sort="id" onclick="sortReports(\'id\')">Report ID</th>';
			tableHTML += '<th class="sortable" data-sort="boxId" onclick="sortReports(\'boxId\')">Box ID</th>';
			tableHTML += '<th class="sortable" data-sort="reportType" onclick="sortReports(\'reportType\')">Type</th>';
			tableHTML += '<th class="sortable" data-sort="status" onclick="sortReports(\'status\')">Status</th>';
			tableHTML += '<th class="sortable" data-sort="timestamp" onclick="sortReports(\'timestamp\')">Date</th>';
			tableHTML += '<th>Actions</th>';
			tableHTML += '</tr></thead><tbody>';

			pageData.forEach((report) => {
				const date = report.timestamp ? new Date(report.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
				tableHTML += '<tr>';
				tableHTML += `<td>${report.id}</td>`;
				tableHTML += `<td>${report.boxId || 'N/A'}</td>`;
				tableHTML += `<td>${report.reportType || 'N/A'}</td>`;
				tableHTML += `<td>${report.status || 'N/A'}</td>`;
				tableHTML += `<td>${date}</td>`;
				tableHTML += `<td><div class="action-buttons">`;
				tableHTML += `<button class="delete-btn" data-report-id="${report.id}">Delete</button>`;
				tableHTML += `</div></td>`;
				tableHTML += '</tr>';
			});

			tableHTML += '</tbody></table>';
			container.innerHTML = tableHTML;

			// Add event listeners to buttons
			container.querySelectorAll('.delete-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					window.deleteReport(btn.dataset.reportId);
				});
			});

			// Update sort indicators
			if (reportsSortColumn) {
				const header = container.querySelector(`th[data-sort="${reportsSortColumn}"]`);
				if (header) {
					header.classList.remove('sortable');
					header.classList.add(reportsSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
				}
			}

			// Render pagination
			const paginationContainer = document.getElementById('reports-pagination');
			if (totalPages > 1) {
				paginationContainer.style.display = 'flex';
				paginationContainer.innerHTML = `
					<button onclick="changeReportsPage(${currentReportsPage - 1})" ${currentReportsPage === 1 ? 'disabled' : ''}>Previous</button>
					<span class="page-info">Page ${currentReportsPage} of ${totalPages} (${filteredReports.length} items)</span>
					<button onclick="changeReportsPage(${currentReportsPage + 1})" ${currentReportsPage === totalPages ? 'disabled' : ''}>Next</button>
				`;
			} else {
				paginationContainer.style.display = 'none';
			}
		}

		window.sortReports = function(column) {
			if (reportsSortColumn === column) {
				reportsSortDirection = reportsSortDirection === 'asc' ? 'desc' : 'asc';
			} else {
				reportsSortColumn = column;
				reportsSortDirection = 'asc';
			}

			filteredReports.sort((a, b) => {
				let aVal = a[column] || '';
				let bVal = b[column] || '';

				// Handle timestamp sorting
				if (column === 'timestamp') {
					aVal = a[column] ? a[column].seconds : 0;
					bVal = b[column] ? b[column].seconds : 0;
				}

				if (aVal < bVal) return reportsSortDirection === 'asc' ? -1 : 1;
				if (aVal > bVal) return reportsSortDirection === 'asc' ? 1 : -1;
				return 0;
			});

			renderReports();
		};

		window.changeReportsPage = function(page) {
			const totalPages = Math.ceil(filteredReports.length / PAGE_SIZE);
			if (page >= 1 && page <= totalPages) {
				currentReportsPage = page;
				renderReports();
			}
		};

		function exportReportsToCSV() {
			const headers = ['Report ID', 'Box ID', 'Type', 'Status', 'Date', 'Details'];
			const rows = filteredReports.map(report => [
				report.id,
				report.boxId || '',
				report.reportType || '',
				report.status || '',
				report.timestamp ? new Date(report.timestamp.seconds * 1000).toLocaleString() : '',
				report.details || ''
			]);

			let csvContent = headers.join(',') + '\n';
			rows.forEach(row => {
				csvContent += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
			});

			const blob = new Blob([csvContent], { type: 'text/csv' });
			const url = URL.createObjectURL(blob);
			const link = document.createElement('a');
			link.href = url;
			link.download = `reports_${new Date().toISOString().split('T')[0]}.csv`;
			link.click();
			URL.revokeObjectURL(url);
		}

		// Load volunteers
		async function loadVolunteers() {
			try {
				const volunteersPath = 'artifacts/toysfortots-eae4d/private/01/data/01/authorizedVolunteers';
				const volunteersRef = collection(db, volunteersPath);
				const snapshot = await getDocs(volunteersRef);

				allVolunteers = [];
				snapshot.forEach((doc) => {
					allVolunteers.push({ id: doc.id, ...doc.data() });
				});

				document.getElementById('stat-volunteers').textContent = allVolunteers.length;
				document.getElementById('volunteers-loading').style.display = 'none';

				// Setup search
				const searchInput = document.getElementById('volunteers-search');
				searchInput.addEventListener('input', () => filterAndRenderVolunteers());

				// Setup export
				const exportBtn = document.getElementById('export-volunteers-btn');
				exportBtn.addEventListener('click', () => exportVolunteersToCSV());

				filterAndRenderVolunteers();
			} catch (error) {
				document.getElementById('volunteers-loading').style.display = 'none';
				document.getElementById('volunteers-error').textContent = 'Error loading volunteers: ' + error.message;
				document.getElementById('volunteers-error').style.display = 'block';
			}
		}

		function filterAndRenderVolunteers() {
			const searchTerm = document.getElementById('volunteers-search').value.toLowerCase();
			filteredVolunteers = allVolunteers.filter(volunteer => {
				return (
					volunteer.id.toLowerCase().includes(searchTerm) ||
					(volunteer.displayName || '').toLowerCase().includes(searchTerm) ||
					(volunteer.email || '').toLowerCase().includes(searchTerm)
				);
			});

			renderVolunteers();
		}

		function renderVolunteers() {
			const container = document.getElementById('volunteers-container');

			if (filteredVolunteers.length === 0) {
				container.innerHTML = '<p class="loading">No volunteers found.</p>';
				return;
			}

			// Pagination
			const totalPages = Math.ceil(filteredVolunteers.length / PAGE_SIZE);
			const startIndex = (currentVolunteersPage - 1) * PAGE_SIZE;
			const endIndex = startIndex + PAGE_SIZE;
			const pageData = filteredVolunteers.slice(startIndex, endIndex);

			let tableHTML = '<table class="data-table"><thead><tr>';
			tableHTML += '<th class="sortable" data-sort="id" onclick="sortVolunteers(\'id\')">User ID</th>';
			tableHTML += '<th class="sortable" data-sort="displayName" onclick="sortVolunteers(\'displayName\')">Display Name</th>';
			tableHTML += '<th class="sortable" data-sort="email" onclick="sortVolunteers(\'email\')">Email</th>';
			tableHTML += '<th>Actions</th>';
			tableHTML += '</tr></thead><tbody>';

			pageData.forEach((volunteer) => {
				const isCurrentUser = volunteer.id === currentUser.uid;
				const escapedDisplayName = (volunteer.displayName || volunteer.email || 'N/A').replace(/'/g, "\\'").replace(/"/g, '&quot;');
				tableHTML += '<tr>';
				tableHTML += `<td>${volunteer.id}</td>`;
				tableHTML += `<td>${volunteer.displayName || 'N/A'}</td>`;
				tableHTML += `<td>${volunteer.email || 'N/A'}</td>`;
				tableHTML += `<td><div class="action-buttons">`;
				tableHTML += `<button class="edit-btn" data-volunteer-id="${volunteer.id}" ${isCurrentUser ? 'disabled' : ''}>Edit</button>`;
				tableHTML += `<button class="delete-btn" data-volunteer-id="${volunteer.id}" data-volunteer-name="${escapedDisplayName}" ${isCurrentUser ? 'disabled' : ''}>Delete</button>`;
				tableHTML += `</div></td>`;
				tableHTML += '</tr>';
			});

			tableHTML += '</tbody></table>';
			container.innerHTML = tableHTML;

			// Add event listeners to buttons
			container.querySelectorAll('.edit-btn').forEach(btn => {
				if (!btn.disabled) {
					btn.addEventListener('click', () => {
						window.editVolunteer(btn.dataset.volunteerId);
					});
				}
			});
			container.querySelectorAll('.delete-btn').forEach(btn => {
				if (!btn.disabled) {
					btn.addEventListener('click', () => {
						window.deleteVolunteer(btn.dataset.volunteerId, btn.dataset.volunteerName);
					});
				}
			});

			// Update sort indicators
			if (volunteersSortColumn) {
				const header = container.querySelector(`th[data-sort="${volunteersSortColumn}"]`);
				if (header) {
					header.classList.remove('sortable');
					header.classList.add(volunteersSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
				}
			}

			// Render pagination
			const paginationContainer = document.getElementById('volunteers-pagination');
			if (totalPages > 1) {
				paginationContainer.style.display = 'flex';
				paginationContainer.innerHTML = `
					<button onclick="changeVolunteersPage(${currentVolunteersPage - 1})" ${currentVolunteersPage === 1 ? 'disabled' : ''}>Previous</button>
					<span class="page-info">Page ${currentVolunteersPage} of ${totalPages} (${filteredVolunteers.length} items)</span>
					<button onclick="changeVolunteersPage(${currentVolunteersPage + 1})" ${currentVolunteersPage === totalPages ? 'disabled' : ''}>Next</button>
				`;
			} else {
				paginationContainer.style.display = 'none';
			}
		}

		window.sortVolunteers = function(column) {
			if (volunteersSortColumn === column) {
				volunteersSortDirection = volunteersSortDirection === 'asc' ? 'desc' : 'asc';
			} else {
				volunteersSortColumn = column;
				volunteersSortDirection = 'asc';
			}

			filteredVolunteers.sort((a, b) => {
				const aVal = a[column] || '';
				const bVal = b[column] || '';
				if (aVal < bVal) return volunteersSortDirection === 'asc' ? -1 : 1;
				if (aVal > bVal) return volunteersSortDirection === 'asc' ? 1 : -1;
				return 0;
			});

			renderVolunteers();
		};

		window.changeVolunteersPage = function(page) {
			const totalPages = Math.ceil(filteredVolunteers.length / PAGE_SIZE);
			if (page >= 1 && page <= totalPages) {
				currentVolunteersPage = page;
				renderVolunteers();
			}
		};

		function exportVolunteersToCSV() {
			const headers = ['User ID', 'Display Name', 'Email'];
			const rows = filteredVolunteers.map(volunteer => [
				volunteer.id,
				volunteer.displayName || '',
				volunteer.email || ''
			]);

			let csvContent = headers.join(',') + '\n';
			rows.forEach(row => {
				csvContent += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
			});

			const blob = new Blob([csvContent], { type: 'text/csv' });
			const url = URL.createObjectURL(blob);
			const link = document.createElement('a');
			link.href = url;
			link.download = `volunteers_${new Date().toISOString().split('T')[0]}.csv`;
			link.click();
			URL.revokeObjectURL(url);
		}

		// Edit box
		window.editBox = async function(boxId) {
			currentEditBoxId = boxId;
			const docRef = doc(db, locationsCollectionPath, boxId);
			const docSnap = await getDocs(query(collection(db, locationsCollectionPath)));

			let boxData = null;
			docSnap.forEach((d) => {
				if (d.id === boxId) {
					boxData = d.data();
				}
			});

			if (!boxData) return;

			document.getElementById('edit-box-label').value = boxData.label || '';
			document.getElementById('edit-box-address').value = boxData.address || '';
			document.getElementById('edit-box-city').value = boxData.city || '';
			document.getElementById('edit-box-state').value = boxData.state || 'GA';
			document.getElementById('edit-box-contact-name').value = boxData.contactName || '';
			document.getElementById('edit-box-contact-phone').value = boxData.contactPhone || '';
			document.getElementById('edit-box-contact-email').value = boxData.contactEmail || '';

			// Display GPS coordinates and map link
			const coordinatesSpan = document.getElementById('edit-box-coordinates');
			const mapLink = document.getElementById('edit-box-map-link');

			if (boxData.lat && boxData.lon) {
				const lat = boxData.lat.toFixed(6);
				const lon = boxData.lon.toFixed(6);
				coordinatesSpan.textContent = `${lat}, ${lon}`;

				// Google Maps link
				mapLink.href = `https://www.google.com/maps?q=${lat},${lon}`;
				mapLink.style.display = 'inline';
			} else {
				coordinatesSpan.textContent = 'Not available';
				mapLink.style.display = 'none';
			}

			document.getElementById('edit-box-modal').classList.add('active');
		};

		// Save box changes
		document.getElementById('edit-box-form').addEventListener('submit', async (e) => {
			e.preventDefault();

			try {
				const docRef = doc(db, locationsCollectionPath, currentEditBoxId);
				await updateDoc(docRef, {
					label: document.getElementById('edit-box-label').value,
					address: document.getElementById('edit-box-address').value,
					city: document.getElementById('edit-box-city').value,
					state: document.getElementById('edit-box-state').value,
					contactName: document.getElementById('edit-box-contact-name').value,
					contactPhone: document.getElementById('edit-box-contact-phone').value,
					contactEmail: document.getElementById('edit-box-contact-email').value
				});

				document.getElementById('edit-box-modal').classList.remove('active');
				loadBoxes();
			} catch (error) {
				alert('Error updating box: ' + error.message);
			}
		});

		document.getElementById('edit-box-cancel').addEventListener('click', () => {
			document.getElementById('edit-box-modal').classList.remove('active');
		});

		// Delete box
		window.deleteBox = function(boxId, label) {
			showConfirmation(
				'Delete Box',
				`Are you sure you want to delete "${label}"? This action cannot be undone.`,
				async () => {
					try {
						const docRef = doc(db, locationsCollectionPath, boxId);
						await deleteDoc(docRef);
						loadBoxes();
					} catch (error) {
						alert('Error deleting box: ' + error.message);
					}
				}
			);
		};

		// Delete all boxes
		document.getElementById('delete-all-boxes-btn').addEventListener('click', () => {
			showConfirmation(
				'Delete ALL Boxes',
				'⚠️ WARNING: This will permanently delete ALL boxes and cannot be undone. Are you absolutely sure?',
				async () => {
					try {
						const snapshot = await getDocs(collection(db, locationsCollectionPath));
						const deletePromises = [];
						snapshot.forEach((doc) => {
							deletePromises.push(deleteDoc(doc.ref));
						});
						await Promise.all(deletePromises);
						loadBoxes();
					} catch (error) {
						alert('Error deleting boxes: ' + error.message);
					}
				}
			);
		});

		// Delete report
		window.deleteReport = function(reportId) {
			showConfirmation(
				'Delete Report',
				'Are you sure you want to delete this report?',
				async () => {
					try {
						const docRef = doc(db, reportsCollectionPath, reportId);
						await deleteDoc(docRef);
						loadReports();
					} catch (error) {
						alert('Error deleting report: ' + error.message);
					}
				}
			);
		};

		// Delete all reports
		document.getElementById('delete-all-reports-btn').addEventListener('click', () => {
			showConfirmation(
				'Delete ALL Reports',
				'⚠️ WARNING: This will permanently delete ALL reports and cannot be undone. Are you absolutely sure?',
				async () => {
					try {
						const snapshot = await getDocs(collection(db, reportsCollectionPath));
						const deletePromises = [];
						snapshot.forEach((doc) => {
							deletePromises.push(deleteDoc(doc.ref));
						});
						await Promise.all(deletePromises);
						loadReports();
					} catch (error) {
						alert('Error deleting reports: ' + error.message);
					}
				}
			);
		});

		// Edit volunteer
		window.editVolunteer = async function(volunteerId) {
			if (volunteerId === currentUser.uid) {
				alert('You cannot edit your own account.');
				return;
			}

			currentEditVolunteerId = volunteerId;
			const volunteersPath = 'artifacts/toysfortots-eae4d/private/01/data/01/authorizedVolunteers';
			const docRef = doc(db, volunteersPath, volunteerId);
			const docSnap = await getDocs(query(collection(db, volunteersPath)));

			let volunteerData = null;
			docSnap.forEach((d) => {
				if (d.id === volunteerId) {
					volunteerData = d.data();
				}
			});

			if (!volunteerData) return;

			document.getElementById('edit-volunteer-name').value = volunteerData.displayName || '';
			document.getElementById('edit-volunteer-email').value = volunteerData.email || '';

			document.getElementById('edit-volunteer-modal').classList.add('active');
		};

		// Save volunteer changes
		document.getElementById('edit-volunteer-form').addEventListener('submit', async (e) => {
			e.preventDefault();

			try {
				const volunteersPath = 'artifacts/toysfortots-eae4d/private/01/data/01/authorizedVolunteers';
				const docRef = doc(db, volunteersPath, currentEditVolunteerId);
				await updateDoc(docRef, {
					displayName: document.getElementById('edit-volunteer-name').value
				});

				document.getElementById('edit-volunteer-modal').classList.remove('active');
				loadVolunteers();
			} catch (error) {
				alert('Error updating volunteer: ' + error.message);
			}
		});

		document.getElementById('edit-volunteer-cancel').addEventListener('click', () => {
			document.getElementById('edit-volunteer-modal').classList.remove('active');
		});

		// Delete volunteer
		window.deleteVolunteer = function(volunteerId, name) {
			if (volunteerId === currentUser.uid) {
				alert('You cannot delete your own account.');
				return;
			}

			showConfirmation(
				'Delete Volunteer',
				`Are you sure you want to delete volunteer "${name}"? This will remove their access to the system.`,
				async () => {
					try {
						const volunteersPath = 'artifacts/toysfortots-eae4d/private/01/data/01/authorizedVolunteers';
						const docRef = doc(db, volunteersPath, volunteerId);
						await deleteDoc(docRef);
						loadVolunteers();
					} catch (error) {
						alert('Error deleting volunteer: ' + error.message);
					}
				}
			);
		};

		// Delete all volunteers
		document.getElementById('delete-all-volunteers-btn').addEventListener('click', () => {
			showConfirmation(
				'Delete ALL Volunteers',
				'⚠️ WARNING: This will delete all volunteers EXCEPT you. This action cannot be undone. Are you absolutely sure?',
				async () => {
					try {
						const volunteersPath = 'artifacts/toysfortots-eae4d/private/01/data/01/authorizedVolunteers';
						const snapshot = await getDocs(collection(db, volunteersPath));
						const deletePromises = [];
						snapshot.forEach((doc) => {
							if (doc.id !== currentUser.uid) {
								deletePromises.push(deleteDoc(doc.ref));
							}
						});
						await Promise.all(deletePromises);
						loadVolunteers();
					} catch (error) {
						alert('Error deleting volunteers: ' + error.message);
					}
				}
			);
		});

		// Confirmation modal
		function showConfirmation(title, message, callback) {
			document.getElementById('modal-title').textContent = title;
			document.getElementById('modal-message').textContent = message;
			confirmCallback = callback;
			document.getElementById('confirmation-modal').classList.add('active');
		}

		document.getElementById('modal-confirm').addEventListener('click', async () => {
			document.getElementById('confirmation-modal').classList.remove('active');
			if (confirmCallback) {
				await confirmCallback();
				confirmCallback = null;
			}
		});

		document.getElementById('modal-cancel').addEventListener('click', () => {
			document.getElementById('confirmation-modal').classList.remove('active');
			confirmCallback = null;
		});
	</script>
</body>
</html>
