<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: https: blob:; font-src 'self' data: https://unpkg.com; connect-src 'self' http://localhost:* ws://localhost:* http://127.0.0.1:* ws://127.0.0.1:* https://*.gstatic.com https://unpkg.com https://*.googleapis.com https://*.cloudfunctions.net https://*.firebaseapp.com https://*.firebaseio.com https://*.google.com https://tile.openstreetmap.org wss://*.firebaseio.com; frame-src 'self' https://*.google.com; object-src 'none'; base-uri 'self'; form-action 'self'">
	<meta name="description" content="Admin panel for managing Toys for Tots donation boxes, locations, and volunteers. Run by the Marine Corps Reserve and coordinated locally by Marine Corps League Detachment 1311.">
	<title>Admin Panel - Toys for Tots</title>
	<link rel="stylesheet" href="/css/style.min.css?v=1.0.20">
	<style>
		.admin-container {
			max-width: 1400px;
			margin: 20px auto;
			padding: 0 20px;
		}

		.admin-header {
			background: white;
			padding: 20px;
			border-radius: 8px;
			margin-bottom: 30px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		.admin-header h1 {
			color: var(--marine-blue);
			margin: 0 0 10px 0;
		}

		.admin-header p {
			color: var(--text-secondary);
			margin: 0;
		}

		.admin-section {
			background: white;
			padding: 20px;
			border-radius: 8px;
			margin-bottom: 20px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		.section-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
			padding-bottom: 15px;
			border-bottom: 2px solid var(--t4t-red);
		}

		.section-header h2 {
			color: var(--marine-blue);
			margin: 0;
		}

		.danger-btn {
			background-color: var(--t4t-red);
			color: white;
			padding: 8px 16px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-weight: 600;
		}

		.danger-btn:hover {
			background-color: var(--t4t-red-hover);
		}

		.primary-btn {
			background-color: var(--marine-blue);
			color: white;
			padding: 8px 16px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-weight: 600;
		}

		.primary-btn:hover {
			background-color: #001a3d;
		}

		.secondary-btn {
			background-color: var(--gray-500);
			color: white;
			padding: 8px 16px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-weight: 600;
		}

		.secondary-btn:hover {
			background-color: var(--gray-600);
		}

		.data-table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 15px;
		}

		.data-table th {
			background-color: var(--gray-100);
			color: var(--marine-blue);
			padding: 12px;
			text-align: left;
			font-weight: 600;
			border-bottom: 2px solid var(--t4t-red);
		}

		.data-table td {
			padding: 12px;
			border-bottom: 1px solid var(--gray-200);
		}

		.data-table tr:hover {
			background-color: var(--gray-50);
		}

		.action-buttons {
			display: flex;
			gap: 8px;
		}

		.action-buttons button {
			padding: 6px 12px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 0.9rem;
		}

		.edit-btn {
			background-color: var(--marine-blue);
			color: white;
		}

		.edit-btn:hover {
			background-color: #001a3d;
		}

		.delete-btn {
			background-color: var(--t4t-red);
			color: white;
		}

		.delete-btn:hover {
			background-color: var(--t4t-red-hover);
		}

		.modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.5);
			z-index: 1000;
			align-items: center;
			justify-content: center;
		}

		.modal.active {
			display: flex;
		}

		.modal-content {
			background: white;
			padding: 30px;
			border-radius: 8px;
			max-width: 500px;
			width: 90%;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}

		.modal-content h3 {
			color: var(--marine-blue);
			margin-top: 0;
		}

		.modal-content p {
			color: var(--text-secondary);
			margin: 15px 0;
		}

		.modal-buttons {
			display: flex;
			gap: 10px;
			justify-content: flex-end;
			margin-top: 20px;
		}

		.edit-form {
			display: none;
			margin-top: 15px;
			padding: 20px;
			background-color: var(--gray-50);
			border-radius: 8px;
		}

		.edit-form.active {
			display: block;
		}

		.form-group {
			margin-bottom: 15px;
		}

		.form-group label {
			display: block;
			color: var(--marine-blue);
			font-weight: 600;
			margin-bottom: 5px;
		}

		.form-group input,
		.form-group select {
			width: 100%;
			padding: 10px;
			border: 1px solid var(--gray-300);
			border-radius: 4px;
			font-size: 1rem;
		}

		.form-buttons {
			display: flex;
			gap: 10px;
			margin-top: 20px;
		}

		.loading {
			text-align: center;
			padding: 20px;
			color: var(--text-secondary);
		}

		.error-message {
			background-color: var(--t4t-red-light);
			color: var(--t4t-red);
			padding: 15px;
			border-radius: 4px;
			margin-bottom: 15px;
		}

		.success-message {
			background-color: #f0fdf4;
			color: var(--t4t-green-dark);
			padding: 15px;
			border-radius: 4px;
			margin-bottom: 15px;
		}

		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
			margin-bottom: 20px;
		}

		.stat-card {
			background-color: var(--gray-50);
			padding: 15px;
			border-radius: 8px;
			text-align: center;
		}

		.stat-card .stat-value {
			font-size: 2rem;
			font-weight: bold;
			color: var(--marine-blue);
		}

		.stat-card .stat-label {
			color: var(--text-secondary);
			font-size: 0.9rem;
			margin-top: 5px;
		}

		.section-controls {
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 15px;
			margin-bottom: 15px;
			flex-wrap: wrap;
		}

		.search-box {
			flex: 0 1 400px;
			min-width: 250px;
		}

		.search-box input {
			width: 100%;
			padding: 10px 15px;
			border: 1px solid var(--gray-300);
			border-radius: 4px;
			font-size: 1rem;
		}

		.search-box input:focus {
			outline: none;
			border-color: var(--marine-blue);
		}

		.control-buttons {
			display: flex;
			gap: 10px;
		}

		.export-btn {
			background-color: var(--t4t-green);
			color: white;
			padding: 8px 16px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-weight: 600;
		}

		.export-btn:hover {
			background-color: var(--t4t-green-dark);
		}

		.data-table th {
			cursor: pointer;
			user-select: none;
			position: relative;
		}

		.data-table th:hover {
			background-color: var(--gray-200);
		}

		.data-table th.sortable::after {
			content: ' ‚áÖ';
			font-size: 0.8em;
			color: var(--gray-400);
		}

		.data-table th.sorted-asc::after {
			content: ' ‚Üë';
			color: var(--marine-blue);
		}

		.data-table th.sorted-desc::after {
			content: ' ‚Üì';
			color: var(--marine-blue);
		}

		.data-table a {
			color: inherit;
			text-decoration: none;
		}

		.data-table a:hover {
			text-decoration: underline;
			color: var(--marine-blue);
		}

		.pagination {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 10px;
			margin-top: 20px;
		}

		.pagination button {
			padding: 8px 12px;
			border: 1px solid var(--gray-300);
			background-color: white;
			border-radius: 4px;
			cursor: pointer;
		}

		.pagination button:hover:not(:disabled) {
			background-color: var(--gray-100);
		}

		.pagination button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.pagination .page-info {
			color: var(--text-secondary);
			font-size: 0.9rem;
		}

		@media (max-width: 768px) {
			.data-table {
				font-size: 0.9rem;
			}

			.data-table th,
			.data-table td {
				padding: 8px;
			}

			.action-buttons {
				flex-direction: column;
			}

			.section-header {
				flex-direction: column;
				align-items: flex-start;
				gap: 10px;
			}
		}

		/* Live table update animations */
		.data-table td {
			position: relative;
		}

		/* Cell content wrapper to prevent shifting when bold */
		.cell-content {
			display: inline-block;
			min-width: fit-content;
		}

		/* Hidden duplicate for width calculation */
		.cell-content::after {
			content: attr(data-text);
			font-weight: bold;
			height: 0;
			visibility: hidden;
			overflow: hidden;
			user-select: none;
			pointer-events: none;
			display: block;
		}

		/* Update flash animation (yellow) */
		@keyframes flash-yellow {
			0%, 100% { background-color: transparent; }
			50% { background-color: #fefce8; }
		}

		.flashing {
			animation: flash-yellow 0.6s ease-in-out 3;
		}

		.cell-content.bold {
			font-weight: bold;
			color: #000;
		}

		/* New row insertion animation (green) */
		@keyframes fade-in-new {
			0% {
				opacity: 0;
				transform: translateY(-10px);
			}
			100% {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@keyframes flash-green {
			0%, 100% { background-color: transparent; }
			50% { background-color: #d1fae5; }
		}

		.new-row {
			border-left: 4px solid #008000;
			animation: fade-in-new 0.5s ease-out,
			           flash-green 0.6s ease-in-out 3;
		}

		/* Row deletion animation (red) */
		@keyframes flash-red-delete {
			0%, 100% { background-color: transparent; }
			50% { background-color: #fee2e2; }
		}

		@keyframes fade-out-collapse {
			0% {
				opacity: 1;
				max-height: 60px;
			}
			50% {
				opacity: 0;
				max-height: 60px;
			}
			100% {
				opacity: 0;
				max-height: 0;
				padding-top: 0;
				padding-bottom: 0;
			}
		}

		.deleting-row {
			animation: flash-red-delete 0.4s ease-in-out 2,
			           fade-out-collapse 0.6s ease-in-out 0.8s;
			animation-fill-mode: forwards;
			overflow: hidden;
		}

		.deleting-row td {
			border-bottom: none;
		}
	</style>
</head>
<body class="bg-gray-100">
	<div id="header-placeholder"></div>

	<main class="admin-container">
		<div class="admin-header">
			<div style="display: flex; justify-content: space-between; align-items: center;">
				<div>
					<h1>Admin Panel</h1>
					<p>Manage donation boxes, locations, and volunteers</p>
				</div>
				<div style="display: flex; gap: 10px;">
					<button id="sync-sheets-btn" class="primary-btn">
						Sync Google Sheets
					</button>
					<button id="refresh-cache-btn" class="primary-btn">
						Refresh Map Cache
					</button>
				</div>
			</div>
			<div id="cache-refresh-result" style="margin-top: 15px; display: none;"></div>
			<div id="sheets-sync-result" style="margin-top: 15px; display: none;"></div>
		</div>

		<div id="auth-check" class="loading">
			Checking authorization...
		</div>

		<div id="admin-content" style="display: none;">
			<!-- Statistics -->
			<div class="stats-grid">
				<div class="stat-card">
					<div class="stat-value" id="stat-boxes">0</div>
					<div class="stat-label">Total Boxes</div>
				</div>
				<div class="stat-card">
					<div class="stat-value" id="stat-reports">0</div>
					<div class="stat-label">Total Reports</div>
				</div>
				<div class="stat-card">
					<div class="stat-value" id="stat-volunteers">0</div>
					<div class="stat-label">Authorized Volunteers</div>
				</div>
			</div>

			<!-- Box Management -->
			<div class="admin-section">
				<div class="section-header">
					<div>
						<h2>Box Management</h2>
						<div id="boxes-last-updated" style="color: var(--text-muted); font-size: 0.875rem; margin-top: 4px;">
							Loading...
						</div>
					</div>
					<button class="danger-btn" id="delete-all-boxes-btn">Delete All Boxes</button>
				</div>
				<div class="section-controls">
					<div class="search-box">
						<input type="text" id="boxes-search" placeholder="Search boxes by ID, location, address, city, or volunteer...">
					</div>
					<div class="control-buttons">
						<button class="export-btn" id="export-boxes-btn">Export CSV</button>
					</div>
				</div>
				<div id="boxes-loading" class="loading">Loading boxes...</div>
				<div id="boxes-error" class="error-message" style="display: none;"></div>
				<div id="boxes-container"></div>
				<div id="boxes-pagination" class="pagination" style="display: none;"></div>
			</div>

			<!-- Report Management -->
			<div class="admin-section">
				<div class="section-header">
					<div>
						<h2>Report Management</h2>
						<div id="reports-last-updated" style="color: var(--text-muted); font-size: 0.875rem; margin-top: 4px;">
							Loading...
						</div>
					</div>
					<button class="danger-btn" id="delete-all-reports-btn">Delete All Reports</button>
				</div>
				<div class="section-controls">
					<div class="search-box">
						<input type="text" id="reports-search" placeholder="Search reports by ID, box ID, type, or status...">
					</div>
					<div class="control-buttons">
						<button class="export-btn" id="export-reports-btn">Export CSV</button>
					</div>
				</div>
				<div id="reports-loading" class="loading">Loading reports...</div>
				<div id="reports-error" class="error-message" style="display: none;"></div>
				<div id="reports-container"></div>
				<div id="reports-pagination" class="pagination" style="display: none;"></div>
			</div>

			<!-- Volunteer Management -->
			<div class="admin-section">
				<div class="section-header">
					<div>
						<h2>Volunteer Management</h2>
						<div id="volunteers-last-updated" style="color: var(--text-muted); font-size: 0.875rem; margin-top: 4px;">
							Loading...
						</div>
					</div>
					<button class="danger-btn" id="delete-all-volunteers-btn">Delete All Volunteers</button>
				</div>
				<div class="section-controls">
					<div class="search-box">
						<input type="text" id="volunteers-search" placeholder="Search volunteers by ID or name...">
					</div>
					<div class="control-buttons">
						<button class="export-btn" id="export-volunteers-btn">Export CSV</button>
					</div>
				</div>
				<div id="volunteers-loading" class="loading">Loading volunteers...</div>
				<div id="volunteers-error" class="error-message" style="display: none;"></div>
				<div id="volunteers-container"></div>
				<div id="volunteers-pagination" class="pagination" style="display: none;"></div>
			</div>

			<!-- Root Only: Show Deleted Toggle -->
			<div id="deleted-toggle" class="admin-section" style="display: none;">
				<label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
					<input type="checkbox" id="show-deleted-checkbox" style="width: auto;">
					<span style="font-weight: 600; color: var(--marine-blue);">Show Deleted Items</span>
					<span style="color: var(--text-muted); font-size: 0.9rem;">(Root users can view and restore soft-deleted data)</span>
				</label>
			</div>

			<!-- Admin/Root: Audit Logs Section -->
			<div id="audit-section" class="admin-section" style="display: none;">
				<div class="section-header">
					<h2>üìã Audit Logs</h2>
				</div>
				<div class="section-controls">
					<div class="search-box">
						<input type="text" id="audit-search" placeholder="Search audit logs by user, action, or target...">
					</div>
					<div class="control-buttons">
						<select id="audit-action-filter" style="padding: 8px 12px; border: 1px solid var(--gray-300); border-radius: 4px;">
							<option value="">All Actions</option>
							<option value="delete_box">Delete Box</option>
							<option value="delete_box_bulk">Bulk Delete Boxes</option>
							<option value="delete_report">Delete Report</option>
							<option value="delete_report_bulk">Bulk Delete Reports</option>
							<option value="delete_volunteer">Delete Volunteer</option>
							<option value="delete_volunteer_bulk">Bulk Delete Volunteers</option>
							<option value="modify_box">Modify Box</option>
							<option value="modify_volunteer">Modify Volunteer</option>
							<option value="modify_volunteer_role">Change Volunteer Role</option>
							<option value="purge_soft_deletes">Purge Soft Deletes</option>
							<option value="export_data">Export Data</option>
						</select>
						<button id="refresh-audit-btn" class="primary-btn">Refresh</button>
					</div>
				</div>
				<div id="audit-loading" class="loading" style="display: none;">Loading audit logs...</div>
				<div id="audit-error" class="error-message" style="display: none;"></div>
				<div id="audit-container"></div>
				<div id="audit-pagination" class="pagination" style="display: none;"></div>
			</div>

			<!-- Root Only: Purge Section -->
			<div id="purge-section" class="admin-section" style="display: none; border: 2px solid var(--t4t-red);">
				<div class="section-header" style="border-bottom-color: var(--t4t-red);">
					<h2 style="color: var(--t4t-red);">‚ö†Ô∏è Danger Zone - Purge Operations (Root Only)</h2>
				</div>
				<p style="color: var(--text-secondary); margin-bottom: 20px;">
					<strong>WARNING:</strong> Purge operations permanently delete data and cannot be undone.
					Only use these when you're certain you want to remove soft-deleted items forever.
				</p>
				<div class="control-buttons">
					<button id="purge-deleted-boxes-btn" class="danger-btn">Purge Deleted Boxes</button>
					<button id="purge-deleted-reports-btn" class="danger-btn">Purge Deleted Reports</button>
					<button id="purge-deleted-volunteers-btn" class="danger-btn">Purge Deleted Volunteers</button>
					<button id="purge-audit-logs-btn" class="danger-btn">Purge Old Audit Logs (90+ days)</button>
				</div>
				<div id="purge-result" style="margin-top: 15px; display: none;"></div>
			</div>
		</div>
	</main>

	<!-- Confirmation Modal -->
	<div id="confirmation-modal" class="modal">
		<div class="modal-content">
			<h3 id="modal-title">Confirm Action</h3>
			<p id="modal-message">Are you sure you want to proceed?</p>
			<div class="modal-buttons">
				<button class="secondary-btn" id="modal-cancel">Cancel</button>
				<button class="danger-btn" id="modal-confirm">Confirm</button>
			</div>
		</div>
	</div>

	<!-- Edit Box Modal -->
	<div id="edit-box-modal" class="modal">
		<div class="modal-content">
			<h3>Edit Box</h3>
			<form id="edit-box-form">
				<div class="form-group">
					<label for="edit-box-label">Location Name</label>
					<input type="text" id="edit-box-label" required>
				</div>
				<div class="form-group">
					<label for="edit-box-address">Address</label>
					<input type="text" id="edit-box-address" required>
				</div>
				<div class="form-group">
					<label for="edit-box-city">City</label>
					<input type="text" id="edit-box-city" required>
				</div>
				<div class="form-group">
					<label for="edit-box-state">State</label>
					<input type="text" id="edit-box-state" value="GA" required>
				</div>
				<div class="form-group">
					<label for="edit-box-contact-name">Contact Name</label>
					<input type="text" id="edit-box-contact-name">
				</div>
				<div class="form-group">
					<label for="edit-box-contact-phone">Contact Phone</label>
					<input type="tel" id="edit-box-contact-phone">
				</div>
				<div class="form-group">
					<label for="edit-box-contact-email">Contact Email</label>
					<input type="email" id="edit-box-contact-email">
				</div>
				<div class="form-group">
					<label>GPS Coordinates</label>
					<div id="edit-box-gps" style="display: flex; gap: 10px; align-items: center;">
						<span id="edit-box-coordinates" style="font-family: monospace; color: #666;"></span>
						<a id="edit-box-map-link" href="#" target="_blank" rel="noopener noreferrer" style="display: none; color: var(--t4t-red); text-decoration: none; font-weight: 500;">View on Map ‚Üí</a>
					</div>
				</div>
				<div class="form-buttons">
					<button type="button" class="secondary-btn" id="edit-box-cancel">Cancel</button>
					<button type="submit" class="primary-btn">Save Changes</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Edit Volunteer Modal -->
	<div id="edit-volunteer-modal" class="modal">
		<div class="modal-content">
			<h3>Edit Volunteer</h3>
			<form id="edit-volunteer-form">
				<div class="form-group">
					<label for="edit-volunteer-name">Display Name</label>
					<input type="text" id="edit-volunteer-name" required>
				</div>
				<div class="form-group">
					<label for="edit-volunteer-email">Email</label>
					<input type="email" id="edit-volunteer-email" disabled>
				</div>
				<div class="form-buttons">
					<button type="button" class="secondary-btn" id="edit-volunteer-cancel">Cancel</button>
					<button type="submit" class="primary-btn">Save Changes</button>
				</div>
			</form>
		</div>
	</div>

	<div id="footer-placeholder"></div>
	<script src="/js/loader.min.js" defer></script>
	<script type="module">
		import { db, auth, functions, locationsCollectionPath, reportsCollectionPath, authorizedVolunteersCollectionPath, auditLogsCollectionPath } from '/js/firebase-init.js';
		import { logAudit, AUDIT_ACTIONS } from '/js/audit-logger.js';
		import {
			collection,
			getDocs,
			getDoc,
			doc,
			updateDoc,
			deleteDoc,
			query,
			orderBy,
			where,
			onSnapshot,
			serverTimestamp
		} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
		import {
			onAuthStateChanged
		} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
		import {
			httpsCallable
		} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js';

		let currentUser = null;
		let currentUserRole = 'volunteer'; // Will be set on auth
		let currentEditBoxId = null;
		let currentEditVolunteerId = null;
		let confirmCallback = null;
		let showingDeleted = localStorage.getItem('showingDeleted') === 'true'; // For root users to toggle deleted items view

		// Listener cleanup - store unsubscribe functions to prevent duplicate listeners
		let boxesUnsubscribe = null;
		let boxesEventListenersSetup = false; // Track if search/export listeners are already attached
		let renderDebounceTimer = null; // Debounce timer to prevent duplicate re-renders during animations

		const ROOT_USER_EMAIL = 'acklenx@gmail.com';
		const ROOT_USER_NAME = 'Quincy Acklen';

		// HTML escaping function to prevent XSS attacks
		const escapeHtml = (unsafe) => {
			if (!unsafe) return '';
			return String(unsafe)
				.replace(/&/g, '&amp;')
				.replace(/</g, '&lt;')
				.replace(/>/g, '&gt;')
				.replace(/"/g, '&quot;')
				.replace(/'/g, '&#039;');
		};

		// Data storage for filtering/sorting/pagination
		let allBoxes = [];
		let filteredBoxes = [];
		let allReports = [];
		let filteredReports = [];
		let allVolunteers = [];
		let filteredVolunteers = [];
		let locationSuggestions = []; // Google Sheets data

		// Live update tracking
		let boxesInitialLoadComplete = false;
		let reportsInitialLoadComplete = false;
		let volunteersInitialLoadComplete = false;

		// Pagination settings
		const PAGE_SIZE = 20;
		let currentBoxesPage = 1;
		let currentReportsPage = 1;
		let currentVolunteersPage = 1;

		// Sorting state
		let boxesSortColumn = null;
		let boxesSortDirection = 'asc';
		let reportsSortColumn = null;
		let reportsSortDirection = 'asc';
		let volunteersSortColumn = null;
		let volunteersSortDirection = 'asc';

		// Authorization check
		onAuthStateChanged(auth, async (user) => {
			if (!user || user.isAnonymous) {
				window.location.href = '/login';
				return;
			}

			currentUser = user;

			// Check if authorized
			try {
				const isAuthorized = httpsCallable(functions, 'isAuthorizedVolunteerV2');
				const result = await isAuthorized();

				if (!result.data.isAuthorized) {
					document.getElementById('auth-check').innerHTML = '<div class="error-message">You are not authorized to access the admin panel.</div>';
					return;
				}

				// Get user's role from Firestore
				const volunteerDoc = await getDoc(doc(db, authorizedVolunteersCollectionPath, user.uid));
				if (volunteerDoc.exists()) {
					currentUserRole = volunteerDoc.data().role || 'volunteer';
					console.log(`User role: ${currentUserRole}`);
				}

				// Only admins/root can access admin panel
				if (!['admin', 'root'].includes(currentUserRole)) {
					document.getElementById('auth-check').innerHTML = '<div class="error-message">Only administrators can access this panel.</div>';
					return;
				}

				document.getElementById('auth-check').style.display = 'none';
				document.getElementById('admin-content').style.display = 'block';

				// Show/hide root-only features
				if (currentUserRole === 'root') {
					const deletedToggle = document.getElementById('deleted-toggle');
					const purgeSection = document.getElementById('purge-section');
					const auditSection = document.getElementById('audit-section');
					if (deletedToggle) deletedToggle.style.display = 'block';
					if (purgeSection) purgeSection.style.display = 'block';
					if (auditSection) auditSection.style.display = 'block';
				}

				// Load all data
				loadLocationSuggestions();
				loadBoxes();
				loadReports();
				loadVolunteers();
			} catch (error) {
				document.getElementById('auth-check').innerHTML = '<div class="error-message">Error checking authorization: ' + escapeHtml(error.message) + '</div>';
			}
		});

		// Google Sheets sync functionality
		document.getElementById('sync-sheets-btn').addEventListener('click', async () => {
			const btn = document.getElementById('sync-sheets-btn');
			const resultDiv = document.getElementById('sheets-sync-result');

			btn.disabled = true;
			btn.textContent = 'Syncing...';
			resultDiv.style.display = 'none';

			try {
				// Get Firebase ID token for authorization
				const idToken = await window.auth.currentUser.getIdToken();

				const response = await fetch('https://us-central1-toysfortots-eae4d.cloudfunctions.net/triggerSyncLocationSuggestions', {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${idToken}`
					}
				});

				const data = await response.json();

				if (data.success) {
					resultDiv.className = 'success-message';
					resultDiv.innerHTML = `
						<strong>‚úÖ Google Sheets Synced Successfully</strong><br>
						<div style="margin-top: 8px; font-size: 0.9em;">
							‚Ä¢ Locations synced: ${data.synced || 0}<br>
							‚Ä¢ Message: ${data.message || 'Data synced from spreadsheet'}
						</div>
					`;
					// Reload volunteers data to update undeployed count
					// Don't call loadVolunteers() - the real-time listener will handle updates automatically
				} else {
					resultDiv.className = 'error-message';
					resultDiv.innerHTML = `<strong>‚ùå Sync Failed</strong><br>${data.message || 'Unknown error'}`;
				}
			} catch (error) {
				resultDiv.className = 'error-message';
				resultDiv.innerHTML = `<strong>‚ùå Request Failed</strong><br>${error.message}`;
			} finally {
				btn.disabled = false;
				btn.textContent = 'Sync Google Sheets';
				resultDiv.style.display = 'block';

				// Auto-hide success message after 10 seconds
				if (resultDiv.className === 'success-message') {
					setTimeout(() => {
						resultDiv.style.display = 'none';
					}, 10000);
				}
			}
		});

		// Cache refresh functionality
		document.getElementById('refresh-cache-btn').addEventListener('click', async () => {
			const btn = document.getElementById('refresh-cache-btn');
			const resultDiv = document.getElementById('cache-refresh-result');

			btn.disabled = true;
			btn.textContent = 'Refreshing...';
			resultDiv.style.display = 'none';

			try {
				// Get Firebase ID token for authorization
				const idToken = await window.auth.currentUser.getIdToken();

				const response = await fetch('https://us-central1-toysfortots-eae4d.cloudfunctions.net/triggerRefreshLocationsCache', {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${idToken}`
					}
				});

				const data = await response.json();

				if (data.success) {
					resultDiv.className = 'success-message';
					resultDiv.innerHTML = `
						<strong>‚úÖ Cache Refreshed Successfully</strong><br>
						<div style="margin-top: 8px; font-size: 0.9em;">
							‚Ä¢ Boxes cached: ${data.count || 0}<br>
							‚Ä¢ Cache URL: <a href="${data.url}" target="_blank" style="color: var(--t4t-green-dark); text-decoration: underline;">${data.url}</a><br>
							‚Ä¢ Message: ${data.message || 'Cache regenerated'}
						</div>
					`;
				} else {
					resultDiv.className = 'error-message';
					resultDiv.innerHTML = `<strong>‚ùå Cache Refresh Failed</strong><br>${data.message || 'Unknown error'}`;
				}
			} catch (error) {
				resultDiv.className = 'error-message';
				resultDiv.innerHTML = `<strong>‚ùå Request Failed</strong><br>${error.message}`;
			} finally {
				btn.disabled = false;
				btn.textContent = 'Refresh Map Cache';
				resultDiv.style.display = 'block';

				// Auto-hide success message after 10 seconds
				if (resultDiv.className === 'success-message') {
					setTimeout(() => {
						resultDiv.style.display = 'none';
					}, 10000);
				}
			}
		});

		// Load location suggestions from Google Sheets
		async function loadLocationSuggestions() {
			try {
				const suggestionsPath = 'artifacts/toysfortots-eae4d/public/01/data/01/locationSuggestions';
				const suggestionsRef = collection(db, suggestionsPath);
				const snapshot = await getDocs(suggestionsRef);

				locationSuggestions = [];
				snapshot.forEach((doc) => {
					locationSuggestions.push({ id: doc.id, ...doc.data() });
				});

				console.log(`Loaded ${locationSuggestions.length} location suggestions from Google Sheets`);
			} catch (error) {
				console.error('Error loading location suggestions:', error);
			}
		}

		// Load boxes with real-time updates
		function loadBoxes() {
			try {
				console.log('üì¶ DEBUG: loadBoxes() called');

				// Clean up old listener to prevent duplicates
				if (boxesUnsubscribe) {
					console.log('üîß DEBUG: Cleaning up old boxes listener to prevent duplicates');
					boxesUnsubscribe();
					boxesUnsubscribe = null;
				}

				const loadStart = performance.now();
				const locationsRef = collection(db, locationsCollectionPath);
				const q = query(locationsRef, orderBy('created', 'desc'));

				// Setup one-time event listeners (only once to prevent duplicates)
				if (!boxesEventListenersSetup) {
					const searchInput = document.getElementById('boxes-search');
					searchInput.addEventListener('input', () => filterAndRenderBoxes());
					const exportBtn = document.getElementById('export-boxes-btn');
					exportBtn.addEventListener('click', () => exportBoxesToCSV());
					boxesEventListenersSetup = true;
				}

				// Real-time listener - store unsubscribe function for cleanup
				boxesUnsubscribe = onSnapshot(q, (snapshot) => {
					const loadTime = Math.round(performance.now() - loadStart);

					// Initial load - build complete list
					if (!boxesInitialLoadComplete) {
						console.log('üì¶ DEBUG: Initial boxes load from Firestore');
						allBoxes = [];
						snapshot.forEach((doc) => {
							const data = doc.data();
							// Filter out soft-deleted items (unless root viewing deleted)
							if (data.deleted && !showingDeleted) return;
							allBoxes.push({ id: doc.id, ...data });
						});

						document.getElementById('stat-boxes').textContent = allBoxes.length;
						document.getElementById('boxes-loading').style.display = 'none';

						// Update timestamp
						const now = new Date();
						const timeStr = now.toLocaleTimeString();
						const cacheIndicator = loadTime < 300 ? ' üöÄ (cached)' : '';
						document.getElementById('boxes-last-updated').textContent =
							`Last updated: ${timeStr}${cacheIndicator} ‚Ä¢ ${loadTime}ms`;

						filterAndRenderBoxes();
						boxesInitialLoadComplete = true;
					} else {
						// Subsequent updates - handle changes with animations
						console.log('üîÑ DEBUG: Boxes listener fired - processing changes');
						snapshot.docChanges().forEach((change) => {
							const box = { id: change.doc.id, ...change.doc.data() };

							if (change.type === 'added') {
								// New box added - check if it should be displayed
								if (box.deleted && !showingDeleted) {
									console.log(`üîç DEBUG: Skipping deleted box ${box.id} (showingDeleted: false)`);
									return; // Don't add deleted boxes unless showing deleted items
								}
								allBoxes.push(box);
								handleBoxAdded(box);
							} else if (change.type === 'modified') {
								// Box updated - might have been soft-deleted!
								const index = allBoxes.findIndex(b => b.id === box.id);

								// Check if box was soft-deleted and we're not showing deleted items
								if (box.deleted && !showingDeleted) {
									console.log(`üóëÔ∏è DEBUG: Box ${box.id} was soft-deleted, removing from display`);
									if (index !== -1) {
										allBoxes.splice(index, 1);
										handleBoxRemoved(box.id);
									}
								} else if (index !== -1) {
									// Normal update
									allBoxes[index] = box;
									handleBoxModified(box);
								} else if (!box.deleted || showingDeleted) {
									// Box exists in Firestore but not in our array - add it
									allBoxes.push(box);
									handleBoxAdded(box);
								}
							} else if (change.type === 'removed') {
								// Box permanently deleted from Firestore
								const index = allBoxes.findIndex(b => b.id === box.id);
								if (index !== -1) {
									allBoxes.splice(index, 1);
									handleBoxRemoved(box.id);
								}
							}
						});

						// Update count
						document.getElementById('stat-boxes').textContent = allBoxes.length;

						// Update timestamp
						const now = new Date();
						const timeStr = now.toLocaleTimeString();
						document.getElementById('boxes-last-updated').textContent =
							`Synced: ${timeStr} üîÑ (live)`;
					}
				}, (error) => {
					document.getElementById('boxes-loading').style.display = 'none';
					document.getElementById('boxes-error').textContent = 'Error loading boxes: ' + error.message;
					document.getElementById('boxes-error').style.display = 'block';
				});

				console.log('‚úÖ DEBUG: Boxes listener created and stored successfully');
			} catch (error) {
				document.getElementById('boxes-loading').style.display = 'none';
				document.getElementById('boxes-error').textContent = 'Error loading boxes: ' + error.message;
				document.getElementById('boxes-error').style.display = 'block';
			}
		}

		// Handle new box added with green flash animation
		function handleBoxAdded(box) {
			// Re-filter and render to include new box
			filterAndRenderBoxes();

			// Find the new row and apply animation
			const container = document.getElementById('boxes-container');
			const rows = container.querySelectorAll('tbody tr');
			rows.forEach(row => {
				const link = row.querySelector('td:first-child a');
				if (link && link.textContent === box.id) {
					row.classList.add('new-row');
					// Remove animation class after it completes
					setTimeout(() => {
						row.classList.remove('new-row');
					}, 3000);
					// Scroll into view
					row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
				}
			});
		}

		// Handle box modified with yellow flash animation
		function handleBoxModified(box) {
			// Re-filter and render with updated data
			filterAndRenderBoxes();

			// Find the modified row and apply animation
			const container = document.getElementById('boxes-container');
			const rows = container.querySelectorAll('tbody tr');
			rows.forEach(row => {
				const link = row.querySelector('td:first-child a');
				if (link && link.textContent === box.id) {
					row.classList.add('flashing');
					// Remove animation class after it completes
					setTimeout(() => {
						row.classList.remove('flashing');
					}, 1800);
				}
			});
		}

		// Handle box removed with red flash + collapse animation
		function handleBoxRemoved(boxId) {
			// Find the row first
			const container = document.getElementById('boxes-container');
			const rows = container.querySelectorAll('tbody tr');
			let foundRow = null;

			rows.forEach(row => {
				const link = row.querySelector('td:first-child a');
				if (link && link.textContent === boxId) {
					foundRow = row;
				}
			});

			if (foundRow) {
				// Apply deletion animation
				foundRow.classList.add('deleting-row');

				// Re-render after animation completes
				setTimeout(() => {
					filterAndRenderBoxes();
				}, 1400);
			} else {
				// Row not found (maybe filtered out), just re-render
				filterAndRenderBoxes();
			}
		}

		function filterAndRenderBoxes() {
			// Debounce rendering to prevent race conditions during animations
			// This prevents duplicate items when Firestore events fire during the 1400ms deletion animation
			clearTimeout(renderDebounceTimer);
			renderDebounceTimer = setTimeout(() => {
				const searchTerm = document.getElementById('boxes-search').value.toLowerCase();
				filteredBoxes = allBoxes.filter(box => {
					return (
						box.id.toLowerCase().includes(searchTerm) ||
						(box.label || '').toLowerCase().includes(searchTerm) ||
						(box.address || '').toLowerCase().includes(searchTerm) ||
						(box.city || '').toLowerCase().includes(searchTerm) ||
						(box.volunteer || '').toLowerCase().includes(searchTerm)
					);
				});

				updateDeleteAllBoxesButton();
				renderBoxes();
			}, 100); // Wait 100ms for rapid changes to settle
		}

		function updateDeleteAllBoxesButton() {
			const btn = document.getElementById('delete-all-boxes-btn');
			const count = filteredBoxes.length;
			const searchTerm = document.getElementById('boxes-search').value.trim();

			if (searchTerm) {
				btn.textContent = `Delete ${count} Box${count !== 1 ? 'es' : ''}`;
			} else {
				btn.textContent = 'Delete All Boxes';
			}
			btn.disabled = count === 0;
		}

		function renderBoxes() {
			const container = document.getElementById('boxes-container');

			if (filteredBoxes.length === 0) {
				container.innerHTML = '<p class="loading">No boxes found.</p>';
				return;
			}

			// Pagination
			const totalPages = Math.ceil(filteredBoxes.length / PAGE_SIZE);
			const startIndex = (currentBoxesPage - 1) * PAGE_SIZE;
			const endIndex = startIndex + PAGE_SIZE;
			const pageData = filteredBoxes.slice(startIndex, endIndex);

			let tableHTML = '<table class="data-table"><thead><tr style="text-align: center;">';
			tableHTML += '<th class="sortable" data-sort="id" onclick="sortBoxes(\'id\')">Box ID</th>';
			tableHTML += '<th class="sortable" data-sort="label" onclick="sortBoxes(\'label\')">Location</th>';
			tableHTML += '<th class="sortable" data-sort="address" onclick="sortBoxes(\'address\')">Address</th>';
			tableHTML += '<th class="sortable" data-sort="city" onclick="sortBoxes(\'city\')">City</th>';
			tableHTML += '<th class="sortable" data-sort="volunteer" onclick="sortBoxes(\'volunteer\')">Volunteer</th>';
			tableHTML += '<th class="sortable" data-sort="scans" onclick="sortBoxes(\'scans\')">Scans</th>';
			tableHTML += '<th>Actions</th>';
			tableHTML += '</tr></thead><tbody>';

			pageData.forEach((box) => {
				const escapedLabel = escapeHtml(box.label || 'N/A');
				const escapedLabelForAttr = escapedLabel.replace(/'/g, "\\'");
				// Build Google Maps search URL
				const fullAddress = `${box.address || ''}, ${box.city || ''}, ${box.state || 'GA'}`;
				const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress)}`;

				// Calculate analytics data
				const analytics = box.analytics || {};
				const views = analytics.views || 0;
				const pickupRequests = analytics.pickupRequests || 0;
				const problemReports = analytics.problemReports || 0;
				const noActionViews = Math.max(0, views - pickupRequests - problemReports);

				// Scans = total page views (should equal pickupRequests + problemReports + noActionViews)
				// If views is 0 due to old bug, calculate from components
				const scans = views > 0 ? views : (pickupRequests + problemReports);

				const tooltipText = `Scans: ${scans}
Pickup Requests: ${pickupRequests}
Problem Reports: ${problemReports}
No Action: ${noActionViews}`;

				const contactTooltip = box.contactName ? `Manager: ${escapeHtml(box.contactName)}` : '';

				tableHTML += '<tr>';
				tableHTML += `<td><a href="/status?id=${encodeURIComponent(box.id)}" target="_blank">${escapeHtml(box.id)}</a></td>`;
				tableHTML += `<td title="${contactTooltip}">${escapedLabel}</td>`;
				tableHTML += `<td><a href="${mapsUrl}" target="_blank" rel="noopener noreferrer">${escapeHtml(box.address || 'N/A')}</a></td>`;
				tableHTML += `<td>${escapeHtml(box.city || 'N/A')}, ${escapeHtml(box.state || 'GA')}</td>`;
				tableHTML += `<td>${escapeHtml(box.volunteer || 'N/A')}</td>`;
				tableHTML += `<td style="text-align: center;" title="${tooltipText}">${scans}</td>`;
				tableHTML += `<td><div class="action-buttons">`;
				tableHTML += `<button class="edit-btn" data-box-id="${escapeHtml(box.id)}">Edit</button>`;
				tableHTML += `<button class="delete-btn" data-box-id="${escapeHtml(box.id)}" data-box-label="${escapedLabelForAttr}">Delete</button>`;
				tableHTML += `</div></td>`;
				tableHTML += '</tr>';
			});

			tableHTML += '</tbody></table>';
			container.innerHTML = tableHTML;

			// Add event listeners to buttons
			container.querySelectorAll('.edit-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					window.editBox(btn.dataset.boxId);
				});
			});
			container.querySelectorAll('.delete-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					window.deleteBox(btn.dataset.boxId, btn.dataset.boxLabel);
				});
			});

			// Update sort indicators
			if (boxesSortColumn) {
				const header = container.querySelector(`th[data-sort="${boxesSortColumn}"]`);
				if (header) {
					header.classList.remove('sortable');
					header.classList.add(boxesSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
				}
			}

			// Render pagination
			const paginationContainer = document.getElementById('boxes-pagination');
			if (totalPages > 1) {
				paginationContainer.style.display = 'flex';
				paginationContainer.innerHTML = `
					<button onclick="changeBoxesPage(${currentBoxesPage - 1})" ${currentBoxesPage === 1 ? 'disabled' : ''}>Previous</button>
					<span class="page-info">Page ${currentBoxesPage} of ${totalPages} (${filteredBoxes.length} items)</span>
					<button onclick="changeBoxesPage(${currentBoxesPage + 1})" ${currentBoxesPage === totalPages ? 'disabled' : ''}>Next</button>
				`;
			} else {
				paginationContainer.style.display = 'none';
			}
		}

		window.sortBoxes = function(column) {
			if (boxesSortColumn === column) {
				boxesSortDirection = boxesSortDirection === 'asc' ? 'desc' : 'asc';
			} else {
				boxesSortColumn = column;
				boxesSortDirection = 'asc';
			}

			filteredBoxes.sort((a, b) => {
				let aVal, bVal;
				if (column === 'scans') {
					// Sort by total scans (page views)
					const aAnalytics = a.analytics || {};
					const bAnalytics = b.analytics || {};
					const aViews = aAnalytics.views || 0;
					const bViews = bAnalytics.views || 0;
					const aPickups = aAnalytics.pickupRequests || 0;
					const bPickups = bAnalytics.pickupRequests || 0;
					const aProblems = aAnalytics.problemReports || 0;
					const bProblems = bAnalytics.problemReports || 0;
					// Calculate scans (fallback to sum if views is 0)
					aVal = aViews > 0 ? aViews : (aPickups + aProblems);
					bVal = bViews > 0 ? bViews : (bPickups + bProblems);
				} else {
					aVal = a[column] || '';
					bVal = b[column] || '';
				}
				if (aVal < bVal) return boxesSortDirection === 'asc' ? -1 : 1;
				if (aVal > bVal) return boxesSortDirection === 'asc' ? 1 : -1;
				return 0;
			});

			renderBoxes();
		};

		window.changeBoxesPage = function(page) {
			const totalPages = Math.ceil(filteredBoxes.length / PAGE_SIZE);
			if (page >= 1 && page <= totalPages) {
				currentBoxesPage = page;
				renderBoxes();
			}
		};

		function exportBoxesToCSV() {
			const headers = ['Box ID', 'Location', 'Address', 'City', 'State', 'Volunteer', 'Created'];
			const rows = filteredBoxes.map(box => [
				box.id,
				box.label || '',
				box.address || '',
				box.city || '',
				box.state || '',
				box.volunteer || '',
				box.created ? new Date(box.created.seconds * 1000).toLocaleString() : ''
			]);

			let csvContent = headers.join(',') + '\n';
			rows.forEach(row => {
				csvContent += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
			});

			const blob = new Blob([csvContent], { type: 'text/csv' });
			const url = URL.createObjectURL(blob);
			const link = document.createElement('a');
			link.href = url;
			link.download = `boxes_${new Date().toISOString().split('T')[0]}.csv`;
			link.click();
			URL.revokeObjectURL(url);
		}

		// Load reports
		async function loadReports() {
			try {
				const loadStart = performance.now();
				const reportsRef = collection(db, reportsCollectionPath);
				const q = query(reportsRef, orderBy('timestamp', 'desc'));
				const snapshot = await getDocs(q);
				const loadTime = Math.round(performance.now() - loadStart);

				allReports = [];
				snapshot.forEach((doc) => {
					const data = doc.data();
					// Filter out soft-deleted items (unless root viewing deleted)
					if (data.deleted && !showingDeleted) return;
					allReports.push({ id: doc.id, ...data });
				});

				document.getElementById('stat-reports').textContent = allReports.length;
				document.getElementById('reports-loading').style.display = 'none';

				// Update last updated timestamp with cache indicator
				const now = new Date();
				const timeStr = now.toLocaleTimeString();
				const cacheIndicator = loadTime < 300 ? ' üöÄ (cached)' : '';
				document.getElementById('reports-last-updated').textContent =
					`Last updated: ${timeStr}${cacheIndicator} ‚Ä¢ ${loadTime}ms`;

				// Setup search
				const searchInput = document.getElementById('reports-search');
				searchInput.addEventListener('input', () => filterAndRenderReports());

				// Setup export
				const exportBtn = document.getElementById('export-reports-btn');
				exportBtn.addEventListener('click', () => exportReportsToCSV());

				filterAndRenderReports();
			} catch (error) {
				document.getElementById('reports-loading').style.display = 'none';
				document.getElementById('reports-error').textContent = 'Error loading reports: ' + error.message;
				document.getElementById('reports-error').style.display = 'block';
			}
		}

		function filterAndRenderReports() {
			const searchTerm = document.getElementById('reports-search').value.toLowerCase();
			filteredReports = allReports.filter(report => {
				return (
					report.id.toLowerCase().includes(searchTerm) ||
					(report.boxId || '').toLowerCase().includes(searchTerm) ||
					(report.reportType || '').toLowerCase().includes(searchTerm) ||
					(report.status || '').toLowerCase().includes(searchTerm)
				);
			});

			updateDeleteAllReportsButton();
			renderReports();
		}

		function updateDeleteAllReportsButton() {
			const btn = document.getElementById('delete-all-reports-btn');
			const count = filteredReports.length;
			const searchTerm = document.getElementById('reports-search').value.trim();

			if (searchTerm) {
				btn.textContent = `Delete ${count} Report${count !== 1 ? 's' : ''}`;
			} else {
				btn.textContent = 'Delete All Reports';
			}
			btn.disabled = count === 0;
		}

		function renderReports() {
			const container = document.getElementById('reports-container');

			if (filteredReports.length === 0) {
				container.innerHTML = '<p class="loading">No reports found.</p>';
				return;
			}

			// Pagination
			const totalPages = Math.ceil(filteredReports.length / PAGE_SIZE);
			const startIndex = (currentReportsPage - 1) * PAGE_SIZE;
			const endIndex = startIndex + PAGE_SIZE;
			const pageData = filteredReports.slice(startIndex, endIndex);

			let tableHTML = '<table class="data-table"><thead><tr style="text-align: center;">';
			tableHTML += '<th class="sortable" data-sort="id" onclick="sortReports(\'id\')">Report ID</th>';
			tableHTML += '<th class="sortable" data-sort="boxId" onclick="sortReports(\'boxId\')">Box ID</th>';
			tableHTML += '<th class="sortable" data-sort="reportType" onclick="sortReports(\'reportType\')">Type</th>';
			tableHTML += '<th class="sortable" data-sort="status" onclick="sortReports(\'status\')">Status</th>';
			tableHTML += '<th class="sortable" data-sort="timestamp" onclick="sortReports(\'timestamp\')">Date</th>';
			tableHTML += '<th>Actions</th>';
			tableHTML += '</tr></thead><tbody>';

			pageData.forEach((report) => {
				const date = report.timestamp ? (report.timestamp.seconds ? new Date(report.timestamp.seconds * 1000).toLocaleDateString() : new Date(report.timestamp).toLocaleDateString()) : 'N/A';
				tableHTML += '<tr>';
				tableHTML += `<td><a href="/status?id=${encodeURIComponent(report.boxId)}#report-${encodeURIComponent(report.id)}" target="_blank">${escapeHtml(report.id)}</a></td>`;
				tableHTML += `<td><a href="/status?id=${encodeURIComponent(report.boxId)}" target="_blank">${escapeHtml(report.boxId || 'N/A')}</a></td>`;
				tableHTML += `<td>${escapeHtml(report.reportType || 'N/A')}</td>`;
				tableHTML += `<td>${escapeHtml(report.status || 'N/A')}</td>`;
				tableHTML += `<td>${date}</td>`;
				tableHTML += `<td><div class="action-buttons">`;
				tableHTML += `<button class="delete-btn" data-report-id="${escapeHtml(report.id)}">Delete</button>`;
				tableHTML += `</div></td>`;
				tableHTML += '</tr>';
			});

			tableHTML += '</tbody></table>';
			container.innerHTML = tableHTML;

			// Add event listeners to buttons
			container.querySelectorAll('.delete-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					window.deleteReport(btn.dataset.reportId);
				});
			});

			// Update sort indicators
			if (reportsSortColumn) {
				const header = container.querySelector(`th[data-sort="${reportsSortColumn}"]`);
				if (header) {
					header.classList.remove('sortable');
					header.classList.add(reportsSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
				}
			}

			// Render pagination
			const paginationContainer = document.getElementById('reports-pagination');
			if (totalPages > 1) {
				paginationContainer.style.display = 'flex';
				paginationContainer.innerHTML = `
					<button onclick="changeReportsPage(${currentReportsPage - 1})" ${currentReportsPage === 1 ? 'disabled' : ''}>Previous</button>
					<span class="page-info">Page ${currentReportsPage} of ${totalPages} (${filteredReports.length} items)</span>
					<button onclick="changeReportsPage(${currentReportsPage + 1})" ${currentReportsPage === totalPages ? 'disabled' : ''}>Next</button>
				`;
			} else {
				paginationContainer.style.display = 'none';
			}
		}

		window.sortReports = function(column) {
			if (reportsSortColumn === column) {
				reportsSortDirection = reportsSortDirection === 'asc' ? 'desc' : 'asc';
			} else {
				reportsSortColumn = column;
				reportsSortDirection = 'asc';
			}

			filteredReports.sort((a, b) => {
				let aVal = a[column] || '';
				let bVal = b[column] || '';

				// Handle timestamp sorting
				if (column === 'timestamp') {
					aVal = a[column] ? a[column].seconds : 0;
					bVal = b[column] ? b[column].seconds : 0;
				}

				if (aVal < bVal) return reportsSortDirection === 'asc' ? -1 : 1;
				if (aVal > bVal) return reportsSortDirection === 'asc' ? 1 : -1;
				return 0;
			});

			renderReports();
		};

		window.changeReportsPage = function(page) {
			const totalPages = Math.ceil(filteredReports.length / PAGE_SIZE);
			if (page >= 1 && page <= totalPages) {
				currentReportsPage = page;
				renderReports();
			}
		};

		function exportReportsToCSV() {
			const headers = ['Report ID', 'Box ID', 'Type', 'Status', 'Date', 'Details'];
			const rows = filteredReports.map(report => [
				report.id,
				report.boxId || '',
				report.reportType || '',
				report.status || '',
				report.timestamp ? new Date(report.timestamp.seconds * 1000).toLocaleString() : '',
				report.details || ''
			]);

			let csvContent = headers.join(',') + '\n';
			rows.forEach(row => {
				csvContent += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
			});

			const blob = new Blob([csvContent], { type: 'text/csv' });
			const url = URL.createObjectURL(blob);
			const link = document.createElement('a');
			link.href = url;
			link.download = `reports_${new Date().toISOString().split('T')[0]}.csv`;
			link.click();
			URL.revokeObjectURL(url);
		}

		// Load volunteers
		async function loadVolunteers() {
			try {
				const loadStart = performance.now();
				const volunteersPath = 'artifacts/toysfortots-eae4d/private/01/data/01/authorizedVolunteers';
				const volunteersRef = collection(db, volunteersPath);
				const snapshot = await getDocs(volunteersRef);
				const loadTime = Math.round(performance.now() - loadStart);

				allVolunteers = [];
				snapshot.forEach((doc) => {
					const data = doc.data();
					// Filter out soft-deleted items (unless root viewing deleted)
					if (data.deleted && !showingDeleted) return;
					allVolunteers.push({ id: doc.id, ...data });
				});

				document.getElementById('stat-volunteers').textContent = allVolunteers.length;
				document.getElementById('volunteers-loading').style.display = 'none';

				// Update last updated timestamp with cache indicator
				const now = new Date();
				const timeStr = now.toLocaleTimeString();
				const cacheIndicator = loadTime < 300 ? ' üöÄ (cached)' : '';
				document.getElementById('volunteers-last-updated').textContent =
					`Last updated: ${timeStr}${cacheIndicator} ‚Ä¢ ${loadTime}ms`;

				// Setup search
				const searchInput = document.getElementById('volunteers-search');
				searchInput.addEventListener('input', () => filterAndRenderVolunteers());

				// Setup export
				const exportBtn = document.getElementById('export-volunteers-btn');
				exportBtn.addEventListener('click', () => exportVolunteersToCSV());

				filterAndRenderVolunteers();
			} catch (error) {
				document.getElementById('volunteers-loading').style.display = 'none';
				document.getElementById('volunteers-error').textContent = 'Error loading volunteers: ' + error.message;
				document.getElementById('volunteers-error').style.display = 'block';
			}
		}

		function filterAndRenderVolunteers() {
			const searchTerm = document.getElementById('volunteers-search').value.toLowerCase();
			filteredVolunteers = allVolunteers.filter(volunteer => {
				return (
					volunteer.id.toLowerCase().includes(searchTerm) ||
					(volunteer.displayName || '').toLowerCase().includes(searchTerm)
				);
			});

			updateDeleteAllVolunteersButton();
			renderVolunteers();
		}

		function updateDeleteAllVolunteersButton() {
			const btn = document.getElementById('delete-all-volunteers-btn');
			// Count how many can be deleted (exclude current user)
			const deletableCount = filteredVolunteers.filter(v => v.id !== currentUser.uid).length;
			const searchTerm = document.getElementById('volunteers-search').value.trim();

			if (searchTerm) {
				btn.textContent = `Delete ${deletableCount} Volunteer${deletableCount !== 1 ? 's' : ''}`;
			} else {
				btn.textContent = 'Delete All Volunteers';
			}
			btn.disabled = deletableCount === 0;
		}

		function renderVolunteers() {
			const container = document.getElementById('volunteers-container');

			if (filteredVolunteers.length === 0) {
				container.innerHTML = '<p class="loading">No volunteers found.</p>';
				return;
			}

			// Pagination
			const totalPages = Math.ceil(filteredVolunteers.length / PAGE_SIZE);
			const startIndex = (currentVolunteersPage - 1) * PAGE_SIZE;
			const endIndex = startIndex + PAGE_SIZE;
			const pageData = filteredVolunteers.slice(startIndex, endIndex);

			let tableHTML = '<table class="data-table"><thead><tr style="text-align: center;">';
			tableHTML += '<th class="sortable" data-sort="displayName" onclick="sortVolunteers(\'displayName\')">Name</th>';
			tableHTML += '<th class="sortable" data-sort="isOAuth" onclick="sortVolunteers(\'isOAuth\')">OAuth</th>';
			tableHTML += '<th class="sortable" data-sort="boxes" onclick="sortVolunteers(\'boxes\')">Boxes</th>';
			tableHTML += '<th class="sortable" data-sort="undeployed" onclick="sortVolunteers(\'undeployed\')">Undeployed</th>';
			tableHTML += '<th class="sortable" data-sort="lastLogin" onclick="sortVolunteers(\'lastLogin\')">Last Seen</th>';
			tableHTML += '<th class="sortable" data-sort="pending" onclick="sortVolunteers(\'pending\')">Open</th>';
			tableHTML += '<th class="sortable" data-sort="resolved" onclick="sortVolunteers(\'resolved\')">Resolved</th>';
			tableHTML += '<th>Actions</th>';
			tableHTML += '</tr></thead><tbody>';

			pageData.forEach((volunteer) => {
				const isCurrentUser = volunteer.id === currentUser.uid;
				const escapedDisplayName = escapeHtml(volunteer.displayName || volunteer.email || 'N/A');
				const escapedDisplayNameForAttr = escapedDisplayName.replace(/'/g, "\\'");
				// Check if using OAuth (email not from custom domain @toysfortots.mcl1311.com)
				const isOAuth = volunteer.email && !volunteer.email.endsWith('@toysfortots.mcl1311.com');

				// Count boxes deployed by this volunteer
				const boxCount = allBoxes.filter(box => box.volunteer === volunteer.displayName).length;

				// Loose matching helper: checks if either string contains the other (case-insensitive)
				const looseMatch = (str1, str2) => {
					if (!str1 || !str2) return false;
					const s1 = str1.toLowerCase().trim();
					const s2 = str2.toLowerCase().trim();
					return s1.includes(s2) || s2.includes(s1);
				};

				// Count undeployed boxes (in Google Sheets assigned to this volunteer but not yet deployed)
				// Use loose matching: "Q" matches "Quincy", "Quincy" matches "Quincy Acklen"
				let undeployedCount = 0;
				locationSuggestions.forEach(suggestion => {
					// Check if this suggestion is assigned to this volunteer (loose match on contactName)
					const isAssignedToVolunteer = looseMatch(volunteer.displayName, suggestion.contactName);

					if (isAssignedToVolunteer) {
						// Check if this volunteer has already deployed this box
						const isDeployed = allBoxes.some(box =>
							box.volunteer === volunteer.displayName &&
							(box.label === suggestion.label || box.address === suggestion.address)
						);
						if (!isDeployed) {
							undeployedCount++;
						}
					}
				});

				// Format last login time
				let lastSeenText = 'Never';
				let lastSeenTooltip = '';
				if (volunteer.lastLogin) {
					const lastLoginDate = volunteer.lastLogin.seconds ? new Date(volunteer.lastLogin.seconds * 1000) : new Date(volunteer.lastLogin);
					const now = new Date();
					const diffMs = now - lastLoginDate;
					const diffMins = Math.floor(diffMs / 60000);
					const diffHours = Math.floor(diffMs / 3600000);
					const diffDays = Math.floor(diffMs / 86400000);

					// Create tooltip with full date and time
					lastSeenTooltip = lastLoginDate.toLocaleString();

					if (diffMins < 1) {
						lastSeenText = 'Just now';
					} else if (diffMins < 60) {
						lastSeenText = `${diffMins}m ago`;
					} else if (diffHours < 24) {
						lastSeenText = `${diffHours}h ago`;
					} else if (diffDays < 7) {
						lastSeenText = `${diffDays}d ago`;
					} else {
						lastSeenText = lastLoginDate.toLocaleDateString();
					}
				}

				// Calculate analytics: resolved actions and pending
				const analytics = volunteer.analytics || {};
				const resolvedCount = analytics.resolvedCount || 0;

				// Count pending reports for this volunteer's boxes
				const volunteerBoxIds = allBoxes.filter(box => box.volunteer === volunteer.displayName).map(box => box.id);
				const pendingCount = allReports.filter(report =>
					report.status === 'new' && volunteerBoxIds.includes(report.boxId)
				).length;

				tableHTML += '<tr>';
				tableHTML += `<td title="${escapeHtml(volunteer.id)}"><a href="/dashboard?volunteer=${encodeURIComponent(volunteer.displayName || volunteer.email || 'N/A')}" style="color: var(--marine-blue); text-decoration: underline;">${escapedDisplayName}</a></td>`;
				tableHTML += `<td style="text-align: center; font-size: 1.2rem;">${isOAuth ? '‚úì' : ''}</td>`;
				tableHTML += `<td style="text-align: center;"><a href="/dashboard?volunteer=${encodeURIComponent(volunteer.displayName || volunteer.email || 'N/A')}" style="color: var(--marine-blue); text-decoration: underline;">${boxCount}</a></td>`;
				tableHTML += `<td style="text-align: center;">${undeployedCount}</td>`;
				tableHTML += `<td title="${lastSeenTooltip}">${lastSeenText}</td>`;
				tableHTML += `<td style="text-align: center;">${pendingCount}</td>`;
				tableHTML += `<td style="text-align: center;">${resolvedCount}</td>`;
				tableHTML += `<td style="vertical-align: middle;"><div class="action-buttons">`;
				tableHTML += `<button class="edit-btn" data-volunteer-id="${escapeHtml(volunteer.id)}" ${isCurrentUser ? 'disabled' : ''}>Edit</button>`;
				tableHTML += `<button class="delete-btn" data-volunteer-id="${escapeHtml(volunteer.id)}" data-volunteer-name="${escapedDisplayNameForAttr}" ${isCurrentUser ? 'disabled' : ''}>Delete</button>`;
				tableHTML += `</div></td>`;
				tableHTML += '</tr>';
			});

			tableHTML += '</tbody></table>';
			container.innerHTML = tableHTML;

			// Add event listeners to buttons
			container.querySelectorAll('.edit-btn').forEach(btn => {
				if (!btn.disabled) {
					btn.addEventListener('click', () => {
						window.editVolunteer(btn.dataset.volunteerId);
					});
				}
			});
			container.querySelectorAll('.delete-btn').forEach(btn => {
				if (!btn.disabled) {
					btn.addEventListener('click', () => {
						window.deleteVolunteer(btn.dataset.volunteerId, btn.dataset.volunteerName);
					});
				}
			});

			// Update sort indicators
			if (volunteersSortColumn) {
				const header = container.querySelector(`th[data-sort="${volunteersSortColumn}"]`);
				if (header) {
					header.classList.remove('sortable');
					header.classList.add(volunteersSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
				}
			}

			// Render pagination
			const paginationContainer = document.getElementById('volunteers-pagination');
			if (totalPages > 1) {
				paginationContainer.style.display = 'flex';
				paginationContainer.innerHTML = `
					<button onclick="changeVolunteersPage(${currentVolunteersPage - 1})" ${currentVolunteersPage === 1 ? 'disabled' : ''}>Previous</button>
					<span class="page-info">Page ${currentVolunteersPage} of ${totalPages} (${filteredVolunteers.length} items)</span>
					<button onclick="changeVolunteersPage(${currentVolunteersPage + 1})" ${currentVolunteersPage === totalPages ? 'disabled' : ''}>Next</button>
				`;
			} else {
				paginationContainer.style.display = 'none';
			}
		}

		window.sortVolunteers = function(column) {
			if (volunteersSortColumn === column) {
				volunteersSortDirection = volunteersSortDirection === 'asc' ? 'desc' : 'asc';
			} else {
				volunteersSortColumn = column;
				volunteersSortDirection = 'asc';
			}

			filteredVolunteers.sort((a, b) => {
				let aVal, bVal;

				if (column === 'isOAuth') {
					// Sort by OAuth status (true/false based on email domain)
					aVal = a.email && !a.email.endsWith('@toysfortots.mcl1311.com') ? 1 : 0;
					bVal = b.email && !b.email.endsWith('@toysfortots.mcl1311.com') ? 1 : 0;
				} else if (column === 'lastLogin') {
					// Sort by last login timestamp (most recent first when desc)
					aVal = a.lastLogin ? (a.lastLogin.seconds || new Date(a.lastLogin).getTime() / 1000) : 0;
					bVal = b.lastLogin ? (b.lastLogin.seconds || new Date(b.lastLogin).getTime() / 1000) : 0;
				} else if (column === 'boxes') {
					// Sort by number of boxes deployed
					aVal = allBoxes.filter(box => box.volunteer === a.displayName).length;
					bVal = allBoxes.filter(box => box.volunteer === b.displayName).length;
				} else if (column === 'undeployed') {
					// Sort by number of undeployed boxes
					aVal = locationSuggestions.filter(s => !allBoxes.some(box => box.volunteer === a.displayName && (box.label === s.label || box.address === s.address))).length;
					bVal = locationSuggestions.filter(s => !allBoxes.some(box => box.volunteer === b.displayName && (box.label === s.label || box.address === s.address))).length;
				} else if (column === 'resolved') {
					// Sort by resolved count
					aVal = (a.analytics && a.analytics.resolvedCount) || 0;
					bVal = (b.analytics && b.analytics.resolvedCount) || 0;
				} else if (column === 'pending') {
					// Sort by pending count
					const aBoxIds = allBoxes.filter(box => box.volunteer === a.displayName).map(box => box.id);
					const bBoxIds = allBoxes.filter(box => box.volunteer === b.displayName).map(box => box.id);
					aVal = allReports.filter(report => report.status === 'new' && aBoxIds.includes(report.boxId)).length;
					bVal = allReports.filter(report => report.status === 'new' && bBoxIds.includes(report.boxId)).length;
				} else {
					aVal = a[column] || '';
					bVal = b[column] || '';
				}

				if (aVal < bVal) return volunteersSortDirection === 'asc' ? -1 : 1;
				if (aVal > bVal) return volunteersSortDirection === 'asc' ? 1 : -1;
				return 0;
			});

			renderVolunteers();
		};

		window.changeVolunteersPage = function(page) {
			const totalPages = Math.ceil(filteredVolunteers.length / PAGE_SIZE);
			if (page >= 1 && page <= totalPages) {
				currentVolunteersPage = page;
				renderVolunteers();
			}
		};

		function exportVolunteersToCSV() {
			const headers = ['Display Name', 'OAuth', 'Last Seen'];
			const rows = filteredVolunteers.map(volunteer => {
				const isOAuth = volunteer.email && !volunteer.email.endsWith('@toysfortots.mcl1311.com');
				let lastSeen = 'Never';
				if (volunteer.lastLogin) {
					const lastLoginDate = volunteer.lastLogin.seconds ? new Date(volunteer.lastLogin.seconds * 1000) : new Date(volunteer.lastLogin);
					lastSeen = lastLoginDate.toLocaleString();
				}
				return [
					volunteer.displayName || '',
					isOAuth ? 'Yes' : 'No',
					lastSeen
				];
			});

			let csvContent = headers.join(',') + '\n';
			rows.forEach(row => {
				csvContent += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
			});

			const blob = new Blob([csvContent], { type: 'text/csv' });
			const url = URL.createObjectURL(blob);
			const link = document.createElement('a');
			link.href = url;
			link.download = `volunteers_${new Date().toISOString().split('T')[0]}.csv`;
			link.click();
			URL.revokeObjectURL(url);
		}

		// Edit box
		window.editBox = async function(boxId) {
			currentEditBoxId = boxId;
			const docRef = doc(db, locationsCollectionPath, boxId);
			const docSnap = await getDocs(query(collection(db, locationsCollectionPath)));

			let boxData = null;
			docSnap.forEach((d) => {
				if (d.id === boxId) {
					boxData = d.data();
				}
			});

			if (!boxData) return;

			document.getElementById('edit-box-label').value = boxData.label || '';
			document.getElementById('edit-box-address').value = boxData.address || '';
			document.getElementById('edit-box-city').value = boxData.city || '';
			document.getElementById('edit-box-state').value = boxData.state || 'GA';
			document.getElementById('edit-box-contact-name').value = boxData.contactName || '';
			document.getElementById('edit-box-contact-phone').value = boxData.contactPhone || '';
			document.getElementById('edit-box-contact-email').value = boxData.contactEmail || '';

			// Display GPS coordinates and map link
			const coordinatesSpan = document.getElementById('edit-box-coordinates');
			const mapLink = document.getElementById('edit-box-map-link');

			if (boxData.lat && boxData.lon) {
				const lat = boxData.lat.toFixed(6);
				const lon = boxData.lon.toFixed(6);
				coordinatesSpan.textContent = `${lat}, ${lon}`;

				// Google Maps link
				mapLink.href = `https://www.google.com/maps?q=${lat},${lon}`;
				mapLink.style.display = 'inline';
			} else {
				coordinatesSpan.textContent = 'Not available';
				mapLink.style.display = 'none';
			}

			document.getElementById('edit-box-modal').classList.add('active');
		};

		// Save box changes
		document.getElementById('edit-box-form').addEventListener('submit', async (e) => {
			e.preventDefault();

			try {
				const docRef = doc(db, locationsCollectionPath, currentEditBoxId);
				await updateDoc(docRef, {
					label: document.getElementById('edit-box-label').value,
					address: document.getElementById('edit-box-address').value,
					city: document.getElementById('edit-box-city').value,
					state: document.getElementById('edit-box-state').value,
					contactName: document.getElementById('edit-box-contact-name').value,
					contactPhone: document.getElementById('edit-box-contact-phone').value,
					contactEmail: document.getElementById('edit-box-contact-email').value
				});

				document.getElementById('edit-box-modal').classList.remove('active');
				// Don't call loadBoxes() - the real-time listener will handle updates automatically
			} catch (error) {
				alert('Error updating box: ' + error.message);
			}
		});

		document.getElementById('edit-box-cancel').addEventListener('click', () => {
			document.getElementById('edit-box-modal').classList.remove('active');
		});

		// Soft delete box (admin only)
		window.deleteBox = function(boxId, label) {
			console.log('üîç DELETE DEBUG v2.0: deleteBox called', { boxId, label });
			showConfirmation(
				'Delete Box',
				`Soft delete "${label}"? This can be restored later by root users.`,
				async () => {
					try {
						console.log('üîç DELETE DEBUG: Starting delete operation', {
							boxId,
							label,
							userId: currentUser.uid,
							locationsCollectionPath
						});

						const docRef = doc(db, locationsCollectionPath, boxId);
						console.log('üîç DELETE DEBUG: Document reference created', {
							path: docRef.path,
							id: docRef.id
						});

						const updateData = {
							deleted: true,
							deletedAt: serverTimestamp(),
							deletedBy: currentUser.uid
						};
						console.log('üîç DELETE DEBUG: Update data prepared', updateData);

						console.log('üîç DELETE DEBUG: Calling updateDoc...');
						await updateDoc(docRef, updateData);
						console.log('üîç DELETE DEBUG: updateDoc SUCCESS!');

						// Log audit
						console.log('üîç DELETE DEBUG: Logging audit...');
						await logAudit(AUDIT_ACTIONS.DELETE_BOX, currentUser, {
							targetId: boxId,
							targetType: 'box',
							targetLabel: label
						});
						console.log('üîç DELETE DEBUG: Audit logged successfully');

						// Don't call loadBoxes() - the real-time listener will handle updates automatically
						console.log('üîç DELETE DEBUG: Delete operation completed successfully');
					} catch (error) {
						console.error('üîç DELETE DEBUG: Error caught!', {
							message: error.message,
							code: error.code,
							stack: error.stack,
							fullError: error
						});
						alert('Error deleting box: ' + error.message);
					}
				}
			);
		};

		// Soft delete all boxes (bulk)
		document.getElementById('delete-all-boxes-btn').addEventListener('click', () => {
			const deleteCount = filteredBoxes.length;
			const keepCount = allBoxes.length - deleteCount;
			const message = deleteCount === allBoxes.length
				? `‚ö†Ô∏è WARNING: This will soft delete ALL ${deleteCount} boxes. They can be restored by root users. Are you sure?`
				: `‚ö†Ô∏è WARNING: This will soft delete ${deleteCount} box${deleteCount !== 1 ? 'es' : ''} (${keepCount} box${keepCount !== 1 ? 'es' : ''} will NOT be deleted). Are you sure?`;

			showConfirmation(
				`Delete ${deleteCount} Box${deleteCount !== 1 ? 'es' : ''}`,
				message,
				async () => {
					try {
						const deletePromises = [];
						filteredBoxes.forEach((box) => {
							const docRef = doc(db, locationsCollectionPath, box.id);
							deletePromises.push(updateDoc(docRef, {
								deleted: true,
								deletedAt: serverTimestamp(),
								deletedBy: currentUser.uid
							}));
						});
						await Promise.all(deletePromises);

						// Log audit
						await logAudit(AUDIT_ACTIONS.DELETE_BOX_BULK, currentUser, {
							targetType: 'box',
							count: deleteCount
						});

						// Don't call loadBoxes() - the real-time listener will handle updates automatically
					} catch (error) {
						alert('Error deleting boxes: ' + error.message);
					}
				}
			);
		});

		// Soft delete report
		window.deleteReport = function(reportId) {
			showConfirmation(
				'Delete Report',
				'Soft delete this report? It can be restored later by root users.',
				async () => {
					try {
						const docRef = doc(db, reportsCollectionPath, reportId);
						await updateDoc(docRef, {
							deleted: true,
							deletedAt: serverTimestamp(),
							deletedBy: currentUser.uid
						});

						// Log audit
						await logAudit(AUDIT_ACTIONS.DELETE_REPORT, currentUser, {
							targetId: reportId,
							targetType: 'report'
						});

						// Don't call loadReports() - the real-time listener will handle updates automatically
					} catch (error) {
						alert('Error deleting report: ' + error.message);
					}
				}
			);
		};

		// Soft delete all reports (bulk)
		document.getElementById('delete-all-reports-btn').addEventListener('click', () => {
			const deleteCount = filteredReports.length;
			const keepCount = allReports.length - deleteCount;
			const message = deleteCount === allReports.length
				? `‚ö†Ô∏è WARNING: This will soft delete ALL ${deleteCount} reports. They can be restored by root users. Are you sure?`
				: `‚ö†Ô∏è WARNING: This will soft delete ${deleteCount} report${deleteCount !== 1 ? 's' : ''} (${keepCount} report${keepCount !== 1 ? 's' : ''} will NOT be deleted). Are you sure?`;

			showConfirmation(
				`Delete ${deleteCount} Report${deleteCount !== 1 ? 's' : ''}`,
				message,
				async () => {
					try {
						const deletePromises = [];
						filteredReports.forEach((report) => {
							const docRef = doc(db, reportsCollectionPath, report.id);
							deletePromises.push(updateDoc(docRef, {
								deleted: true,
								deletedAt: serverTimestamp(),
								deletedBy: currentUser.uid
							}));
						});
						await Promise.all(deletePromises);

						// Log audit
						await logAudit(AUDIT_ACTIONS.DELETE_REPORT_BULK, currentUser, {
							targetType: 'report',
							count: deleteCount
						});

						// Don't call loadReports() - the real-time listener will handle updates automatically
					} catch (error) {
						alert('Error deleting reports: ' + error.message);
					}
				}
			);
		});

		// Edit volunteer
		window.editVolunteer = async function(volunteerId) {
			if (volunteerId === currentUser.uid) {
				alert('You cannot edit your own account.');
				return;
			}

			currentEditVolunteerId = volunteerId;
			const volunteersPath = 'artifacts/toysfortots-eae4d/private/01/data/01/authorizedVolunteers';
			const docRef = doc(db, volunteersPath, volunteerId);
			const docSnap = await getDocs(query(collection(db, volunteersPath)));

			let volunteerData = null;
			docSnap.forEach((d) => {
				if (d.id === volunteerId) {
					volunteerData = d.data();
				}
			});

			if (!volunteerData) return;

			document.getElementById('edit-volunteer-name').value = volunteerData.displayName || '';
			document.getElementById('edit-volunteer-email').value = volunteerData.email || '';

			document.getElementById('edit-volunteer-modal').classList.add('active');
		};

		// Save volunteer changes
		document.getElementById('edit-volunteer-form').addEventListener('submit', async (e) => {
			e.preventDefault();

			try {
				const volunteersPath = 'artifacts/toysfortots-eae4d/private/01/data/01/authorizedVolunteers';
				const docRef = doc(db, volunteersPath, currentEditVolunteerId);
				await updateDoc(docRef, {
					displayName: document.getElementById('edit-volunteer-name').value
				});

				document.getElementById('edit-volunteer-modal').classList.remove('active');
				// Don't call loadVolunteers() - the real-time listener will handle updates automatically
			} catch (error) {
				alert('Error updating volunteer: ' + error.message);
			}
		});

		document.getElementById('edit-volunteer-cancel').addEventListener('click', () => {
			document.getElementById('edit-volunteer-modal').classList.remove('active');
		});

		// Delete volunteer
		// Soft delete volunteer (cannot delete self or root user)
		window.deleteVolunteer = async function(volunteerId, name) {
			if (volunteerId === currentUser.uid) {
				alert('You cannot delete your own account.');
				return;
			}

			// Check if target is root user
			try {
				const docRef = doc(db, authorizedVolunteersCollectionPath, volunteerId);
				const docSnap = await getDoc(docRef);
				if (docSnap.exists() && docSnap.data().role === 'root') {
					alert('Cannot delete root user (Quincy Acklen).');
					return;
				}
			} catch (error) {
				alert('Error checking volunteer: ' + error.message);
				return;
			}

			showConfirmation(
				'Delete Volunteer',
				`Soft delete volunteer "${name}"? This will remove their access but can be restored by root users.`,
				async () => {
					try {
						const docRef = doc(db, authorizedVolunteersCollectionPath, volunteerId);
						await updateDoc(docRef, {
							deleted: true,
							deletedAt: serverTimestamp(),
							deletedBy: currentUser.uid
						});

						// Log audit
						await logAudit(AUDIT_ACTIONS.DELETE_VOLUNTEER, currentUser, {
							targetId: volunteerId,
							targetType: 'volunteer',
							targetLabel: name
						});

						// Don't call loadVolunteers() - the real-time listener will handle updates automatically
					} catch (error) {
						alert('Error deleting volunteer: ' + error.message);
					}
				}
			);
		};

		// Soft delete all volunteers (bulk) - exclude self and root user
		document.getElementById('delete-all-volunteers-btn').addEventListener('click', () => {
			// Filter out self and root users
			const volunteersToDelete = filteredVolunteers.filter(v =>
				v.id !== currentUser.uid && v.role !== 'root'
			);
			const deleteCount = volunteersToDelete.length;
			const allDeletableCount = allVolunteers.filter(v => v.id !== currentUser.uid && v.role !== 'root').length;
			const keepCount = allDeletableCount - deleteCount;

			const message = deleteCount === allDeletableCount
				? `‚ö†Ô∏è WARNING: This will soft delete all ${deleteCount} volunteers EXCEPT you and root users. They can be restored. Are you sure?`
				: `‚ö†Ô∏è WARNING: This will soft delete ${deleteCount} volunteer${deleteCount !== 1 ? 's' : ''} (${keepCount} volunteer${keepCount !== 1 ? 's' : ''} will NOT be deleted, plus you and root users). Are you sure?`;

			showConfirmation(
				`Delete ${deleteCount} Volunteer${deleteCount !== 1 ? 's' : ''}`,
				message,
				async () => {
					try {
						const deletePromises = [];
						volunteersToDelete.forEach((volunteer) => {
							const docRef = doc(db, authorizedVolunteersCollectionPath, volunteer.id);
							deletePromises.push(updateDoc(docRef, {
								deleted: true,
								deletedAt: serverTimestamp(),
								deletedBy: currentUser.uid
							}));
						});
						await Promise.all(deletePromises);

						// Log audit
						await logAudit(AUDIT_ACTIONS.DELETE_VOLUNTEER_BULK, currentUser, {
							targetType: 'volunteer',
							count: deleteCount
						});

						// Don't call loadVolunteers() - the real-time listener will handle updates automatically
					} catch (error) {
						alert('Error deleting volunteers: ' + error.message);
					}
				}
			);
		});

		// Confirmation modal
		function showConfirmation(title, message, callback) {
			console.log('üîç CONFIRMATION DEBUG: Showing confirmation modal', { title, message });
			document.getElementById('modal-title').textContent = title;
			document.getElementById('modal-message').textContent = message;
			confirmCallback = callback;
			document.getElementById('confirmation-modal').classList.add('active');
		}

		document.getElementById('modal-confirm').addEventListener('click', async () => {
			console.log('üîç CONFIRMATION DEBUG: Confirm button clicked');
			document.getElementById('confirmation-modal').classList.remove('active');
			if (confirmCallback) {
				console.log('üîç CONFIRMATION DEBUG: Executing callback...');
				try {
					await confirmCallback();
					console.log('üîç CONFIRMATION DEBUG: Callback completed successfully');
				} catch (error) {
					console.error('üîç CONFIRMATION DEBUG: Callback error!', error);
				}
				confirmCallback = null;
			}
		});

		document.getElementById('modal-cancel').addEventListener('click', () => {
			document.getElementById('confirmation-modal').classList.remove('active');
			confirmCallback = null;
		});

		// ==================== RBAC: AUDIT LOGS ====================

		let allAuditLogs = [];
		let filteredAuditLogs = [];
		let currentAuditPage = 1;
		const AUDIT_PAGE_SIZE = 50;

		// Load audit logs (admin/root only)
		async function loadAuditLogs() {
			if (!['admin', 'root'].includes(currentUserRole)) return;

			const loading = document.getElementById('audit-loading');
			const error = document.getElementById('audit-error');
			const container = document.getElementById('audit-container');

			loading.style.display = 'block';
			error.style.display = 'none';
			container.innerHTML = '';

			try {
				const auditRef = collection(db, auditLogsCollectionPath);
				const q = query(auditRef, orderBy('timestamp', 'desc'));
				const snapshot = await getDocs(q);

				allAuditLogs = [];
				snapshot.forEach((doc) => {
					const data = doc.data();
					// Filter deleted logs unless showing deleted
					if (data.deleted && !showingDeleted) return;
					allAuditLogs.push({ id: doc.id, ...data });
				});

				loading.style.display = 'none';
				filterAndRenderAuditLogs();
			} catch (err) {
				loading.style.display = 'none';
				error.textContent = 'Error loading audit logs: ' + err.message;
				error.style.display = 'block';
			}
		}

		// Filter and render audit logs
		function filterAndRenderAuditLogs() {
			const searchTerm = document.getElementById('audit-search').value.toLowerCase();
			const actionFilter = document.getElementById('audit-action-filter').value;

			filteredAuditLogs = allAuditLogs.filter(log => {
				const matchesSearch = !searchTerm || (
					(log.userEmail || '').toLowerCase().includes(searchTerm) ||
					(log.userDisplayName || '').toLowerCase().includes(searchTerm) ||
					(log.action || '').toLowerCase().includes(searchTerm) ||
					(log.details?.targetLabel || '').toLowerCase().includes(searchTerm)
				);
				const matchesAction = !actionFilter || log.action === actionFilter;
				return matchesSearch && matchesAction;
			});

			renderAuditLogs();
		}

		// Render audit logs
		function renderAuditLogs() {
			const container = document.getElementById('audit-container');
			const pagination = document.getElementById('audit-pagination');

			if (filteredAuditLogs.length === 0) {
				container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No audit logs found.</p>';
				pagination.style.display = 'none';
				return;
			}

			const startIdx = (currentAuditPage - 1) * AUDIT_PAGE_SIZE;
			const endIdx = startIdx + AUDIT_PAGE_SIZE;
			const pageData = filteredAuditLogs.slice(startIdx, endIdx);

			let html = '<table class="data-table"><thead><tr>';
			html += '<th>Timestamp</th>';
			html += '<th>User</th>';
			html += '<th>Action</th>';
			html += '<th>Details</th>';
			html += '</tr></thead><tbody>';

			pageData.forEach(log => {
				const timestamp = log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString() : 'N/A';
				const user = escapeHtml(log.userDisplayName || log.userEmail || 'Unknown');
				const action = escapeHtml(log.action || 'unknown');

				let details = '';
				if (log.details) {
					if (log.details.targetLabel) {
						details += escapeHtml(log.details.targetLabel);
					} else if (log.details.count) {
						details += `${log.details.count} items`;
					}
					if (log.details.targetType) {
						details += ` (${escapeHtml(log.details.targetType)})`;
					}
				}

				html += `<tr>`;
				html += `<td>${timestamp}</td>`;
				html += `<td>${user}</td>`;
				html += `<td><span style="font-family: monospace; background: var(--gray-100); padding: 2px 6px; border-radius: 3px;">${action}</span></td>`;
				html += `<td>${details}</td>`;
				html += `</tr>`;
			});

			html += '</tbody></table>';
			container.innerHTML = html;

			// Pagination
			const totalPages = Math.ceil(filteredAuditLogs.length / AUDIT_PAGE_SIZE);
			if (totalPages > 1) {
				let paginationHtml = `<button ${currentAuditPage === 1 ? 'disabled' : ''} onclick="currentAuditPage--; renderAuditLogs();">Previous</button>`;
				paginationHtml += `<span class="page-info">Page ${currentAuditPage} of ${totalPages} (${filteredAuditLogs.length} total)</span>`;
				paginationHtml += `<button ${currentAuditPage === totalPages ? 'disabled' : ''} onclick="currentAuditPage++; renderAuditLogs();">Next</button>`;
				pagination.innerHTML = paginationHtml;
				pagination.style.display = 'flex';
			} else {
				pagination.style.display = 'none';
			}
		}

		// Event listeners for audit logs
		if (document.getElementById('audit-search')) {
			document.getElementById('audit-search').addEventListener('input', () => {
				currentAuditPage = 1;
				filterAndRenderAuditLogs();
			});
		}

		if (document.getElementById('audit-action-filter')) {
			document.getElementById('audit-action-filter').addEventListener('change', () => {
				currentAuditPage = 1;
				filterAndRenderAuditLogs();
			});
		}

		if (document.getElementById('refresh-audit-btn')) {
			document.getElementById('refresh-audit-btn').addEventListener('click', loadAuditLogs);
		}

		// ==================== RBAC: PURGE OPERATIONS (ROOT ONLY) ====================

		// Purge deleted boxes (hard delete)
		if (document.getElementById('purge-deleted-boxes-btn')) {
			document.getElementById('purge-deleted-boxes-btn').addEventListener('click', async () => {
				if (currentUserRole !== 'root') {
					alert('Only root users can purge data.');
					return;
				}

				const confirmed = confirm('‚ö†Ô∏è WARNING: This will PERMANENTLY delete all soft-deleted boxes. This action cannot be undone. Are you absolutely sure?');
				if (!confirmed) return;

				const resultDiv = document.getElementById('purge-result');
				resultDiv.style.display = 'block';
				resultDiv.className = 'loading';
				resultDiv.textContent = 'Purging deleted boxes...';

				try {
					const locationsRef = collection(db, locationsCollectionPath);
					const q = query(locationsRef, where('deleted', '==', true));
					const snapshot = await getDocs(q);

					const deletePromises = [];
					snapshot.forEach((doc) => {
						deletePromises.push(deleteDoc(doc.ref));
					});

					await Promise.all(deletePromises);

					// Log audit
					await logAudit(AUDIT_ACTIONS.PURGE_SOFT_DELETES, currentUser, {
						targetType: 'box',
						count: snapshot.size
					});

					resultDiv.className = 'success-message';
					resultDiv.textContent = `‚úÖ Successfully purged ${snapshot.size} deleted boxes.`;

					// Don't call loadBoxes() - the real-time listener will handle updates automatically
					setTimeout(() => resultDiv.style.display = 'none', 5000);
				} catch (error) {
					resultDiv.className = 'error-message';
					resultDiv.textContent = '‚ùå Error purging boxes: ' + error.message;
				}
			});
		}

		// Purge deleted reports
		if (document.getElementById('purge-deleted-reports-btn')) {
			document.getElementById('purge-deleted-reports-btn').addEventListener('click', async () => {
				if (currentUserRole !== 'root') {
					alert('Only root users can purge data.');
					return;
				}

				const confirmed = confirm('‚ö†Ô∏è WARNING: This will PERMANENTLY delete all soft-deleted reports. This action cannot be undone. Are you absolutely sure?');
				if (!confirmed) return;

				const resultDiv = document.getElementById('purge-result');
				resultDiv.style.display = 'block';
				resultDiv.className = 'loading';
				resultDiv.textContent = 'Purging deleted reports...';

				try {
					const reportsRef = collection(db, reportsCollectionPath);
					const q = query(reportsRef, where('deleted', '==', true));
					const snapshot = await getDocs(q);

					const deletePromises = [];
					snapshot.forEach((doc) => {
						deletePromises.push(deleteDoc(doc.ref));
					});

					await Promise.all(deletePromises);

					// Log audit
					await logAudit(AUDIT_ACTIONS.PURGE_SOFT_DELETES, currentUser, {
						targetType: 'report',
						count: snapshot.size
					});

					resultDiv.className = 'success-message';
					resultDiv.textContent = `‚úÖ Successfully purged ${snapshot.size} deleted reports.`;

					// Don't call loadReports() - the real-time listener will handle updates automatically
					setTimeout(() => resultDiv.style.display = 'none', 5000);
				} catch (error) {
					resultDiv.className = 'error-message';
					resultDiv.textContent = '‚ùå Error purging reports: ' + error.message;
				}
			});
		}

		// Purge deleted volunteers
		if (document.getElementById('purge-deleted-volunteers-btn')) {
			document.getElementById('purge-deleted-volunteers-btn').addEventListener('click', async () => {
				if (currentUserRole !== 'root') {
					alert('Only root users can purge data.');
					return;
				}

				const confirmed = confirm('‚ö†Ô∏è WARNING: This will PERMANENTLY delete all soft-deleted volunteers. This action cannot be undone. Are you absolutely sure?');
				if (!confirmed) return;

				const resultDiv = document.getElementById('purge-result');
				resultDiv.style.display = 'block';
				resultDiv.className = 'loading';
				resultDiv.textContent = 'Purging deleted volunteers...';

				try {
					const volunteersRef = collection(db, authorizedVolunteersCollectionPath);
					const q = query(volunteersRef, where('deleted', '==', true));
					const snapshot = await getDocs(q);

					const deletePromises = [];
					snapshot.forEach((doc) => {
						deletePromises.push(deleteDoc(doc.ref));
					});

					await Promise.all(deletePromises);

					// Log audit
					await logAudit(AUDIT_ACTIONS.PURGE_SOFT_DELETES, currentUser, {
						targetType: 'volunteer',
						count: snapshot.size
					});

					resultDiv.className = 'success-message';
					resultDiv.textContent = `‚úÖ Successfully purged ${snapshot.size} deleted volunteers.`;

					// Don't call loadVolunteers() - the real-time listener will handle updates automatically
					setTimeout(() => resultDiv.style.display = 'none', 5000);
				} catch (error) {
					resultDiv.className = 'error-message';
					resultDiv.textContent = '‚ùå Error purging volunteers: ' + error.message;
				}
			});
		}

		// Purge old audit logs (90+ days)
		if (document.getElementById('purge-audit-logs-btn')) {
			document.getElementById('purge-audit-logs-btn').addEventListener('click', async () => {
				if (currentUserRole !== 'root') {
					alert('Only root users can purge data.');
					return;
				}

				const confirmed = confirm('‚ö†Ô∏è WARNING: This will PERMANENTLY delete audit logs older than 90 days. This action cannot be undone. Are you absolutely sure?');
				if (!confirmed) return;

				const resultDiv = document.getElementById('purge-result');
				resultDiv.style.display = 'block';
				resultDiv.className = 'loading';
				resultDiv.textContent = 'Purging old audit logs...';

				try {
					const auditRef = collection(db, auditLogsCollectionPath);
					const ninetyDaysAgo = new Date();
					ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

					const snapshot = await getDocs(auditRef);

					const deletePromises = [];
					snapshot.forEach((doc) => {
						const data = doc.data();
						const timestamp = data.timestamp?.toDate();
						if (timestamp && timestamp < ninetyDaysAgo) {
							deletePromises.push(deleteDoc(doc.ref));
						}
					});

					await Promise.all(deletePromises);

					// Log audit (this won't be purged since it's new)
					await logAudit(AUDIT_ACTIONS.PURGE_AUDIT_LOGS, currentUser, {
						targetType: 'audit_log',
						count: deletePromises.length
					});

					resultDiv.className = 'success-message';
					resultDiv.textContent = `‚úÖ Successfully purged ${deletePromises.length} old audit logs.`;

					loadAuditLogs();
					setTimeout(() => resultDiv.style.display = 'none', 5000);
				} catch (error) {
					resultDiv.className = 'error-message';
					resultDiv.textContent = '‚ùå Error purging audit logs: ' + error.message;
				}
			});
		}

		// ==================== RBAC: SHOW DELETED TOGGLE (ROOT ONLY) ====================

		if (document.getElementById('show-deleted-checkbox')) {
			const checkbox = document.getElementById('show-deleted-checkbox');

			// Restore checkbox state from localStorage
			checkbox.checked = showingDeleted;

			checkbox.addEventListener('change', (e) => {
				showingDeleted = e.target.checked;

				// Save to localStorage
				localStorage.setItem('showingDeleted', showingDeleted);

				// Page refresh required to avoid duplicate listeners
				// (loadBoxes/loadReports/loadVolunteers create new onSnapshot listeners)
				window.location.reload();
			});
		}

		// Load audit logs for admins/root on init
		if (['admin', 'root'].includes(currentUserRole)) {
			setTimeout(loadAuditLogs, 1000); // Load after main data
		}
	</script>
</body>
</html>
