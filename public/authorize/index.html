<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: https: blob:; font-src 'self' data: https://unpkg.com; connect-src 'self' http://localhost:* ws://localhost:* http://127.0.0.1:* ws://127.0.0.1:* https://*.gstatic.com https://unpkg.com https://*.googleapis.com https://*.cloudfunctions.net https://*.firebaseapp.com https://*.firebaseio.com https://*.google.com https://tile.openstreetmap.org wss://*.firebaseio.com; frame-src 'self' https://*.google.com; object-src 'none'; base-uri 'self'; form-action 'self'">
		<meta name="description" content="Volunteer authorization for Toys for Tots. Complete registration to help coordinate donation boxes with Marine Corps League Detachment 1311 in North Metro Atlanta. Supporting the Marine Corps Reserve Toys for Tots program.">
		<title>Volunteer Authorization - Toys for Tots</title>
		<link rel="stylesheet" href="/css/style.min.css?v=1.0.7">
	</head>
	<body class="bg-gray-100">
		<div id="header-placeholder"></div>
		<div class="page-container">
			<div id="auth-container">
			<header>
				<h1>Volunteer Authorization</h1>
			</header>
			<div id="email-auth-section">
				<p id="auth-message" class="auth-message-spacing">
					Welcome! To complete your registration and access volunteer features, please enter the shared authorization code.
				</p>

				<form id="authorize-form">
					<div id="auth-msg"></div>
					<div>
						<label for="auth-code">Authorization Code</label>
						<input
							type="password"
							id="auth-code"
							placeholder="Enter shared code"
							autocomplete="off"
						>
						<span id="toggle-code" style="display: block; text-align: right; font-size: 0.875rem; color: #3b82f6; cursor: pointer; margin-top: 0.25rem;">
							Show code
						</span>
					</div>

					<button id="authorize-btn" type="submit" style="background-color: var(--t4t-green); border-color: var(--t4t-green);">
						Authorize Access
					</button>
				</form>

				<p style="margin-top: 1.5rem; font-size: 0.875rem; color: #6b7281;">
					Don't have an authorization code? Contact your local coordinator or administrator.
				</p>

				<button id="sign-out-btn" class="secondary-button" style="margin-top: 1rem; width: 100%;">
					Sign Out
				</button>
			</div>
			</div>
		</div>
		<div id="footer-placeholder"></div>
		<script src="/js/loader.min.js" defer></script>
		<script type="module">
		import { auth, functions, db, authorizedVolunteersCollectionPath } from '../js/firebase-init.js';
		import { onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
		import { httpsCallable } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js';
		import { doc, updateDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
		import { showAuthMessage, clearAuthMessage } from '/js/utils.min.js';

			const authCodeInput = document.getElementById('auth-code');
			const authorizeBtn = document.getElementById('authorize-btn');
			const toggleCode = document.getElementById('toggle-code');

			// Get return URL from query parameters (boxId or returnUrl)
			const urlParams = new URLSearchParams(window.location.search);
			const boxId = urlParams.get('boxId');
			const returnUrl = urlParams.get('returnUrl') || (boxId ? `/setup?id=${boxId}` : '/dashboard');

			// Toggle password visibility
			toggleCode.addEventListener('click', () => {
				if (authCodeInput.type === 'password') {
					authCodeInput.type = 'text';
					toggleCode.textContent = 'Hide code';
				} else {
					authCodeInput.type = 'password';
					toggleCode.textContent = 'Show code';
				}
			});

			async function handleAuthorize(e) {
				e.preventDefault();
				clearAuthMessage();

				const code = authCodeInput.value.trim();
				if (!code) {
					showAuthMessage('error', 'Please enter the authorization code.');
					return;
				}

				authorizeBtn.disabled = true;
				authorizeBtn.textContent = 'Authorizing...';

				try {
					const user = auth.currentUser;
					if (!user) {
						showAuthMessage('error', 'You must be signed in to authorize.');
						return;
					}

				// Call the authorize function with the code AND displayName from cookie
				// Check for signup cookie to preserve original username case
				const cookies = document.cookie.split('; ');
				const signupCookie = cookies.find(c => c.startsWith('signup_username='));
				const displayName = signupCookie ? decodeURIComponent(signupCookie.split('=')[1]) : null;
				
				console.log('Sending displayName to authorize function:', displayName);
				// Clear the signup cookie after using it
				if (displayName) {
					document.cookie = 'signup_username=; path=/; max-age=0';
				}
				
				const authorizeFunction = httpsCallable(functions, 'authorizeVolunteerV2');
				const result = await authorizeFunction({ code, displayName });

					if (result.data.success) {
						showAuthMessage('success', 'Authorization successful! Redirecting...');
						setTimeout(() => {
							window.location.href = returnUrl;
						}, 1000);
					} else {
						showAuthMessage('error', result.data.message || 'Authorization failed.');
						authorizeBtn.disabled = false;
						authorizeBtn.textContent = 'Authorize Access';
					}
				} catch (error) {
					console.error('Authorization error:', error);
					// Show more detailed error information
					let errorMessage = 'Authorization failed. Please check the code and try again.';
					if (error.code) {
						errorMessage = `Error (${error.code}): ${error.message}`;
					} else if (error.message) {
						errorMessage = error.message;
					}
					showAuthMessage('error', errorMessage);
					authorizeBtn.disabled = false;
					authorizeBtn.textContent = 'Authorize Access';
				}
			}

			// Check if user is already authorized
			let hasCheckedAuth = false;

			onAuthStateChanged(auth, async (user) => {
				if (!user || user.isAnonymous) {
					// Not signed in, redirect to login
					window.location.href = `/login?returnUrl=${encodeURIComponent('/authorize' + window.location.search)}`;
					return;

			}

		// Fix displayName for email auth users (background, non-blocking)
		if (user.email && user.email.includes('@toysfortots.mcl1311.com')) {
			// ALWAYS check for signup cookie first - if it exists, this is a fresh signup
			const cookies = document.cookie.split('; ');
			const signupCookie = cookies.find(c => c.startsWith('signup_username='));
			
			if (signupCookie) {
				// Fresh signup - use the original username from cookie (preserves exact case)
				const displayName = decodeURIComponent(signupCookie.split('=')[1]);
				// Clear the cookie after using it
				// Cookie will be cleared after authorizeVolunteerV2 function uses it
				
				console.log('Setting displayName from signup cookie:', displayName);
				
				// Update BOTH Firebase Auth AND Firestore
				updateProfile(user, { displayName })
					.then(() => console.log('Auth displayName updated'))
					.catch(err => console.error('Failed to update Auth displayName:', err));
				
			} else if (!user.displayName || user.displayName.includes('@toysfortots.mcl1311.com')) {
				// Fallback for existing users: fix if displayName is missing or contains domain
				const emailUsername = user.email.split('@')[0];
				const displayName = emailUsername.replace(/_/g, ' ');
				
				console.log('Fixing displayName from email:', displayName);
				
				updateProfile(user, { displayName })
					.catch(err => console.error('Failed to update Auth displayName:', err));
				
				const userDocRef = doc(db, authorizedVolunteersCollectionPath, user.uid);
				updateDoc(userDocRef, { displayName })
					.catch(err => console.error('Failed to update Firestore displayName:', err));
			}
		}


				// Guard against multiple auth checks (updateProfile triggers onAuthStateChanged again)
				if (hasCheckedAuth) return;
				hasCheckedAuth = true;

				// Check if already authorized
				try {
					const checkAuth = httpsCallable(functions, 'isAuthorizedVolunteerV2');
					const result = await checkAuth();
					if (result.data.isAuthorized) {
						// Already authorized, redirect to return URL
						showAuthMessage('success', 'You are already authorized! Redirecting...');
						setTimeout(() => {
							window.location.href = returnUrl;
						}, 1000);
					}
				} catch (err) {
					console.error('Error checking authorization:', err);
				}
			});

			document.getElementById('authorize-form').addEventListener('submit', handleAuthorize);

			// Clear error message when user starts typing
			authCodeInput.addEventListener('input', clearAuthMessage);

			// Sign out button
			document.getElementById('sign-out-btn').addEventListener('click', async () => {
				try {
					await signOut(auth);
					window.location.href = '/login';
				} catch (error) {
					console.error('Sign out error:', error);
					showAuthMessage('error', 'Failed to sign out. Please try again.');
				}
			});
		</script>
	</body>
</html>
