<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: https: blob:; font-src 'self' data: https://unpkg.com; connect-src 'self' http://localhost:* ws://localhost:* https://*.gstatic.com https://unpkg.com https://*.googleapis.com https://*.cloudfunctions.net https://*.firebaseapp.com https://*.firebaseio.com https://*.google.com https://tile.openstreetmap.org wss://*.firebaseio.com; frame-src 'self' https://*.google.com; object-src 'none'; base-uri 'self'; form-action 'self'">
		<meta name="description" content="Volunteer dashboard for Toys for Tots donation box management. Marine Corps League Detachment 1311 volunteers coordinate box pickups and handle issues for the Marine Corps Reserve Toys for Tots program in North Metro Atlanta.">
		<title>My Dashboard</title>
		<link rel="stylesheet" href="/css/style.min.css?v=1.0.7">
	</head>
	<body class="bg-gray-100">
		<div id="header-placeholder"></div>

		<main class="page-container">
			<div id="main-content" style="display: none;">
				<div class="dashboard-header-container">
				<div class="dashboard-header-flex">
					<div>
						<h1>Dashboard</h1>
					</div>
					<div class="dashboard-header-controls">
						<label for="view-filter">Show boxes:</label>
						<select id="view-filter">
						</select>
					</div>
				</div>
				<section id="boxes-section">
					<h2 id="boxes-title">Loading...</h2>
					<div id="boxes-container">
						<p id="loading-message">Loading reports...</p>
					</div>
				</section>
			</div>
			</div>
		</main>

		<div id="footer-placeholder"></div>
		<script src="/js/loader.min.js" defer></script>
		<script type="module">
			import { auth, db, functions, reportsCollectionPath, locationsCollectionPath } from '../js/firebase-init.js';
			import {
				onAuthStateChanged,
				signOut
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
			import {
				collection,
				getDocs,
				query,
				orderBy,
				where,
				doc,
				setDoc,
				updateDoc,
				getDoc,
				increment,
				addDoc,
				serverTimestamp
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
			import {
				httpsCallable
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js';
			let isAuthorizedVolunteer;

			const setupFirebase = () =>
			{
				try
				{
					isAuthorizedVolunteer = httpsCallable( functions, 'isAuthorizedVolunteerV2' );
					onAuthStateChanged( auth, async( user ) =>
					{
						if( user && !user.isAnonymous )
						{
							try
							{
								const result = await isAuthorizedVolunteer( { uid: user.uid } );
								if( result.data.isAuthorized )
								{
									let displayName = result.data.displayName || user.email;
								// Strip @domain from email addresses
								const atIndex = displayName.indexOf( '@' );
								if( atIndex !== -1 )
								{
									displayName = displayName.substring( 0, atIndex );
								}
									document.getElementById( 'main-content' ).style.display = 'block';
									window.initApp( user, displayName );
								}
								else
								{
									// User is signed in but not authorized - redirect to login
									window.location.href = '/login?returnUrl=' + encodeURIComponent( window.location.pathname );
								}
							}
							catch( err )
							{
								console.error( 'Authorization check failed:', err );
								// Redirect to login on error
								window.location.href = '/login?returnUrl=' + encodeURIComponent( window.location.pathname );
							}
						}
						else
						{
							// User is not authenticated - redirect to login
							window.location.href = '/login?returnUrl=' + encodeURIComponent( window.location.pathname );
						}
					} );
				}
				catch( error )
				{
					console.error( 'Firebase Initialization Error:', error );
				}
			};

			// XSS Protection: Escape HTML to prevent script injection
			const escapeHtml = (unsafe) => {
				if (!unsafe) return '';
				return String(unsafe)
					.replace(/&/g, '&amp;')
					.replace(/</g, '&lt;')
					.replace(/>/g, '&gt;')
					.replace(/"/g, '&quot;')
					.replace(/'/g, '&#039;');
			};

			const renderBoxCard = ( box ) =>
			{
				const STATUS_RESOLVED_TEXT = 'Resolved'; // Variable for status text
				let statusHtml;
				if( box.latestPendingReport )
				{
					const report = box.latestPendingReport;
					const isProblem = report.reportType.includes( 'problem' );
					const reportTypeDisplay = escapeHtml(report.reportType).replace( /_/g, ' ' );
					const reportDesc = escapeHtml(report.description || report.notes || 'No details provided.');
					statusHtml = `
                    <div class="status-problem">
                        <p class="status-title ${ isProblem ? '' : 'text-yellow-700' }">
                            Status: ${ reportTypeDisplay }
                        </p>
                        <p class="status-desc">${ reportDesc }</p>
                        <button
                            class="clear-status-btn"
                            data-report-id="${ escapeHtml(report.id) }">
                            Mark as ${ STATUS_RESOLVED_TEXT }
                        </button>
                    </div>
                `;
				}
				else
				{
					statusHtml = `
                    <div class="status-good">
                        <p class="status-title">Status: Good</p>
                        <p class="status-desc">All reports are ${ STATUS_RESOLVED_TEXT.toLowerCase() }.</p>
                    </div>
                `;
				}
				return `
                <div class="box-card">
                    <div>
                        <h3>${ escapeHtml(box.label) }</h3>
                        <p class="address">${ escapeHtml(box.address) }, ${ escapeHtml(box.city) }</p>
                        <p class="box-id">ID: ${ escapeHtml(box.boxId) }</p>
                    </div>
                    <div class="status-wrapper">
                        ${ statusHtml }
                    </div>
                    <a href="/status/?id=${ encodeURIComponent(box.boxId) }" class="view-history-btn">
                        View Full History
                    </a>
                </div>
            `;
			};
			let allBoxesMap = new Map();
			let currentUserId = null;
			const renderDashboard = ( filterKey ) =>
			{
				const boxesContainer = document.getElementById( 'boxes-container' );
				const boxesTitle = document.getElementById( 'boxes-title' );
				boxesContainer.innerHTML = '';
				let boxesToRender = [];
				if( filterKey === 'all_boxes' )
				{
					boxesToRender = Array.from( allBoxesMap.values() );
					boxesTitle.textContent = 'All Box Statuses';
				}
				else
				{
					boxesTitle.textContent = `${ filterKey }'s Boxes`;
					allBoxesMap.forEach( box =>
					{
						if( box.volunteer === filterKey )
						{
							boxesToRender.push( box );
						}
					} );
				}
				if( boxesToRender.length === 0 )
				{
					boxesContainer.innerHTML = '<p style="text-align: center; color: #4b5563; padding: 1rem;">No reports have been filed for any boxes yet.</p>';
					return;
				}
				let html = '';
				boxesToRender.sort( ( a, b ) => a.label.localeCompare( b.label ) );
				boxesToRender.forEach( box =>
				{
					html += renderBoxCard( box );
				} );
				boxesContainer.innerHTML = html;
			};
			window.initApp = async( user, displayName ) =>
			{
				currentUserId = user.uid;
				const currentUserDisplayName = displayName;
				const boxesContainer = document.getElementById( 'boxes-container' );
				const loadingMessage = document.getElementById( 'loading-message' );
				const filterSelect = document.getElementById( 'view-filter' );
				try
				{
					// Get all locations
					const locationsRef = collection( db, locationsCollectionPath );
					const locationsSnapshot = await getDocs( locationsRef );
					loadingMessage.remove();
					if( locationsSnapshot.empty )
					{
						document.getElementById( 'boxes-title' ).textContent = 'Box Statuses';
						boxesContainer.innerHTML = '<p style="text-align: center; color: #4b5563; padding: 1rem;">No reports have been filed for any boxes yet.</p>';
						return;
					}
					const volunteerNames = new Set();
					allBoxesMap.clear();

					// Build boxes map from locations
					locationsSnapshot.forEach( doc =>
					{
						const location = doc.data();
						const boxId = doc.id;
						if( location.volunteer )
						{
							volunteerNames.add( location.volunteer );
						}
						allBoxesMap.set( boxId, {
							boxId: boxId,
							label: location.label || 'Unnamed Location',
							address: location.address || '',
							city: location.city || '',
							latestPendingReport: null,
							provisionedBy: location.provisionedBy,
							volunteer: location.volunteer
						} );
					} );

					// Get all reports to find latest pending for each box
					const reportsRef = collection( db, reportsCollectionPath );
					const reportsQuery = query( reportsRef, orderBy( 'timestamp', 'desc' ) );
					const reportsSnapshot = await getDocs( reportsQuery );

					reportsSnapshot.forEach( doc =>
					{
						const report = { id: doc.id, ...doc.data() };
						const boxId = report.boxId;
						const box = allBoxesMap.get( boxId );

						if( box && report.status === 'new' && !box.latestPendingReport )
						{
							box.latestPendingReport = report;
						}
					} );
					filterSelect.innerHTML = `
                    <option value="${ currentUserDisplayName }">My Boxes</option>
                    <option value="all_boxes">All Boxes</option>
                    <option value="" disabled>--- Filter by Volunteer ---</option>
                `;
					const sortedNames = Array.from( volunteerNames ).sort();
					sortedNames.forEach( name =>
					{
						// Skip current user since they already have "My Boxes" option
						if( name !== currentUserDisplayName )
						{
							const option = document.createElement( 'option' );
							option.value = name;
							option.textContent = name;
							filterSelect.appendChild( option );
						}
					} );
					filterSelect.addEventListener( 'change', ( e ) =>
					{
						renderDashboard( e.target.value );
					} );

					// Check for volunteer query parameter (from admin "View Boxes" link)
					const urlParams = new URLSearchParams( window.location.search );
					const volunteerParam = urlParams.get( 'volunteer' );

					if( volunteerParam )
					{
						// Try to find matching volunteer in dropdown
						const options = Array.from( filterSelect.options );
						const matchingOption = options.find( opt => opt.value === volunteerParam );

						if( matchingOption )
						{
							filterSelect.value = volunteerParam;
							renderDashboard( volunteerParam );
						}
						else
						{
							// Volunteer not found, show my boxes
							renderDashboard( currentUserDisplayName );
						}
					}
					else
					{
						renderDashboard( currentUserDisplayName );
					}
				}
				catch( error )
				{
					console.error( 'Error fetching reports:', error );
					loadingMessage.innerHTML = `<p style="text-align: center; color: var(--t4t-red); font-weight: 700; padding: 1rem;">Error loading reports: ${ error.message }</p>`;
				}
			};
			document.getElementById( 'main-content' ).addEventListener( 'click', async( e ) =>
			{
				if( e.target && e.target.classList.contains( 'clear-status-btn' ) )
				{
					const STATUS_RESOLVED_TEXT = 'Resolved'; // Variable for status text
					const button = e.target;
					const reportId = button.dataset.reportId;
					button.disabled = true;
					button.textContent = 'Resolving...';
					try
					{
						const reportRef = doc( db, reportsCollectionPath, reportId );

						// Get report data before updating to track analytics
						const reportSnap = await getDoc(reportRef);
						const reportData = reportSnap.exists() ? reportSnap.data() : null;

						// Update report status
						await updateDoc( reportRef, {
							status: 'cleared'
						} );

						// Track volunteer action analytics (Hybrid: aggregates + events)
						if (reportData && auth.currentUser) {
							const volunteersPath = 'artifacts/toysfortots-eae4d/private/01/data/01/authorizedVolunteers';
							const volunteerRef = doc(db, volunteersPath, auth.currentUser.uid);

							console.log('[ANALYTICS] Incrementing resolvedCount for user:', auth.currentUser.uid);
							console.log('[ANALYTICS] Volunteer ref path:', volunteersPath + '/' + auth.currentUser.uid);

							// Update aggregate count (use setDoc with merge to create field if it doesn't exist)
							await setDoc(volunteerRef, {
								analytics: {
									resolvedCount: increment(1)
								}
							}, { merge: true });

							console.log('[ANALYTICS] setDoc completed successfully');

							// Store detailed event for historical tracking
							const actionsPath = `${volunteersPath}/${auth.currentUser.uid}/actions`;
							await addDoc(collection(db, actionsPath), {
								actionType: reportData.reportType === 'pickup_alert' ? 'resolve_pickup' : 'resolve_problem',
								reportId: reportId,
								boxId: reportData.boxId,
								timestamp: serverTimestamp()
							});
						}

						location.reload();
					}
					catch( err )
					{
						console.error( 'Error resolving status: ', err );
						alert( 'Error resolving status. Please try again.' );
						button.disabled = false;
						button.textContent = `Mark as ${ STATUS_RESOLVED_TEXT }`;
					}
				}
			} );
			setupFirebase();
		</script>
	</body>
</html>
