<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Volunteer Dashboard</title>
		<script type="module">
			// --- 1. IMPORTS (Added getDocs, query, where, orderBy, updateDoc, writeBatch) ---
			import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
			import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
			import { getFirestore, collection, getDocs, query, where, orderBy, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

			// --- 2. CONFIG & TOP-LEVEL VARS ---
			const firebaseConfig = {
				apiKey: "AIzaSyC3-oZseVLWFYFbmjAFEgQ-I6hNOgiPj9w",
				authDomain: "toysfortots-eae4d.firebaseapp.com",
				projectId: "toysfortots-eae4d",
				storageBucket: "toysfortots-eae4d.firebasestorage.app",
				messagingSenderId: "505039956655",
				appId: "1:505039956655:web:c750c66b28f7facd82025a",
				measurementId: "G-XKQYPK0GLC"
			};
			const appId = firebaseConfig.projectId;
			let db, auth;
			let appDB, appAuth, appID;

			// --- 3. FIREBASE SETUP ---
			const publicDocumentId = "3USFkKsJe7T8ZYdW5YfE";
			const dataDocumentId = "EF1QWEKWPMuoLN7fC4Ri";
			let reportsCollectionRef; // We'll define this in initApp

			const setupFirebase = () => {
				console.log("Setting up Firebase...");
				try {
					const app = initializeApp(firebaseConfig);
					auth = getAuth(app);
					db = getFirestore(app);

					let appInitialized = false;
					onAuthStateChanged(auth, (user) => {
						if (user && !appInitialized) {
							appInitialized = true;
							window.initApp(appId, db, auth);
						} else if (!user) {
							signInAnonymously(auth).catch((err) => {
								console.error("Anonymous sign-in failed:", err);
							});
						}
					});
				} catch (error) {
					console.error("Firebase Initialization Error:", error);
				}
			};

			// --- 4. HELPER FUNCTIONS ---
			const formatDate = (isoString) => {
				if (!isoString) return 'No date';
				const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
				return new Date(isoString).toLocaleString(undefined, options);
			};

			const renderBoxCard = (box) => {
				const isPending = box.pendingReports.length > 0;
				const statusColor = isPending ? 'red' : 'green';
				const statusText = isPending ? `PENDING (${box.pendingReports.length})` : 'OK';

				// Get the most recent report's description, if one exists
				let recentActivity = 'No reports yet.';
				if (box.allReports.length > 0) {
					const mostRecentReport = box.allReports[0]; // Already sorted
					recentActivity = `<b>${mostRecentReport.reportType}:</b> ${formatDate(mostRecentReport.timestamp)}`;
				}

				return `
                <div class="box-card bg-white p-4 rounded-lg border border-gray-200 shadow-md mb-4" data-box-id="${box.boxId}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-bold text-tots-red">${box.label}</h3>
                            <p class="text-sm text-gray-600">${box.address}</p>
                            <p class="text-xs text-gray-500 mt-1">ID: ${box.boxId}</p>
                        </div>
                        <span class="status-badge text-xs font-bold py-1 px-2 rounded-full bg-${statusColor}-100 text-${statusColor}-700 border border-${statusColor}-300">
                            ${statusText}
                        </span>
                    </div>
                    <p class="text-sm text-gray-800 mt-3">
                        <strong>Recent Activity:</strong> ${recentActivity}
                    </p>
                    <div class="flex gap-2 mt-4">
                        <a href="box.html?id=${box.boxId}" class="flex-1 text-center py-2 px-3 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-md transition duration-200">
                            View History
                        </a>
                        ${isPending ? `
                        <button class="clear-status-btn flex-1 py-2 px-3 bg-tots-green hover:bg-green-700 text-white text-sm font-semibold rounded-md transition duration-200" data-box-id="${box.boxId}">
                            Clear Status
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
			};

			// --- 5. MAIN APP LOGIC ---
			window.initApp = async (appId, dbInstance, authInstance) => {
				appDB = dbInstance;
				appAuth = authInstance;
				appID = appId;

				const loadingMessage = document.getElementById('loading-message');
				const volunteerNameEl = document.getElementById('volunteer-name');
				const pendingBoxesContainer = document.getElementById('pending-boxes-container');
				const allBoxesContainer = document.getElementById('all-boxes-container');

				const params = new URLSearchParams(window.location.search);
				const volunteerName = params.get('volunteer');

				if (!volunteerName) {
					loadingMessage.textContent = "Error: Volunteer name missing from URL.";
					loadingMessage.className = 'text-center text-tots-red font-bold p-4';
					return;
				}

				volunteerNameEl.textContent = volunteerName;
				reportsCollectionRef = collection(appDB, 'artifacts', appID, "public", publicDocumentId, "data", dataDocumentId, 'totsReports');

				try {
					// 1. Query all reports for this volunteer, sorted by time
					const q = query(reportsCollectionRef,
							where("volunteer", "==", volunteerName),
							orderBy("timestamp", "desc")
					);

					const querySnapshot = await getDocs(q);
					loadingMessage.remove();

					if (querySnapshot.empty) {
						allBoxesContainer.innerHTML = '<p class="text-gray-600">No boxes found for this volunteer.</p>';
						return;
					}

					// 2. Process reports into a map of boxes
					const boxes = new Map();
					const allPendingReports = []; // To hold reports that need clearing

					querySnapshot.forEach(docSnap => {
						const report = { id: docSnap.id, ...docSnap.data() };
						const boxId = report.boxId;

						// Initialize box if it's not in the map
						if (!boxes.has(boxId)) {
							boxes.set(boxId, {
								boxId: boxId,
								label: report.label,
								address: `${report.address}, ${report.city}`,
								allReports: [],
								pendingReports: []
							});
						}

						// Add report to the correct lists
						const box = boxes.get(boxId);
						box.allReports.push(report);
						if (report.status === 'new') {
							box.pendingReports.push(report);
							allPendingReports.push(report); // Add to master pending list
						}
					});

					// 3. Render boxes
					let pendingHtml = '';
					let allBoxesHtml = '';

					if (boxes.size === 0) {
						allBoxesContainer.innerHTML = '<p class="text-gray-600">No boxes assigned to this volunteer.</p>';
					}

					boxes.forEach(box => {
						const cardHtml = renderBoxCard(box);
						allBoxesHtml += cardHtml;
						if (box.pendingReports.length > 0) {
							pendingHtml += cardHtml;
						}
					});

					if (pendingHtml === '') {
						pendingBoxesContainer.innerHTML = '<p class="text-sm text-gray-500 text-center p-4 bg-green-50 rounded-lg border">No pending actions. Great job!</p>';
					} else {
						pendingBoxesContainer.innerHTML = pendingHtml;
					}
					allBoxesContainer.innerHTML = allBoxesHtml;

					// 4. Add event listeners for "Clear Status" buttons
					document.body.addEventListener('click', async (e) => {
						if (e.target && e.target.classList.contains('clear-status-btn')) {
							const button = e.target;
							const boxId = button.dataset.boxId;

							button.disabled = true;
							button.textContent = 'Clearing...';

							// Find all pending reports for THIS box
							const reportsToClear = allPendingReports.filter(r => r.boxId === boxId);

							if (reportsToClear.length === 0) {
								console.warn("No reports to clear, but button was clicked.");
								button.textContent = 'Already Cleared';
								return;
							}

							try {
								// Use a batch write to update all at once
								const batch = writeBatch(appDB);
								reportsToClear.forEach(report => {
									const reportRef = doc(reportsCollectionRef, report.id);
									batch.update(reportRef, { status: "cleared" });
								});

								await batch.commit();

								// Easiest way to update UI is to refresh
								location.reload();

								// // Fancier way (no reload):
								// button.closest('.box-card').querySelector('.status-badge').textContent = 'OK';
								// button.closest('.box-card').querySelector('.status-badge').className = 'status-badge text-xs font-bold py-1 px-2 rounded-full bg-green-100 text-green-700 border border-green-300';
								// button.remove();
								// // Also remove from "Pending" section
								// const pendingCard = pendingBoxesContainer.querySelector(`[data-box-id="${boxId}"]`);
								// if (pendingCard) pendingCard.remove();

							} catch (err) {
								console.error("Error clearing status: ", err);
								alert("Error clearing status. Please try again.");
								button.disabled = false;
								button.textContent = 'Clear Status';
							}
						}
					});

				} catch (error) {
					console.error("Error fetching reports:", error);
					loadingMessage.textContent = `Error loading reports: ${error.message}`;
					loadingMessage.className = 'text-center text-tots-red font-bold p-4';
				}
			};

			// --- 6. EXPOSE SETUP FUNCTION ---
			window.setupFirebase = setupFirebase;
		</script>
		<script src="https://cdn.tailwindcss.com"></script>
		<script>
			tailwind.config = {
				theme: {
					extend: {
						fontFamily: { sans: ['Inter', 'sans-serif'] },
						colors: {
							'tots-red': '#cc0000',
							'tots-green': '#008000',
							'tots-light': '#fcebeb',
						}
					}
				}
			}
		</script>
	</head>
	<body class="bg-gray-100 font-sans" onload="setupFirebase()">

		<div class="max-w-2xl mx-auto">
			<header class="bg-tots-red p-6 mt-6 rounded-t-xl shadow-lg">
				<h1 class="text-3xl font-extrabold text-white text-center">Volunteer Dashboard</h1>
				<p class="text-center text-red-100 text-lg mt-1">
					Welcome, <span id="volunteer-name" class="font-bold">...</span>
				</p>
			</header>

			<main class="p-4 md:p-6 bg-gray-50 shadow-lg rounded-b-xl">

				<section id="pending-actions" class="mb-8">
					<h2 class="text-2xl font-bold text-gray-800 border-b-2 border-tots-red pb-2 mb-4">
						Pending Actions
					</h2>
					<div id="pending-boxes-container">
						<p id="loading-message" class="text-center text-gray-500">Loading pending reports...</p>
					</div>
				</section>

				<section id="all-boxes">
					<h2 class="text-2xl font-bold text-gray-800 border-b-2 border-gray-300 pb-2 mb-4">
						All My Boxes
					</h2>
					<div id="all-boxes-container">
					</div>
				</section>

			</main>
		</div>
	</body>
</html>