<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>My Dashboard</title>
		<link rel="stylesheet" href="/style.css?v=1.0.7">
	</head>

	<body class="bg-gray-100">

		<div id="header-placeholder"></div>

		<div id="auth-container" style="display: none;">
			<header>
				<h1>Volunteer Access</h1>
			</header>

			<div id="auth-buttons">
				<div id="email-auth-section">
					<h2 id="email-auth-title">Sign In with Email</h2>

					<div>
						<label for="auth-email" class="sr-only">Email Address</label>
						<input type="email" id="auth-email" placeholder="Email Address">
					</div>
					<div>
						<label for="auth-password" class="sr-only">Password</label>
						<input type="password" id="auth-password" placeholder="Password">
					</div>

					<button id="email-sign-in-btn">
						Sign In
					</button>
					<button id="email-sign-up-btn" class="hidden">
						Create Account
					</button>

					<p>
						<button id="toggle-sign-up-btn">
							New user? <span>Create an account</span>
						</button>
					</p>
				</div>

				<div id="or-divider">-- OR --</div>

				<p id="auth-message">Please sign in to access the dashboard.</p>

				<button id="google-login-btn">
					Sign In with Google
				</button>
			</div>
		</div>
		<div id="main-content" style="display: none;">

			<div class="dashboard-header-container">
				<div class="dashboard-header-flex">
					<div>
						<h1>Dashboard</h1>
						<p class="welcome-text">Welcome,
							<span id="volunteer-name">...</span>
						</p>
					</div>
					<div class="dashboard-header-controls">
						<label for="view-filter">Show boxes:</label>
						<select id="view-filter">
						</select>
						<button id="sign-out-btn">
							Sign Out
						</button>
					</div>
				</div>

				<section id="boxes-section">
					<h2 id="boxes-title">Loading...</h2>
					<div id="boxes-container">
						<p id="loading-message">Loading reports...</p>
					</div>
				</section>
			</div>
		</div>

		<div id="footer-placeholder"></div>

		<script src="/loader.js" defer></script>

		<script type="module">
			// --- 1. IMPORTS ---
			import { auth, db, functions, reportsCollectionPath } from '../js/firebase-init.js';
			import {
				onAuthStateChanged,
				GoogleAuthProvider,
				getRedirectResult,
				signOut,
				signInWithPopup,
				createUserWithEmailAndPassword,
				signInWithEmailAndPassword
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
			import {
				collection,
				getDocs,
				query,
				orderBy,
				doc,
				updateDoc
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
			import {
				httpsCallable
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js';

			// --- 2. CONFIG & TOP-LEVEL VARS ---
			let isAuthorizedVolunteer; // Global reference to the callable function

			// --- DOM ELEMENTS ---
			const emailAuthTitle = document.getElementById('email-auth-title');
			const authEmail = document.getElementById('auth-email');
			const authPassword = document.getElementById('auth-password');
			const emailSignInBtn = document.getElementById('email-sign-in-btn');
			const emailSignUpBtn = document.getElementById('email-sign-up-btn');
			const toggleSignUpBtn = document.getElementById('toggle-sign-up-btn');
			const authMessage = document.getElementById( 'auth-message' );


			// --- 4. FIREBASE SETUP (Multi-Auth + Auth Check) ---

			// --- Helper for Email Auth Messages ---
			function showAuthMessage(type, text) {
				const emailAuthSection = document.getElementById('email-auth-section');
				let msgDiv = document.getElementById('auth-msg');
				if (!msgDiv) {
					msgDiv = document.createElement('div');
					msgDiv.id = 'auth-msg';
					emailAuthSection.insertBefore(msgDiv, emailSignInBtn);
				}
				msgDiv.innerHTML = `<div class="message ${type} mt-3 mb-3">${text}</div>`;
			}

			function clearAuthMessage() {
				const msgDiv = document.getElementById('auth-msg');
				if (msgDiv) {
					msgDiv.remove();
				}
			}

			// --- Email/Password Handlers ---
			async function handleEmailSignIn() {
				clearAuthMessage();
				const email = authEmail.value;
				const password = authPassword.value;
				if (!email || !password) {
					showAuthMessage('error', 'Please enter both email and password.');
					return;
				}
				try {
					await signInWithEmailAndPassword(auth, email, password);
					// onAuthStateChanged handles the rest
				} catch (error) {
					console.error('Email Sign In Error:', error);
					showAuthMessage('error', `Sign in failed: ${error.message}`);
				}
			}

			async function handleEmailSignUp() {
				clearAuthMessage();
				const email = authEmail.value;
				const password = authPassword.value;
				if (!email || !password || password.length < 6) {
					showAuthMessage('error', 'Please enter a valid email and a password of at least 6 characters.');
					return;
				}
				try {
					await createUserWithEmailAndPassword(auth, email, password);
					// onAuthStateChanged handles the rest
				} catch (error) {
					console.error('Email Sign Up Error:', error);
					showAuthMessage('error', `Sign up failed: ${error.message}`);
				}
			}

			function toggleEmailAuthMode()
			{
				clearAuthMessage();
				const isSignInMode = emailSignInBtn.classList.contains( 'hidden' );
				if( isSignInMode )
				{
					// Switch to Sign In
					emailAuthTitle.textContent = 'Sign In with Email';
					emailSignInBtn.classList.remove( 'hidden' );
					emailSignUpBtn.classList.add( 'hidden' );
					toggleSignUpBtn.innerHTML = 'New user? <span>Create an account</span>';
				}
				else
				{
					// Switch to Sign Up
					emailAuthTitle.textContent = 'Create Account with Email';
					emailSignInBtn.classList.add( 'hidden' );
					emailSignUpBtn.classList.remove( 'hidden' );
					toggleSignUpBtn.innerHTML = 'Already have an account? <span>Sign In</span>';
				}
			} // <-- This is the curly brace we fixed!

			// --- END HANDLERS ---

			const setupFirebase = () =>
			{
				try
				{
					isAuthorizedVolunteer = httpsCallable( functions, 'isAuthorizedVolunteerV2' );

					onAuthStateChanged( auth, async( user ) =>
					{
						if( user && !user.isAnonymous )
						{
							clearAuthMessage();
							try
							{
								const result = await isAuthorizedVolunteer( { uid: user.uid } );
								if( result.data.isAuthorized )
								{
									const displayName = result.data.displayName || user.email;
									document.getElementById( 'auth-container' ).style.display = 'none';
									document.getElementById( 'main-content' ).style.display = 'block';
									document.getElementById( 'volunteer-name' ).textContent = displayName;
									document.getElementById( 'sign-out-btn' ).onclick = () => signOut( auth );
									window.initApp( user, displayName );
								}
								else
								{
									document.getElementById( 'main-content' ).style.display = 'none';
									document.getElementById( 'auth-container' ).style.display = 'block';
									authMessage.textContent = 'You are signed in but not authorized. Please complete the setup form or contact an administrator.';
									document.getElementById( 'auth-buttons' ).style.display = 'none';
								}
							}
							catch( err )
							{
								console.error( 'Authorization check failed:', err );
								authMessage.textContent = `An error occurred during authorization check: ${ err.message }`;
								document.getElementById( 'auth-buttons' ).style.display = 'none';
							}
						}
						else
						{
							document.getElementById( 'main-content' ).style.display = 'none';
							document.getElementById( 'auth-container' ).style.display = 'block';
							document.getElementById( 'auth-buttons' ).style.display = 'block';
							authMessage.textContent = 'Please sign in to access the dashboard.';
							if( emailSignInBtn.classList.contains( 'hidden' ) )
							{
								toggleEmailAuthMode();
							}
						}
					} );

					getRedirectResult( auth ).catch( ( error ) =>
					{
						console.error( 'Redirect login failed:', error );
						authMessage.textContent = `Login failed: ${ error.message }`;
					} );
					document.getElementById( 'google-login-btn' ).addEventListener( 'click', () =>
					{
						const provider = new GoogleAuthProvider();
						signInWithPopup( auth, provider );
					} );
					emailSignInBtn.onclick = handleEmailSignIn;
					emailSignUpBtn.onclick = handleEmailSignUp;
					toggleSignUpBtn.onclick = toggleEmailAuthMode;
				}
				catch( error )
				{
					console.error( 'Firebase Initialization Error:', error );
				}
			};

			// --- 5. HELPER FUNCTIONS (Uses new CSS classes) ---
			const renderBoxCard = ( box ) =>
			{
				let statusHtml;
				if( box.latestPendingReport )
				{
					const report = box.latestPendingReport;
					const isProblem = report.reportType.includes( 'problem' );
					// Note: The 'text-yellow-700' class no longer does anything, which is fine.
					// We'd need a new CSS rule for it if you want that color.
					statusHtml = `
                    <div class="status-problem">
                        <p class="status-title ${ isProblem ? '' : 'text-yellow-700' }">
                            Status: ${ report.reportType.replace( /_/g, ' ' ) }
                        </p>
                        <p class="status-desc">${ report.description || report.notes || 'No details provided.' }</p>
                        <button
                            class="clear-status-btn"
                            data-report-id="${ report.id }">
                            Mark as Cleared
                        </button>
                    </div>
                `;
				}
				else
				{
					statusHtml = `
                    <div class="status-good">
                        <p class="status-title">Status: Good</p>
                        <p class="status-desc">All reports are cleared.</p>
                    </div>
                `;
				}

				return `
                <div class="box-card">
                    <div>
                        <h3>${ box.label }</h3>
                        <p class="address">${ box.address }, ${ box.city }</p>
                        <p class="box-id">ID: ${ box.boxId }</p>
                    </div>
                    <div class="status-wrapper">
                        ${ statusHtml }
                    </div>
                    <a href="/status/?id=${ box.boxId }" class="view-history-btn">
                        View Full History
                    </a>
                </div>
            `;
			};

			// --- 6. MAIN APP LOGIC ---
			let allBoxesMap = new Map();
			let currentUserId = null;

			const renderDashboard = ( filterKey ) =>
			{
				const boxesContainer = document.getElementById( 'boxes-container' );
				const boxesTitle = document.getElementById( 'boxes-title' );
				boxesContainer.innerHTML = '';
				let boxesToRender = [];
				if( filterKey === 'all_boxes' )
				{
					boxesToRender = Array.from( allBoxesMap.values() );
					boxesTitle.textContent = 'All Box Statuses';
				}
				else
				{
					boxesTitle.textContent = `Boxes Assigned to ${ filterKey }`;
					allBoxesMap.forEach( box =>
					{
						if( box.volunteer === filterKey )
						{
							boxesToRender.push( box );
						}
					} );
				}
				if( boxesToRender.length === 0 )
				{
					boxesContainer.innerHTML = '<p style="text-align: center; color: #4b5563; padding: 1rem;">No boxes found for this filter.</p>';
					return;
				}
				let html = '';
				boxesToRender.sort( ( a, b ) => a.label.localeCompare( b.label ) );
				boxesToRender.forEach( box =>
				{
					html += renderBoxCard( box );
				} );
				boxesContainer.innerHTML = html;
			};

			window.initApp = async( user, displayName ) =>
			{
				currentUserId = user.uid;
				const currentUserDisplayName = displayName;
				const boxesContainer = document.getElementById( 'boxes-container' );
				const loadingMessage = document.getElementById( 'loading-message' );
				const filterSelect = document.getElementById( 'view-filter' );
				try
				{
					const reportsRef = collection( db, reportsCollectionPath );
					const q = query( reportsRef,
							orderBy( 'timestamp', 'asc' )
					);
					const querySnapshot = await getDocs( q );
					loadingMessage.remove();
					if( querySnapshot.empty )
					{
						boxesContainer.innerHTML = '<p style="text-align: center; color: #4b5563; padding: 1rem;">No reports have been filed for any boxes yet.</p>';
						return;
					}
					const volunteerNames = new Set();
					allBoxesMap.clear();
					querySnapshot.forEach( doc =>
					{
						const report = { id: doc.id, ...doc.data() };
						const boxId = report.boxId;
						if( report.volunteer )
						{
							volunteerNames.add( report.volunteer );
						}
						if( !allBoxesMap.has( boxId ) )
						{
							allBoxesMap.set( boxId, {
								boxId: boxId,
								label: report.label,
								address: report.address,
								city: report.city,
								latestPendingReport: null,
								provisionedBy: report.provisionedBy,
								volunteer: report.volunteer
							} );
						}
						const box = allBoxesMap.get( boxId );
						if( report.status === 'new' )
						{
							box.latestPendingReport = report;
						}
					} );
					filterSelect.innerHTML = `
                    <option value="${ currentUserDisplayName }">My Boxes</option>
                    <option value="all_boxes">All Boxes</option>
                    <option value="" disabled>--- Filter by Volunteer ---</option>
                `;
					const sortedNames = Array.from( volunteerNames ).sort();
					sortedNames.forEach( name =>
					{
						const option = document.createElement( 'option' );
						option.value = name;
						option.textContent = name;
						filterSelect.appendChild( option );
					} );
					filterSelect.addEventListener( 'change', ( e ) =>
					{
						renderDashboard( e.target.value );
					} );
					renderDashboard( currentUserDisplayName );
				}
				catch( error )
				{
					console.error( 'Error fetching reports:', error );
					loadingMessage.innerHTML = `<p style="text-align: center; color: var(--t4t-red); font-weight: 700; padding: 1rem;">Error loading reports: ${ error.message }</p>`;
				}
			};

			// --- 7. Event listener for "Clear Status" buttons ---
			document.getElementById( 'main-content' ).addEventListener( 'click', async( e ) =>
			{
				if( e.target && e.target.classList.contains( 'clear-status-btn' ) )
				{
					const button = e.target;
					const reportId = button.dataset.reportId;
					button.disabled = true;
					button.textContent = 'Clearing...';
					try
					{
						const reportRef = doc( db, reportsCollectionPath, reportId );
						await updateDoc( reportRef, {
							status: 'cleared'
						} );
						location.reload();
					}
					catch( err )
					{
						console.error( 'Error clearing status: ', err );
						alert( 'Error clearing status. Please try again.' );
						button.disabled = false;
						button.textContent = 'Clear Status';
					}
				}
			} );

			// --- 8. CALL THE SETUP FUNCTION ---
			setupFirebase();
		</script>

	</body>

</html>
