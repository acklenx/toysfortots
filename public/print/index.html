<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>TFT Box Sticker Print Sheet</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			:root {
				--page-top-padding: 0.5in;
				--column-gap: 0.15in;
				--row-negative-margin: -0.09in;
				--sticker-width: calc((8.5in - (2 * 0.25in) - var(--column-gap)) / 2);
				--sticker-height: 2.6in;
			}

			.sticker-card {
				width: var(--sticker-width);
				height: var(--sticker-height);
				border: 1px dashed #ccc;
				padding: 5px;
				box-sizing: border-box;
				background-color: #fff;
				display: flex;
				flex-direction: column;
				justify-content: space-between;
			}

			#sticker-grid-wrapper {
				margin: 0 auto;
			}

			@media print {
				body {
					width: 8.5in;
					height: 11in;
					margin: 0;
					padding: 0 0.25in;
				}

				#sticker-grid-wrapper {
					margin-top: var(--page-top-padding);
					display: grid;
					grid-template-columns: var(--sticker-width) var(--sticker-width);
					grid-template-rows: repeat(4, var(--sticker-height));
					column-gap: var(--column-gap);
				}

				.sticker-card:nth-child(3), .sticker-card:nth-child(4) {
					margin-top: var(--row-negative-margin);
				}

				.sticker-card:nth-child(5), .sticker-card:nth-child(6) {
					margin-top: calc(2 * var(--row-negative-margin));
				}

				.sticker-card:nth-child(7), .sticker-card:nth-child(8) {
					margin-top: calc(3 * var(--row-negative-margin));
				}

				.sticker-card {
					width: var(--sticker-width);
					height: var(--sticker-height);
					border: none !important;
					padding: 0;
					page-break-inside: avoid;
					box-shadow: none !important;
				}

				.config-panel {
					display: none !important;
				}
			}

			@media screen {
				body {
					padding: 20px;
					background-color: #f7f7f7;
					display: flex;
					flex-direction: column;
					align-items: center;
				}

				#sticker-grid-wrapper {
					display: grid;
					grid-template-columns: repeat(2, 1fr);
					gap: 20px;
					max-width: 850px;
				}

				.config-panel {
					width: 100%;
					max-width: 850px;
					margin-bottom: 20px;
					padding: 15px;
					border: 1px solid #ccc;
					border-radius: 8px;
					background-color: #fff;
				}
			}
		</style>
	</head>
	<body class="font-sans">
		<div id="configPanel" class="config-panel">
			<h2 class="text-lg font-bold mb-3 text-gray-700">Print Sheet Configuration</h2>
			<div class="flex flex-wrap gap-4 items-end">
				<div>
					<label for="startId" class="block text-sm font-medium text-gray-600">Starting Box ID (e.g., 1000)
					</label>
					<input type="number" id="startId" value="1000" min="1" class="mt-1 block w-32 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
				</div>
				<div>
					<label for="idLength" class="block text-sm font-medium text-gray-600">Obfuscated ID Length</label>
					<input type="number" id="idLength" value="4" min="3" class="mt-1 block w-32 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
				</div>
				<div>
					<label for="topPadding" class="block text-sm font-medium text-gray-600">Page Top Padding (e.g.,
						0.2in)
					</label>
					<input type="text" id="topPadding" value="0.5in" class="mt-1 block w-28 rounded-md border-gray-300 shadow-sm sm:text-sm p-2">
				</div>
				<div>
					<label for="rowGap" class="block text-sm font-medium text-gray-600">Row Overlap (e.g., -0.09in)
					</label>
					<input type="text" id="rowGap" value="-0.09in" class="mt-1 block w-28 rounded-md border-gray-300 shadow-sm sm:text-sm p-2">
				</div>
				<div>
					<label for="columnGap" class="block text-sm font-medium text-gray-600">Column Gap (e.g., 0.15in)
					</label>
					<input type="text" id="columnGap" value="0.15in" class="mt-1 block w-28 rounded-md border-gray-300 shadow-sm sm:text-sm p-2">
				</div>
				<button onclick="renderStickers()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-150">
					Generate Sheet
				</button>
				<button onclick="window.print()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-150">
					Print Sticker Sheet
				</button>
			</div>
		</div>
		<script>
			class IdObfuscator
			{
				constructor()
				{
					this.ALPHABET = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
					this.BASE = this.ALPHABET.length;
					this.PRIME = 1000000007;
					this.MULTIPLIER = 478372833;
				}

				encode( id, fixedLength = 5 )
				{
					if( typeof id !== 'number' || id < 0 || !Number.isInteger( id ) )
					{
						throw new Error( 'ID must be a non-negative integer.' );
					}
					if( id > this.PRIME )
					{
						console.warn( `Warning: ID ${ id } is larger than PRIME ${ this.PRIME }. Collisions may occur.` );
					}
					const obfuscatedNum = ( BigInt( id ) * BigInt( this.MULTIPLIER ) ) % BigInt( this.PRIME );
					const encoded = this._toBase( Number( obfuscatedNum ) );
					const paddingChar = this.ALPHABET[ 0 ];
					const padded = encoded.padStart( fixedLength, paddingChar );
					return padded.slice( -fixedLength );
				}

				_toBase( num )
				{
					if( num === 0 )
					{
						return this.ALPHABET[ 0 ];
					}
					let str = '';
					let n = num;
					while( n > 0 )
					{
						const remainder = n % this.BASE;
						str = this.ALPHABET[ remainder ] + str;
						n = Math.floor( n / this.BASE );
					}
					return str;
				}
			}

			const MCL_LOGO = 'https://toysfortots.netlify.app/images/mcl-logo.webp';
			const BASE_URL = 'http://toysfortots.mcl1311.com/box';
			const DEFAULT_STICKER_HEIGHT = '2.6in';
			const idGen = new IdObfuscator();

			function generateBoxIds( startId, count, idLength )
			{
				const ids = [];
				for( let i = 0; i < count; i++ )
				{
					const sequentialId = startId + i;
					ids.push( idGen.encode( sequentialId, idLength ) );
				}
				return ids;
			}

			function generateQrCodeImage( id )
			{
				const qrText = `${ BASE_URL }?id=${ id }`;
				const quickChartUrl = `https://quickchart.io/qr?text=${ encodeURIComponent( qrText ) }&size=300&light=FFFFFF&dark=000000`;
				return `<img src="${ quickChartUrl }" alt="QR Code Box ID ${ id }" class="qr-svg mx-auto w-[180px] h-[180px] max-w-full">`;
			}

			function renderStickers()
			{
				const startIdValue = parseInt( document.getElementById( 'startId' ).value, 10 ) || 1;
				const idLengthValue = parseInt( document.getElementById( 'idLength' ).value, 10 ) || 5;
				const topPaddingValue = document.getElementById( 'topPadding' ).value || '0.5in';
				const rowOverlapValue = document.getElementById( 'rowGap' ).value || '-0.09in';
				const columnGapValue = document.getElementById( 'columnGap' ).value || '0.15in';
				document.documentElement.style.setProperty( '--page-top-padding', topPaddingValue );
				document.documentElement.style.setProperty( '--row-negative-margin', rowOverlapValue );
				document.documentElement.style.setProperty( '--column-gap', columnGapValue );
				document.documentElement.style.setProperty( '--sticker-height', DEFAULT_STICKER_HEIGHT );
				const boxIds = generateBoxIds( startIdValue, 8, idLengthValue );
				const body = document.body;
				let wrapper = document.getElementById( 'sticker-grid-wrapper' );
				if( wrapper )
				{
					wrapper.remove();
				}
				wrapper = document.createElement( 'div' );
				wrapper.id = 'sticker-grid-wrapper';
				body.appendChild( wrapper );
				boxIds.forEach( id =>
				{
					const sticker = document.createElement( 'a' );
					sticker.href = `${ BASE_URL }?id=${ id }`;
					sticker.classList.add( 'sticker-card', 'flex', 'flex-col' );
					sticker.innerHTML = `
                    <div class="text-center bg-[#CC0000] text-white py-0.5 mb-0.5 rounded-sm">
                        <p class="text-sm font-extrabold uppercase tracking-widest">
                            Box Full? Scan QR-Code for Pickup!
                        </p>
                    </div>
                    <div class="flex flex-row flex-grow w-full items-start justify-between">
                        <div class="flex-shrink-0 w-1/2 flex flex-col items-center py-0.5 pt-0 px-1">
                            ${ generateQrCodeImage( id ) }
                            <div class="text-xs text-center font-mono font-bold text-[#003366] mt-1">
                                BOX ID: ${ id }
                            </div>
                        </div>
                        <div class="flex-grow w-1/2 flex flex-col justify-start h-full pl-2" style="position:relative;left:-15px; top:7px;">
                            <ul class="list-none p-0 mt-0 text-gray-700 font-semibold pt-2 pb-0">
                                <li class="font-bold text-base text-[#003366]"> • Report a full box</li>
                                <li class="font-bold text-base text-[#003366]"> • Report a problem</li>
                                <li class="font-bold text-base text-[#003366]"> • Get more information</li>
                            </ul>
                            <div class="flex flex-col items-center mt-0 pt-1 pb-0" style="position:relative;">
                                <img src="${ MCL_LOGO }" style="position:relative;top: 10px;left:-7px;" onerror="this.onerror=null; this.src='https://placehold.co/100x40/003366/ffffff?text=MCL+Error';" alt="Marine Corps League Logo" class="h-24 w-auto">
                            </div>
                        </div>
                    </div>
                `;
					wrapper.appendChild( sticker );
				} );
			}

			window.onload = renderStickers;
		</script>
	</body>
</html>