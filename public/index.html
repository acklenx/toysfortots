<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="Find Toys for Tots donation boxes in North Metro Atlanta. Run by the Marine Corps Reserve and coordinated locally by Marine Corps League Detachment 1311. Interactive map of drop-off locations in Woodstock, Marietta, Kennesaw, and surrounding areas.">
		<title>Toys for Tots - North Metro Atlanta Area</title>
		<link rel="preconnect" href="https://unpkg.com" crossorigin>
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
		<link rel="stylesheet" href="/css/style.css?v=1.0.8">
	</head>
	<body class="bg-gray-100">
		<div id="header-placeholder"></div>

		<main class="container">
			<div id="map"></div>
			<div id="location-list-container">
				<div class="list-header">
					<h3>Donation Boxes</h3>
				</div>
				<div id="location-list">
				</div>
			</div>
		</main>


		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
		<script type="module">
			import { db, auth, locationsCollectionPath } from './js/firebase-init.js';
			import {
				signInAnonymously,
				onAuthStateChanged
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
			import {
				collection,
				getDocs,
				query,
				orderBy
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

			document.addEventListener( 'DOMContentLoaded', () =>
			{
				const map = L.map( 'map' ).setView( [ 34.05, -84.60 ], 11 );
				L.tileLayer( 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
					attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
				} ).addTo( map );
				const locationList = document.getElementById( 'location-list' );
				const customIcon = L.icon( {
					iconUrl: 'images/pin.webp',
					iconSize: [ 40, 39 ],
					iconAnchor: [ 20, 39 ],
					popupAnchor: [ 0, -39 ]
				} );

				async function loadLocations()
				{
					locationList.innerHTML = '<p style="padding: 15px; text-align: center;">Loading locations...</p>';
					try
					{
						const locationsRef = collection( db, locationsCollectionPath );
						const q = query( locationsRef, orderBy( 'created', 'desc' ) );
						const querySnapshot = await getDocs( q );
						if( querySnapshot.empty )
						{
							locationList.innerHTML = '<p style="padding: 15px; text-align: center;">No donation locations have been set up yet.</p>';
							return;
						}
						locationList.innerHTML = '';
						querySnapshot.forEach( ( doc ) =>
						{
							const location = doc.data();
							if( location.lat && location.lon )
							{
								const marker = L.marker( [ location.lat, location.lon ], { icon: customIcon } ).addTo( map );
								let popupContent = `<b>${ location.label }</b><br>${ location.address }`;
								if( location.city && location.state )
								{
									popupContent += `<br><small>${ location.city }, ${ location.state }</small>`;
								}
								marker.bindPopup( popupContent );
								const listItem = document.createElement( 'div' );
								listItem.className = 'location-item';
								listItem.innerHTML = `
		                            <h4>${ location.label }</h4>
		                            <p>${ location.address }</p>
		                            ${ location.city && location.state ? `<p class="contact-info">${ location.city }, ${ location.state }</p>` : '' }
		                        `;
								listItem.addEventListener( 'click', () =>
								{
									map.setView( [ location.lat, location.lon ], 14 );
									marker.openPopup();
								} );
								locationList.appendChild( listItem );
							}
						} );
					}
					catch( error )
					{
						locationList.innerHTML = `<p style="padding: 15px; text-align: center; color: red;">Could not load location data: ${ error.message }</p>`;
					}
				}

				function initFirebase()
				{
					try
					{
						onAuthStateChanged( auth, ( user ) =>
						{
							if( user )
							{
								setTimeout( () =>
								{
									loadLocations();
								}, 500 );
							}
							else
							{
								signInAnonymously( auth ).catch( () =>
								{
									locationList.innerHTML = '<p style="padding: 15px; color: red;">Error: Could not connect to database.</p>';
								} );
							}
						} );
					}
					catch( error )
					{
						locationList.innerHTML = '<p style="padding: 15px; color: red;">Error: Could not initialize app.</p>';
					}
				}

				initFirebase();
			} );
		</script>
		<div id="footer-placeholder"></div>
		<script src="/js/loader.js" defer></script>
	</body>
</html>