<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: https: blob:; font-src 'self' data: https://unpkg.com; connect-src 'self' http://localhost:* ws://localhost:* http://127.0.0.1:* ws://127.0.0.1:* https://*.gstatic.com https://unpkg.com https://*.googleapis.com https://*.cloudfunctions.net https://*.firebaseapp.com https://*.firebaseio.com https://*.google.com https://tile.openstreetmap.org wss://*.firebaseio.com; frame-src 'self' https://*.google.com; object-src 'none'; base-uri 'self'; form-action 'self'">
		<meta name="description" content="Find Toys for Tots donation boxes in North Metro Atlanta. Run by the Marine Corps Reserve and coordinated locally by Marine Corps League Detachment 1311. Interactive map of drop-off locations in Woodstock, Marietta, Kennesaw, and surrounding areas.">
		<title>Toys for Tots - North Metro Atlanta Area</title>
		<!-- Preconnect to critical origins for faster resource loading -->
		<link rel="preconnect" href="https://unpkg.com" crossorigin>
		<link rel="preconnect" href="https://us-central1-toysfortots-eae4d.cloudfunctions.net">
		<link rel="dns-prefetch" href="https://us-central1-toysfortots-eae4d.cloudfunctions.net">
		<link rel="dns-prefetch" href="https://tile.openstreetmap.org">
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
		<link rel="stylesheet" href="/css/style.min.css?v=1.0.20">
	</head>
	<body class="bg-gray-100">
		<div id="header-placeholder"></div>

		<main class="container">
			<div id="map"></div>
			<div id="location-list-container">
				<div class="list-header">
					<h3>Donation Boxes</h3>
					<div id="map-last-updated" style="color: var(--text-muted); font-size: 0.75rem; margin-top: 4px;">
						Loading...
					</div>
				</div>
				<div id="location-list">
				</div>
			</div>
		</main>


		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
		<script type="module">
			import { db, auth, locationsCollectionPath } from './js/firebase-init.js';
			import {
				signInAnonymously,
				onAuthStateChanged
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
			import {
				collection,
				getDocs,
				query,
				orderBy
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

			document.addEventListener( 'DOMContentLoaded', () =>
			{
				const map = L.map( 'map' ).setView( [ 34.05, -84.60 ], 11 );
				L.tileLayer( 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
					attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
				} ).addTo( map );
				const locationList = document.getElementById( 'location-list' );
				const customIcon = L.icon( {
					iconUrl: 'images/pin.webp',
					iconSize: [ 40, 39 ],
					iconAnchor: [ 20, 39 ],
					popupAnchor: [ 0, -39 ]
				} );

				let cachedLocationsLoaded = false;
				let realtimeLocationsLoaded = false;

				// XSS Protection: Escape HTML to prevent script injection
				function escapeHtml(unsafe) {
					if (!unsafe) return '';
					return String(unsafe)
						.replace(/&/g, '&amp;')
						.replace(/</g, '&lt;')
						.replace(/>/g, '&gt;')
						.replace(/"/g, '&quot;')
						.replace(/'/g, '&#039;');
				}

				// Remove loading message
				function removeLoadingMessage()
				{
					const loadingMsg = document.getElementById( 'loading-message' );
					if( loadingMsg )
					{
						loadingMsg.remove();
					}
				}

				// Render locations on map and list
				function renderLocations( locationsArray, source )
				{
					// Remove loading message when we get data
					removeLoadingMessage();

					if( locationsArray.length === 0 )
					{
						if( source === 'realtime' )
						{
							locationList.innerHTML = '<p style="padding: 15px; text-align: center;">No donation locations have been set up yet.</p>';
						}
						return;
					}

					// Clear existing markers and list when rendering locations
					if( source === 'realtime' )
					{
						// Clear any existing markers if cache was loaded
						if( cachedLocationsLoaded )
						{
							map.eachLayer( ( layer ) =>
							{
								if( layer instanceof L.Marker )
								{
									map.removeLayer( layer );
								}
							} );
						}
						// Always clear the list to remove loading message or cached items
						locationList.innerHTML = '';
					}
					else if( source === 'cache' )
					{
						locationList.innerHTML = '';
					}

					locationsArray.forEach( ( location ) =>
					{
						// Skip soft-deleted boxes (safety net in case cache includes them)
						if( location.deleted === true )
						{
							return;
						}

						if( location.lat && location.lon )
						{
							const marker = L.marker( [ location.lat, location.lon ], { icon: customIcon } ).addTo( map );
							let popupContent = `<b>${ escapeHtml(location.label) }</b><br>${ escapeHtml(location.address) }`;
							if( location.city && location.state )
							{
								popupContent += `<br><small>${ escapeHtml(location.city) }, ${ escapeHtml(location.state) }</small>`;
							}
							marker.bindPopup( popupContent );
							const listItem = document.createElement( 'div' );
							listItem.className = 'location-item';
							listItem.innerHTML = `
	                            <h4>${ escapeHtml(location.label) }</h4>
	                            <p>${ escapeHtml(location.address) }</p>
	                            ${ location.city && location.state ? `<p class="contact-info">${ escapeHtml(location.city) }, ${ escapeHtml(location.state) }</p>` : '' }
	                        `;
							listItem.addEventListener( 'click', () =>
							{
								map.setView( [ location.lat, location.lon ], 14 );
								marker.openPopup();
							} );
							locationList.appendChild( listItem );
						}
					} );
				}

				// Load cached locations first (fast, no auth required)
				async function loadCachedLocations()
				{
					locationList.innerHTML = '<p id="loading-message" style="padding: 5px; text-align: center; font-size: 0.9em; color: #666;">Loading locations...</p>';

					// Remove loading message after 5 seconds
					setTimeout( removeLoadingMessage, 5000 );

					try
					{
						const loadStart = performance.now();

						// Use mock cache on localhost/emulators, real cache in production
						const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
						// Add cache busting parameter to prevent stale data from browser/service worker cache
						const cacheBuster = `v=${Date.now()}`;
						const cacheUrl = isLocalhost
							? `/mock-locations-cache.json?${cacheBuster}`
							: `https://us-central1-toysfortots-eae4d.cloudfunctions.net/getLocationsCache?${cacheBuster}`;

						const response = await fetch( cacheUrl );

						if( !response.ok )
						{
							throw new Error( `Cache fetch failed: ${ response.status }` );
						}

						const cacheData = await response.json();
						const loadTime = Math.round(performance.now() - loadStart);

						// Even if cache is empty (mock returns 0 locations), mark as loaded
						// This prevents blocking and allows realtime to populate the map
						renderLocations( cacheData.locations, 'cache' );
						cachedLocationsLoaded = true;

						// Update timestamp
						const now = new Date();
						const timeStr = now.toLocaleTimeString();
						document.getElementById('map-last-updated').textContent =
							`Loaded: ${timeStr} ðŸ“¦ (cached) â€¢ ${loadTime}ms`;
					}
					catch( error )
					{
						console.warn( 'Could not load cached locations, falling back to realtime:', error );
						removeLoadingMessage();
					}
				}

				// Load realtime locations from Firestore (slower, requires auth)
				async function loadRealtimeLocations()
				{
					try
					{
						const loadStart = performance.now();

						const locationsRef = collection( db, locationsCollectionPath );
						const q = query( locationsRef, orderBy( 'created', 'desc' ) );
						const querySnapshot = await getDocs( q );

						const locations = [];
						querySnapshot.forEach( ( doc ) =>
						{
							const data = doc.data();
							locations.push( {
								id: doc.id,
								...data
							} );
						} );

						const loadTime = Math.round(performance.now() - loadStart);

						renderLocations( locations, 'realtime' );
						realtimeLocationsLoaded = true;

						// Update timestamp
						const now = new Date();
						const timeStr = now.toLocaleTimeString();
						const cacheIndicator = loadTime < 300 ? ' ðŸš€ (cached)' : '';
						document.getElementById('map-last-updated').textContent =
							`Synced: ${timeStr}${cacheIndicator} â€¢ ${loadTime}ms`;
					}
					catch( error )
					{
						console.error( 'Error loading realtime locations:', error );
						removeLoadingMessage();
						if( !cachedLocationsLoaded )
						{
							locationList.innerHTML = `<p style="padding: 15px; text-align: center; color: red;">Could not load location data: ${ error.message }</p>`;
						}
					}
				}

				function initFirebase()
				{
					try
					{
						onAuthStateChanged( auth, ( user ) =>
						{
							if( user )
							{
								// Auth successful, lazy load realtime data in background
								setTimeout( () =>
								{
									loadRealtimeLocations();
								}, 500 );
							}
							else
							{
								// No user, attempt anonymous sign-in for realtime updates
								signInAnonymously( auth ).catch( ( error ) =>
								{
									console.warn( 'Anonymous sign-in failed, cached data only:', error );
									// If cache loaded, we're fine. Otherwise show error.
									if( !cachedLocationsLoaded )
									{
										locationList.innerHTML = '<p style="padding: 15px; color: red;">Error: Could not connect to database.</p>';
									}
								} );
							}
						} );
					}
					catch( error )
					{
						console.error( 'Firebase init error:', error );
						if( !cachedLocationsLoaded )
						{
							locationList.innerHTML = '<p style="padding: 15px; color: red;">Error: Could not initialize app.</p>';
						}
					}
				}

				// Load cached data immediately (no auth required)
				loadCachedLocations();

				// Homepage uses cache-only for optimal performance
				// Cache is refreshed: every 6 hours (automatic) + after new box registration (triggered)
				// Realtime Firebase loading disabled - cache provides sufficient freshness
				// initFirebase();
			} );

			// Register Service Worker for stale-while-revalidate caching
			if ('serviceWorker' in navigator) {
				window.addEventListener('load', () => {
					navigator.serviceWorker.register('/sw.js').then((registration) => {
						console.log('[SW] Service Worker registered:', registration.scope);

						// Check for updates every hour
						setInterval(() => {
							registration.update();
						}, 60 * 60 * 1000);
					}).catch((error) => {
						console.warn('[SW] Service Worker registration failed:', error);
					});
				});
			}
		</script>
		<div id="footer-placeholder"></div>
		<script src="/js/loader.min.js" defer></script>
	</body>
</html>