<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: https: blob:; font-src 'self' data: https://unpkg.com; connect-src 'self' http://localhost:* ws://localhost:* http://127.0.0.1:* ws://127.0.0.1:* https://*.gstatic.com https://unpkg.com https://*.googleapis.com https://*.cloudfunctions.net https://*.firebaseapp.com https://*.firebaseio.com https://*.google.com https://tile.openstreetmap.org https://nominatim.openstreetmap.org wss://*.firebaseio.com; frame-src 'self' https://*.google.com; object-src 'none'; base-uri 'self'; form-action 'self'">
		<meta name="description" content="Register a new Toys for Tots donation box location. Marine Corps League Detachment 1311 volunteers can set up boxes at businesses in North Metro Atlanta. Supporting the Marine Corps Reserve Toys for Tots program.">
		<title>Set Up New Location</title>
		<link rel="stylesheet" href="/css/style.min.css?v=1.0.7">
	</head>
	<body class="bg-gray-100">
		<div id="header-placeholder"></div>

		<main class="page-container">
			<div class="form-container">
				<h1>Set Up New Box Location</h1>

				<form id="new-location-form" class="hidden">
					<div class="form-group">
						<label>Box ID to Set Up</label>
						<div id="box-id-display">Loading...</div>
					</div>
					<div class="hr-divider"></div>
					<div style="margin-bottom: 1.25rem;">
						<button id="gps-btn" type="button">
							Use My GPS Location
						</button>
						<div id="gps-error-msg"></div>
					</div>
					<div id="show-address-btn">
						Click <span>here</span> to type in the address
					</div>
					<input type="hidden" id="lat" name="lat">
					<input type="hidden" id="lon" name="lon">
					<input type="hidden" id="county" name="county">
					<input type="hidden" id="postalcode" name="postalcode">
					<div id="manual-address-fields" class="hidden">
						<div class="form-group">
							<label for="address">Full Street Address</label>
							<input type="text" id="address" name="address" required maxlength="500" minlength="3">
						</div>
						<div class="form-group">
							<label for="city">City</label>
							<input type="text" id="city" name="city" required maxlength="100" minlength="1">
						</div>
						<div class="form-group">
							<label for="state">State</label>
							<input type="text" id="state" name="state" value="GA" required maxlength="50" minlength="2">
						</div>
					</div>
					<div class="form-group" style="display: none;">
						<label for="boxes">Number of Boxes</label>
						<input type="number" id="boxes" name="boxes" value="1" min="0" max="1000">
					</div>
					<div class="hr-divider"></div>
					<div class="form-group">
						<label for="label">Location Name (Label)</label>
						<input type="text" id="label" name="label" required maxlength="200" minlength="1">
					</div>
					<div class="form-group">
						<label for="contactName">Contact Name</label>
						<input type="text" id="contactName" name="contactName" maxlength="200">
					</div>
					<div class="form-group">
						<label for="contactEmail">Contact Email</label>
						<input type="email" id="contactEmail" name="contactEmail" maxlength="320">
					</div>
					<div class="form-group">
						<label for="contactPhone">Contact Phone</label>
						<input type="tel" id="contactPhone" name="contactPhone" maxlength="50" title="Phone number must contain only digits, spaces, hyphens, parentheses, dots, or plus signs">
					</div>
					<div class="form-group">
						<button id="submit-btn" type="submit">Submit Location</button>
					</div>
					<div id="message-container"></div>
				</form>
			</div>
			<script type="module">
				import { auth, db, functions, locationsCollectionPath } from '../js/firebase-init.js';
				import { showMessage } from '/js/utils.min.js';
			import {
				findExactMatchByAddress,
				searchByLabel,
				searchByAddress,
				searchByContactName,
				searchByContactPhone,
				searchByContactEmail,
				autoFillFormFields,
				createAutocomplete
			} from '../js/location-autocomplete.js';
				import {
					onAuthStateChanged
				} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
				import {
					doc,
					getDoc
				} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
				import {
					httpsCallable
				} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js';

				let scannedBoxId = null;
				let isAuthorizedVolunteer; // Firebase function ref
				const form = document.getElementById( 'new-location-form' );
				const messageContainer = document.getElementById( 'message-container' );
				const submitBtn = document.getElementById( 'submit-btn' );
				const boxIdDisplay = document.getElementById( 'box-id-display' );
				const latInput = document.getElementById( 'lat' );
				const lonInput = document.getElementById( 'lon' );
				const gpsBtn = document.getElementById( 'gps-btn' );
				const addressInput = document.getElementById( 'address' );
				const cityInput = document.getElementById( 'city' );
				const stateInput = document.getElementById( 'state' );
				const countyInput = document.getElementById( 'county' );
				const postalCodeInput = document.getElementById( 'postalcode' );
				const showAddressBtn = document.getElementById( 'show-address-btn' );
				const manualAddressFields = document.getElementById( 'manual-address-fields' );
				const gpsErrorMsg = document.getElementById( 'gps-error-msg' );


				async function getGeoLocation()
				{
					showMessage( '', '' );
					gpsErrorMsg.textContent = '';
					gpsBtn.disabled = true;
					gpsBtn.textContent = 'Searching...';
					gpsBtn.classList.remove( 'bg-red-500', 'bg-green-600' );
					gpsBtn.classList.add( 'bg-yellow-500' );
					if( !navigator.geolocation )
					{
						gpsErrorMsg.textContent = 'Geolocation is not supported by this browser.';
						gpsBtn.disabled = false;
						gpsBtn.textContent = 'Use My GPS Location';
						gpsBtn.classList.remove( 'bg-yellow-500' );
						gpsBtn.classList.add( 'bg-red-500' );
						manualAddressFields.classList.remove( 'hidden' );
						showAddressBtn.classList.add( 'hidden' );
						addressInput.focus();
						return;
					}
					navigator.geolocation.getCurrentPosition( async( position ) =>
					{
						const lat = position.coords.latitude;
						const lon = position.coords.longitude;
						latInput.value = lat;
						lonInput.value = lon;
						try
						{
							gpsBtn.textContent = 'Got GPS, Getting Address...';
							console.log( 'Attempting Google reverse geocoding...' );

							// Primary: Use Google Reverse Geocoding via Cloud Function (more accurate)
							const reverseGeocode = httpsCallable( functions, 'reverseGeocode' );
							const result = await reverseGeocode( { lat, lon } );

							if( result.data.success )
							{
								const data = result.data;
								addressInput.value = data.address || '';
								cityInput.value = data.city || '';
								stateInput.value = data.state || 'GA';
								countyInput.value = data.county || '';
								postalCodeInput.value = data.postalCode || '';

								console.log( 'Google reverse geocoding successful:', data );
								showMessage( 'success', 'Location and Address captured!' );
							}
							else
							{
								throw new Error( 'Google geocoding returned no results' );
							}
						}
						catch( geoError )
						{
							console.error( 'Google geocoding error:', geoError );

							// Fallback to OpenStreetMap
							try
							{
								gpsBtn.textContent = 'Trying alternate geocoding...';
								console.log( 'Attempting OpenStreetMap reverse geocoding fallback...' );

								const geoApiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${ lat }&lon=${ lon }`;
								const response = await fetch( geoApiUrl );
								if( !response.ok )
								{
									throw new Error( `Address lookup failed (status: ${ response.status })` );
								}
								const data = await response.json();
								console.log( 'OpenStreetMap Reverse Geocode Response:', data );
								if( data && data.address )
								{
									const addr = data.address;
									addressInput.value = `${ addr.house_number || '' } ${ addr.road || '' }`.trim();
									cityInput.value = addr.city || addr.town || addr.village || '';
									stateInput.value = addr.state || 'GA';
									countyInput.value = addr.county || '';
									postalCodeInput.value = addr.postcode || '';
									const labelInput = document.getElementById( 'label' );
									if( labelInput.value === '' )
									{
										labelInput.value = addr.amenity || addr.shop || addr.building || addr.office || '';
									}

									console.log( 'OpenStreetMap reverse geocoding successful' );
									showMessage( 'success', 'Location and Address captured!' );
								}
								else
								{
									throw new Error( 'Address not found in API response.' );
								}
							}
							catch( osmError )
							{
								console.error( 'OpenStreetMap geocoding fallback also failed:', osmError );
								gpsErrorMsg.textContent = 'Got GPS, but failed to get address. Please type it manually.';
							}
						}

						// Auto-lookup by address after GPS (separate from geocoding error handling)
						if( addressInput.value )
						{
							try
							{
								const match = await findExactMatchByAddress( addressInput.value );
								if( match )
								{
									console.log( 'Found matching location from spreadsheet!', match );
									autoFillFormFields( match );
									showMessage( 'success', 'Location info auto-filled from records!' );
								}
							}
							catch( autocompleteError )
							{
								// Non-critical error - log but don't fail GPS functionality
								console.error( 'Autocomplete lookup failed (non-critical):', autocompleteError );
							}
						}

						const latFixed = lat.toFixed( 4 );
						const lonFixed = lon.toFixed( 4 );
						gpsBtn.innerHTML = `
            Location Set (GPS)
            <div class="text-xs font-normal opacity-75 mt-1">
                Lat: ${ latFixed }, Lon: ${ lonFixed }
            </div>
        `;
						manualAddressFields.classList.remove( 'hidden' );
						showAddressBtn.classList.add( 'hidden' );
						document.getElementById( 'label' ).focus();
						gpsBtn.classList.remove( 'bg-yellow-500' );
						gpsBtn.classList.add( 'bg-green-600' ); // Success color
						gpsBtn.disabled = false;
					}, ( error ) =>
					{
						gpsErrorMsg.textContent = `Could not get location: ${ error.message }`;
						gpsBtn.textContent = 'Use My GPS Location';
						gpsBtn.classList.remove( 'bg-yellow-500', 'bg-green-600' );
						gpsBtn.classList.add( 'bg-red-500' );
						gpsBtn.disabled = false;
						latInput.value = '';
						lonInput.value = '';
						manualAddressFields.classList.remove( 'hidden' );
						showAddressBtn.classList.add( 'hidden' );
						addressInput.focus();
					}, {
						enableHighAccuracy: true,
						timeout: 10000,
						maximumAge: 0
					} );
				}


				// Validation helper: flash field red and set focus
				function highlightInvalidField( fieldId, errorMessage )
				{
					const field = document.getElementById( fieldId );
					if( !field ) return;

					// Show error message
					showMessage( 'error', errorMessage );

					// Set persistent red background
					field.style.backgroundColor = '#fecaca'; // Light red

					// Flash animation (3 times)
					let flashCount = 0;
					const flashInterval = setInterval( () =>
					{
						field.style.backgroundColor = flashCount % 2 === 0 ? '#fef2f2' : '#fecaca';
						flashCount++;
						if( flashCount >= 6 ) // 3 full flashes (on/off/on/off/on/off)
						{
							clearInterval( flashInterval );
							field.style.backgroundColor = '#fecaca'; // Leave it red
						}
					}, 200 ); // Flash every 200ms

					// Focus the field
					field.focus();
				}

				// Clear all validation highlighting
				function clearValidationHighlights()
				{
					const allInputs = form.querySelectorAll( 'input, select, textarea' );
					allInputs.forEach( input =>
					{
						input.style.backgroundColor = '';
					} );
				}

				async function handleFormSubmit( e )
				{
					e.preventDefault();

					// Clear previous validation highlights
					clearValidationHighlights();

					// Check HTML5 validation first
					if( !form.checkValidity() )
					{
						// Find first invalid field
						const invalidField = form.querySelector( ':invalid' );
						if( invalidField )
						{
							const fieldName = invalidField.name || invalidField.id;
							const label = form.querySelector( `label[for="${ invalidField.id }"]` )?.textContent || fieldName;
							highlightInvalidField( invalidField.id, `Please fill out the ${ label } field.` );
						}
						return;
					}

					const formData = new FormData( form );
					const contactName = formData.get( 'contactName' ).trim();
					const contactEmail = formData.get( 'contactEmail' ).trim();
					const contactPhone = formData.get( 'contactPhone' ).trim();

					if( !contactName )
					{
						highlightInvalidField( 'contactName', 'Please enter a Location Contact Name.' );
						return; // Stop the submission
					}
					if( !contactEmail && !contactPhone )
					{
						// Highlight the first empty required field
						if( !contactEmail )
						{
							highlightInvalidField( 'contactEmail', 'Please provide either a Contact Email or a Contact Phone.' );
						}
						else
						{
							highlightInvalidField( 'contactPhone', 'Please provide either a Contact Email or a Contact Phone.' );
						}
						return; // Stop the submission
					}

					// Validate phone format if provided
					if( contactPhone )
					{
						const phonePattern = /^[\d\s().+-]+$/;
						if( !phonePattern.test( contactPhone ) )
						{
							highlightInvalidField( 'contactPhone', 'Phone number must contain only digits, spaces, hyphens, parentheses, dots, or plus signs.' );
							return;
						}
					}
					if( !auth.currentUser || auth.currentUser.isAnonymous )
					{
						showMessage( 'error', 'You must be signed in to submit this form.' );
						console.error( 'Client Error: Submission attempted while user is logged out or anonymous.' );
						return;
					}
					if( !scannedBoxId )
					{
						return;
					}
					submitBtn.disabled = true;
					submitBtn.textContent = 'Submitting...';
					showMessage( '', '' );

					// Get current user's displayName (preserves original casing)
					const currentUser = auth.currentUser;
					const displayName = currentUser?.displayName || currentUser?.email || 'Unknown';

					const payload = {
						boxId: scannedBoxId,
						label: formData.get( 'label' ),
						address: formData.get( 'address' ),
						city: formData.get( 'city' ),
						county: formData.get( 'county' ),
						state: formData.get( 'state' ),
						postalcode: formData.get( 'postalcode' ),
						boxes: 1,
						passcode: '', // No passcode needed - user is already authorized
						displayName: displayName, // Pass displayName explicitly
						contactName: contactName,
						contactEmail: contactEmail,
						contactPhone: contactPhone,
						lat: formData.get( 'lat' ) ? parseFloat( formData.get( 'lat' ) ) : null,
						lon: formData.get( 'lon' ) ? parseFloat( formData.get( 'lon' ) ) : null
					};
					console.log( 'Client: Submitting form with payload:', payload );
					try
					{
						const provisionBoxV2 = httpsCallable( functions, 'provisionBoxV2' );
						const result = await provisionBoxV2( payload );
						const newBoxId = result.data.boxId;

						form.reset();
						boxIdDisplay.textContent = scannedBoxId;
						setTimeout( () =>
						{
							// Add newBox parameter to trigger cache refresh on status page
							window.location.href = `/status/?id=${ newBoxId }&newBox=true`;
						}, 1000 );
					}
					catch( error )
					{
						console.error( 'Error submitting location:', error );
						let displayMessage = `Submission failed: ${ error.message || 'An unknown error occurred.' }`;
						if( error.code )
						{
							displayMessage = `Error (${ error.code }): ${ error.message }`;
						}
						else if( error.name === 'FirebaseError' && error.message.includes( 'permission-denied' ) )
						{
							displayMessage = 'Permission Denied: Please check your authorization.';
						}
						else if( error.name === 'FirebaseError' && error.message.includes( 'UNAUTHENTICATED' ) )
						{
							displayMessage = 'Authentication Required: Please sign out and sign in again, then retry.';
						}
						showMessage( 'error', displayMessage );
						submitBtn.disabled = false;
						submitBtn.textContent = 'Submit Location';
					}
				}

				function init()
				{
					const params = new URLSearchParams( window.location.search );
					scannedBoxId = params.get( 'id' );
					if( !scannedBoxId )
					{
						boxIdDisplay.textContent = 'ID NOT FOUND';
						showMessage( 'error', 'No Box ID found in URL. Please scan a valid QR code.' );
						submitBtn.disabled = true;
					}
					else
					{
						boxIdDisplay.textContent = scannedBoxId;
					}
					isAuthorizedVolunteer = httpsCallable( functions, 'isAuthorizedVolunteerV2' );
					gpsBtn.onclick = getGeoLocation;
					showAddressBtn.onclick = () =>
					{
						gpsErrorMsg.textContent = '';
						manualAddressFields.classList.remove( 'hidden' );
						showAddressBtn.classList.add( 'hidden' );
						addressInput.focus();
					};
					form.onsubmit = handleFormSubmit;
				
				// Setup autocomplete on multiple fields
				const labelInput = document.getElementById( 'label' );
				const addressInput = document.getElementById( 'address' );
				const contactNameInput = document.getElementById( 'contactName' );
				const contactPhoneInput = document.getElementById( 'contactPhone' );
				const contactEmailInput = document.getElementById( 'contactEmail' );

				// Helper function to handle autocomplete selection
				const handleAutocompleteSelect = ( selected ) =>
				{
					console.log( 'User selected from autocomplete:', selected );
					autoFillFormFields( selected );

					// Auto-expand address fields if they're hidden
					if( manualAddressFields.classList.contains( 'hidden' ) )
					{
						manualAddressFields.classList.remove( 'hidden' );
						showAddressBtn.classList.add( 'hidden' );
					}

					showMessage( 'success', 'Location info filled from records!' );
				};

				// Label field autocomplete
				createAutocomplete( labelInput, searchByLabel, handleAutocompleteSelect );

				// Address field autocomplete
				createAutocomplete( addressInput, searchByAddress, handleAutocompleteSelect );

				// Contact name field autocomplete
				createAutocomplete( contactNameInput, searchByContactName, handleAutocompleteSelect );

				// Contact phone field autocomplete
				createAutocomplete( contactPhoneInput, searchByContactPhone, handleAutocompleteSelect );

				// Contact email field autocomplete
				createAutocomplete( contactEmailInput, searchByContactEmail, handleAutocompleteSelect );
					onAuthStateChanged( auth, async( user ) =>
					{
						// Redirect to login if not authenticated or anonymous
						if( !user || user.isAnonymous )
						{
							const returnUrl = encodeURIComponent( window.location.pathname + window.location.search );
							window.location.href = `/login/?returnUrl=${ returnUrl }`;
							return;
						}

						// Check authorization
						try
						{
							const result = await isAuthorizedVolunteer();
							if( !result.data.isAuthorized )
							{
								// Not authorized - redirect to authorize page with boxId
								window.location.href = `/authorize?boxId=${ scannedBoxId }`;
								return;
							}
						}
						catch( error )
						{
							console.error( 'Authorization check failed:', error );
							// On error, redirect to authorize page
							window.location.href = `/authorize?boxId=${ scannedBoxId }`;
							return;
						}

						// User is authenticated and authorized - proceed
						if( !scannedBoxId )
						{
							form.classList.add( 'hidden' );
							showMessage( 'error', 'No Box ID found in URL. Cannot check status.' );
							return;
						}

						try
						{
							const locRef = doc( db, locationsCollectionPath, scannedBoxId );
							const locSnap = await getDoc( locRef );
							if( locSnap.exists() )
							{
								form.classList.add( 'hidden' );
								showMessage( 'success', 'This box is already set up. Redirecting to status page...' );
								window.location.href = `/status/?id=${ scannedBoxId }`;
								return;
							}

							// Box doesn't exist, show form
							form.classList.remove( 'hidden' );
						}
						catch( error )
						{
							form.classList.add( 'hidden' );
							showMessage( 'error', `An error occurred: ${ error.message }` );
						}
					} );
				}

				init();
			</script>
		</main>

		<div id="footer-placeholder"></div>
		<script src="/js/loader.min.js" defer></script>
	</body>
</html>