<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width-width, initial-scale=1.0">
		<title>Set Up New Location</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<link rel="stylesheet" href="/style.css?v=1.0.7">
	</head>
	<body class="bg-gray-100">

		<div id="header-placeholder"></div>

		<div class="form-wrapper">
			<div class="form-container">
				<h1 class="text-2xl font-bold text-center mb-6 text-gray-800">Set Up New Box Location</h1>

				<div id="auth-container">
					<p class="mb-4">You must be signed in to set up a new location.</p>

					<button id="sign-in-btn" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
						Sign In with Google
					</button>

					<button id="show-email-setup-btn" class="text-sm text-gray-600 hover:text-gray-900 mt-3">
						... or click <span class="text-blue-600 underline">here</span> to setup without Google
					</button>

					<div id="or-divider" class="my-4 text-gray-500 font-semibold hidden">-- OR --</div>

					<div id="email-auth-section" class="mt-4 p-4 border rounded-lg bg-gray-50 hidden">

						<h2 class="text-xl font-bold mb-4 text-gray-700" id="email-auth-title">Create
							<label for="auth-email">Account</label>
							with
							<label for="auth-password">Username</label>
						</h2>

						<input type="text" id="auth-email" placeholder="Username" class="w-full p-2 mb-2 border rounded">

						<p id="password-hint" class="text-xs text-gray-500 mb-4">
							Please pick a new password.
						</p>

						<input type="password" id="auth-password" placeholder="Password" class="w-full p-2 mb-3 border rounded">

						<span id="toggle-password" class="block text-right text-sm text-blue-600 hover:underline cursor-pointer -mt-2 mb-3" style="display: block; text-align: right; font-size: 0.875rem; color: #3b82f6; cursor: pointer; margin-top: -0.5rem; margin-bottom: 0.75rem;">
    show password
</span>
						<button id="email-sign-in-btn" class="w-full px-6 py-3 bg-marine-blue text-white rounded-lg font-semibold hover:bg-blue-800 transition hidden">
							Sign In
						</button>
						<button id="email-sign-up-btn" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
							Create Account
						</button>

						<p class="text-sm mt-3">
							<button id="toggle-sign-up-btn" class="font-medium"> Already have an account?
								<span class="text-marine-blue underline">Sign In</span>
							</button>
						</p>
					</div>

				</div>
				<form id="new-location-form" class="hidden">

					<div class="form-group">
						<label>Box ID to Set Up</label>
						<div id="box-id-display">Loading...</div>
					</div>

					<div class="form-group">
						<label for="passcode">Setup Code</label>
						<input type="password" id="passcode" name="passcode" required>

						<span id="toggle-passcode" style="display: block; text-align: right; font-size: 0.875rem; color: #3b82f6; cursor: pointer;  margin-bottom: 0.75rem;">
       show code
   </span>
					</div>

					<div class="my-6 h-1 bg-gray-300"></div>

					<div class="mb-5">
						<button id="gps-btn" type="button" class="w-3/4 block mx-auto py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-md transition duration-200">
							Use My GPS Location
						</button>
						<div id="gps-error-msg" class="text-center text-sm text-red-600 mt-2"></div>
					</div>

					<div id="show-address-btn" class="text-center my-4 text-gray-700 cursor-pointer hover:text-gray-900">
						Click <span class="underline font-medium">here</span> to type in the address
					</div>

					<input type="hidden" id="lat" name="lat">
					<input type="hidden" id="lon" name="lon">
					<input type="hidden" id="county" name="county">
					<input type="hidden" id="postalcode" name="postalcode">

					<div id="manual-address-fields" class="hidden">
						<div class="form-group">
							<label for="address">Full Street Address</label>
							<input type="text" id="address" name="address" required>
						</div>
						<div class="form-group">
							<label for="city">City</label>
							<input type="text" id="city" name="city">
						</div>
						<div class="form-group">
							<label for="state">State</label>
							<input type="text" id="state" name="state" value="GA" required>
						</div>
					</div>

					<div class="form-group" style="display: none;">
						<label for="boxes">Number of Boxes</label>
						<input type="number" id="boxes" name="boxes" value="1" min="1">
					</div>

					<div class="my-6 h-1 bg-gray-300"></div>

					<div class="form-group">
						<label for="label">Location Name (Label)</label>
						<input type="text" id="label" name="label" required>
					</div>

					<div class="form-group">
						<label for="contactName">Contact Name</label>
						<input type="text" id="contactName" name="contactName" required>
					</div>

					<div class="form-group">
						<label for="contactEmail">Contact Email</label>
						<input type="email" id="contactEmail" name="contactEmail">
					</div>

					<div class="form-group">
						<label for="contactPhone">Contact Phone</label>
						<input type="tel" id="contactPhone" name="contactPhone">
					</div>

					<div class="form-group">
						<button id="submit-btn" type="submit">Submit Location</button>
					</div>

					<div id="message-container"></div>

					<div class="text-center">
						<p id="user-display" class="text-sm text-gray-500 mb-2"></p>

						<button id="sign-out-btn" type="button" class="mt-4 text-sm text-gray-600 hover:text-gray-900">
							Sign Out
						</button>
					</div>
				</form>
			</div>

			<script type="module">

				import { auth, db, functions, locationsCollectionPath } from '../js/firebase-init.js';
				import {
					onAuthStateChanged,
					GoogleAuthProvider,
					signInWithPopup,
					signOut,
					createUserWithEmailAndPassword,
					signInWithEmailAndPassword
				} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
				import {
					getFirestore,
					doc,
					getDoc
				} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
				import {
					getFunctions,
					httpsCallable
				} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js';


				let scannedBoxId = null;
				let provisionBox, isAuthorizedVolunteer; // Firebase function refs


				const authContainer = document.getElementById( 'auth-container' );
				const signInBtn = document.getElementById( 'sign-in-btn' );
				const signOutBtn = document.getElementById( 'sign-out-btn' );
				const userDisplay = document.getElementById( 'user-display' );
				const form = document.getElementById( 'new-location-form' );
				const messageContainer = document.getElementById( 'message-container' );
				const submitBtn = document.getElementById( 'submit-btn' );
				const boxIdDisplay = document.getElementById( 'box-id-display' );
				const latInput = document.getElementById( 'lat' );
				const lonInput = document.getElementById( 'lon' );
				const gpsBtn = document.getElementById( 'gps-btn' );
				const addressInput = document.getElementById( 'address' );
				const cityInput = document.getElementById( 'city' );
				const stateInput = document.getElementById( 'state' );
				const countyInput = document.getElementById( 'county' );
				const postalCodeInput = document.getElementById( 'postalcode' );
				const showAddressBtn = document.getElementById( 'show-address-btn' );
				const manualAddressFields = document.getElementById( 'manual-address-fields' );
				const gpsErrorMsg = document.getElementById( 'gps-error-msg' );
				const passcode = document.getElementById( 'passcode' );
				const togglePasscode = document.getElementById( 'toggle-passcode' );

				const showEmailSetupBtn = document.getElementById( 'show-email-setup-btn' );
				const orDivider = document.getElementById( 'or-divider' );
				const emailAuthSection = document.getElementById( 'email-auth-section' );
				const emailAuthTitle = document.getElementById( 'email-auth-title' );
				const authEmail = document.getElementById( 'auth-email' );
				const authPassword = document.getElementById( 'auth-password' );
				const togglePassword = document.getElementById( 'toggle-password' );
				const passwordHint = document.getElementById( 'password-hint' ); // New
				const emailSignInBtn = document.getElementById( 'email-sign-in-btn' );
				const emailSignUpBtn = document.getElementById( 'email-sign-up-btn' );
				const toggleSignUpBtn = document.getElementById( 'toggle-sign-up-btn' );


				function showMessage( type, text )
				{
					messageContainer.innerHTML = `<div class="message ${ type }">${ text }</div>`;
				}


				async function getGeoLocation()
				{

					showMessage( '', '' );
					gpsErrorMsg.textContent = '';
					gpsBtn.disabled = true;


					gpsBtn.textContent = 'Searching...';
					gpsBtn.classList.remove( 'bg-red-500', 'bg-green-600' );
					gpsBtn.classList.add( 'bg-yellow-500' );

					if( !navigator.geolocation )
					{
						gpsErrorMsg.textContent = 'Geolocation is not supported by this browser.';
						gpsBtn.disabled = false;
						gpsBtn.textContent = 'Use My GPS Location';
						gpsBtn.classList.remove( 'bg-yellow-500' );
						gpsBtn.classList.add( 'bg-red-500' );
						manualAddressFields.classList.remove( 'hidden' );
						showAddressBtn.classList.add( 'hidden' );
						addressInput.focus();
						return;
					}


					navigator.geolocation.getCurrentPosition( async( position ) =>
					{
						const lat = position.coords.latitude;
						const lon = position.coords.longitude;


						latInput.value = lat;
						lonInput.value = lon;

						try
						{

							gpsBtn.textContent = 'Got GPS, Getting Address...';
							const geoApiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${ lat }&lon=${ lon }`;

							const response = await fetch( geoApiUrl );
							if( !response.ok )
							{
								throw new Error( `Address lookup failed (status: ${ response.status })` );
							}
							const data = await response.json();
							console.log( 'Reverse Geocode Response:', data ); // For your debugging

							if( data && data.address )
							{
								const addr = data.address;
								addressInput.value = `${ addr.house_number || '' } ${ addr.road || '' }`.trim();
								cityInput.value = addr.city || addr.town || addr.village || '';
								stateInput.value = addr.state || 'GA'; // Use found state, default to GA
								countyInput.value = addr.county || '';
								postalCodeInput.value = addr.postcode || '';

								const labelInput = document.getElementById( 'label' );
								if( labelInput.value === '' )
								{ // Only if not already filled
									labelInput.value = addr.amenity || addr.shop || addr.building || addr.office || '';
								}

								showMessage( 'success', 'Location and Address captured!' );
							}
							else
							{
								throw new Error( 'Address not found in API response.' );
							}

						}
						catch( geoError )
						{
							gpsErrorMsg.textContent = 'Got GPS, but failed to get address. Please type it manually.';
						}


						const latFixed = lat.toFixed( 4 );
						const lonFixed = lon.toFixed( 4 );

						gpsBtn.innerHTML = `
            Location Set (GPS)
            <div class="text-xs font-normal opacity-75 mt-1">
                Lat: ${ latFixed }, Lon: ${ lonFixed }
            </div>
        `;

						manualAddressFields.classList.remove( 'hidden' );
						showAddressBtn.classList.add( 'hidden' );


						document.getElementById( 'label' ).focus();

						gpsBtn.classList.remove( 'bg-yellow-500' );
						gpsBtn.classList.add( 'bg-green-600' ); // Success color
						gpsBtn.disabled = false;

					}, ( error ) =>
					{
						gpsErrorMsg.textContent = `Could not get location: ${ error.message }`;
						gpsBtn.textContent = 'Use My GPS Location';
						gpsBtn.classList.remove( 'bg-yellow-500', 'bg-green-600' );
						gpsBtn.classList.add( 'bg-red-500' );
						gpsBtn.disabled = false;
						latInput.value = '';
						lonInput.value = '';
						manualAddressFields.classList.remove( 'hidden' );
						showAddressBtn.classList.add( 'hidden' );
						addressInput.focus();
					}, {
						enableHighAccuracy: true,
						timeout: 10000, // Increased timeout to 10s
						maximumAge: 0
					} );
				}

				function showAuthMessage( type, text )
				{
					const emailAuthSection = document.getElementById( 'email-auth-section' );
					let msgDiv = document.getElementById( 'auth-msg' );
					if( !msgDiv )
					{
						msgDiv = document.createElement( 'div' );
						msgDiv.id = 'auth-msg';

						emailAuthSection.insertBefore( msgDiv, authEmail );
					}
					msgDiv.innerHTML = `<div class="message ${ type } mt-3 mb-3">${ text }</div>`;
				}

				function clearAuthMessage()
				{
					const msgDiv = document.getElementById( 'auth-msg' );
					if( msgDiv )
					{
						msgDiv.remove();
					}
				}


				async function handleEmailSignIn()
				{
					clearAuthMessage();
					const username = authEmail.value; // Get username
					const password = authPassword.value;
					if( !username || !password )
					{
						showAuthMessage( 'error', 'Please enter both username and password.' );
						return;
					}


					if( username.includes( '@' ) )
					{
						showAuthMessage( 'error', 'Username cannot contain "@" symbol. Just enter the username.' );
						return;
					}


					const email = `${ username }@toysfortots.mcl1311.com`;

					try
					{
						await signInWithEmailAndPassword( auth, email, password );
					}
					catch( error )
					{
						console.error( 'Email Sign In Error:', error );
						if( error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential' )
						{
							showAuthMessage( 'error', 'Sign in failed: Invalid username or password.' );
						}
						else
						{
							showAuthMessage( 'error', `Sign in failed: ${ error.message }` );
						}
					}
				}

				async function handleEmailSignUp()
				{
					clearAuthMessage();
					const username = authEmail.value; // Get username
					const password = authPassword.value;


					if( !username || !password )
					{ // <-- MODIFIED (removed retypePassword)
						showAuthMessage( 'error', 'Please fill out all fields.' );
						return;
					}


					if( username.includes( '@' ) )
					{
						showAuthMessage( 'error', 'Username cannot contain "@" symbol.' );
						return;
					}

					if( password.length < 6 )
					{
						showAuthMessage( 'error', 'Password must be at least 6 characters.' );
						return;
					}

					const email = `${ username }@toysfortots.mcl1311.com`;

					try
					{
						await createUserWithEmailAndPassword( auth, email, password );
					}
					catch( error )
					{
						if( error.code === 'auth/email-already-in-use' )
						{
							showAuthMessage( 'error', 'Sign up failed: This username is already taken.' );
						}
						else
						{
							showAuthMessage( 'error', `Sign up failed: ${ error.message }` );
						}
					}
				}

				function toggleEmailAuthMode()
				{
					clearAuthMessage();

					authPassword.value = '';
					const isSignUpMode = emailSignInBtn.classList.contains( 'hidden' );

					if( isSignUpMode )
					{
						emailAuthTitle.textContent = 'Sign In with Username';
						emailSignInBtn.classList.remove( 'hidden' );
						emailSignUpBtn.classList.add( 'hidden' );
						passwordHint.classList.add( 'hidden' );
						toggleSignUpBtn.innerHTML = 'New user? <span class="text-marine-blue underline">Create an account</span>';
					}
					else
					{
						emailAuthTitle.textContent = 'Create Account with Username';
						emailSignInBtn.classList.add( 'hidden' );
						emailSignUpBtn.classList.remove( 'hidden' );
						passwordHint.classList.remove( 'hidden' );
						toggleSignUpBtn.innerHTML = 'Already have an account? <span class="text-marine-blue underline">Sign In</span>';
					}
				}


				function showEmailSetup()
				{
					emailAuthSection.classList.remove( 'hidden' );
					orDivider.classList.remove( 'hidden' );
					showEmailSetupBtn.classList.add( 'hidden' ); // Hide the button after clicking
				}


				async function handleFormSubmit( e )
				{
					e.preventDefault();


					const formData = new FormData( form );
					const contactName = formData.get( 'contactName' ).trim();
					const contactEmail = formData.get( 'contactEmail' ).trim();
					const contactPhone = formData.get( 'contactPhone' ).trim();


					if( !contactName )
					{
						showMessage( 'error', 'Please enter a Location Contact Name.' );
						return; // Stop the submission
					}

					if( !contactEmail && !contactPhone )
					{
						showMessage( 'error', 'Please provide either a Contact Email or a Contact Phone.' );
						return; // Stop the submission
					}


					if( !auth.currentUser || auth.currentUser.isAnonymous )
					{
						showMessage( 'error', 'You must be signed in to submit this form.' );
						console.error( 'Client Error: Submission attempted while user is logged out or anonymous.' );
						return;
					}

					if( !scannedBoxId )
					{
						return;
					}

					submitBtn.disabled = true;
					submitBtn.textContent = 'Submitting...';
					showMessage( '', '' );


					const payload = {
						boxId: scannedBoxId,
						label: formData.get( 'label' ),
						address: formData.get( 'address' ),
						city: formData.get( 'city' ),
						county: formData.get( 'county' ),
						state: formData.get( 'state' ),
						postalcode: formData.get( 'postalcode' ),
						boxes: 1,
						passcode: formData.get( 'passcode' ),


						contactName: contactName,
						contactEmail: contactEmail,
						contactPhone: contactPhone,

						lat: formData.get( 'lat' ) ? parseFloat( formData.get( 'lat' ) ) : null,
						lon: formData.get( 'lon' ) ? parseFloat( formData.get( 'lon' ) ) : null
					};
					console.log( 'Client: Submitting form with payload:', payload );
					try
					{

						const provisionBoxV2 = httpsCallable( functions, 'provisionBoxV2' );
						const result = await provisionBoxV2( payload );
						const newBoxId = result.data.boxId;
						form.reset();
						boxIdDisplay.textContent = scannedBoxId;

						setTimeout( () =>
						{
							window.location.href = `/status/?id=${ newBoxId }`;
						}, 2000 );

					}
					catch( error )
					{
						console.error( 'Error submitting location:', error );
						let displayMessage = `Submission failed: ${ error.message || 'An unknown error occurred.' }`;
						if( error.code )
						{
							displayMessage = `Error (${ error.code }): ${ error.message }`;
						}
						else if( error.name === 'FirebaseError' && error.message.includes( 'permission-denied' ) )
						{
							displayMessage = 'Permission Denied: Check the volunteer passcode.';
						}
						else if( error.name === 'FirebaseError' && error.message.includes( 'UNAUTHENTICATED' ) )
						{
							displayMessage = 'Authentication Required: Please sign out and sign in again, then retry.';
						}

						showMessage( 'error', displayMessage );
						submitBtn.disabled = false;
						submitBtn.textContent = 'Submit Location';
					}
				}

				function init()
				{
					const params = new URLSearchParams( window.location.search );
					scannedBoxId = params.get( 'id' );

					if( !scannedBoxId )
					{
						boxIdDisplay.textContent = 'ID NOT FOUND';
						showMessage( 'error', 'No Box ID found in URL. Please scan a valid QR code.' );
						submitBtn.disabled = true;
					}
					else
					{
						boxIdDisplay.textContent = scannedBoxId;
					}


					provisionBox = httpsCallable( functions, 'provisionBoxV2' );
					isAuthorizedVolunteer = httpsCallable( functions, 'isAuthorizedVolunteerV2' );

					const provider = new GoogleAuthProvider();

					showEmailSetupBtn.onclick = showEmailSetup;
					emailSignInBtn.onclick = handleEmailSignIn;
					emailSignUpBtn.onclick = handleEmailSignUp;
					toggleSignUpBtn.onclick = toggleEmailAuthMode;
					gpsBtn.onclick = getGeoLocation;

					togglePassword.onclick = function()
					{
						const type = authPassword.getAttribute( 'type' ) === 'password' ? 'text' : 'password';
						authPassword.setAttribute( 'type', type );
						this.textContent = ( type === 'password' ) ? 'show password' : 'hide password';
					};

					togglePasscode.onclick = function()
					{
						const type = passcode.getAttribute( 'type' ) === 'password' ? 'text' : 'password';
						passcode.setAttribute( 'type', type );
						this.textContent = ( type === 'password' ) ? 'show code' : 'hide code';
					};

					showAddressBtn.onclick = () =>
					{
						gpsErrorMsg.textContent = '';
						manualAddressFields.classList.remove( 'hidden' );
						showAddressBtn.classList.add( 'hidden' );
						addressInput.focus();
					};

					signInBtn.onclick = () => signInWithPopup( auth, provider );
					signOutBtn.onclick = () => signOut( auth );
					form.onsubmit = handleFormSubmit;

					onAuthStateChanged( auth, async( user ) =>
					{
						if( user && !user.isAnonymous )
						{
							clearAuthMessage();

							if( !scannedBoxId )
							{
								authContainer.classList.add( 'hidden' );
								form.classList.add( 'hidden' );
								showMessage( 'error', 'No Box ID found in URL. Cannot check status.' );
								return;
							}

							try
							{
								const locRef = doc( db, locationsCollectionPath, scannedBoxId );
								const locSnap = await getDoc( locRef );

								if( locSnap.exists() )
								{
									authContainer.classList.add( 'hidden' );
									form.classList.add( 'hidden' );
									showMessage( 'success', 'This box is already set up. Redirecting to status page...' );

									window.location.href = `/status/?id=${ scannedBoxId }`;
									return;
								}

								authContainer.classList.add( 'hidden' );
								form.classList.remove( 'hidden' );
								if( user.email )
								{
									let displayName = user.email;
									const atIndex = displayName.indexOf( '@' );
									if( atIndex !== -1 )
									{
										displayName = displayName.substring( 0, atIndex );
									}
									userDisplay.textContent = `Signed in as: ${ displayName }`;
									userDisplay.classList.remove( 'hidden' );
								}
								else
								{

									userDisplay.classList.add( 'hidden' );
								}
								showEmailSetupBtn.classList.remove( 'hidden' ); // Ensure this is visible on auth -> form transition

								const passcodeGroup = passcode.parentElement;
								const passcodeLabel = passcodeGroup.querySelector( 'label' );

								passcodeLabel.textContent = 'Verifying authorization...';
								const result = await isAuthorizedVolunteer();

								if( result.data.isAuthorized )
								{
									passcodeGroup.classList.add( 'hidden' );
									passcode.required = false;
									passcode.value = '';
									passcodeLabel.textContent = 'Password (Authorized)';
								}
								else
								{
									passcodeGroup.classList.remove( 'hidden' );
									passcode.required = true;
									passcodeLabel.textContent = 'One time setup code';
								}

							}
							catch( error )
							{
								authContainer.classList.add( 'hidden' );
								form.classList.add( 'hidden' );
								showMessage( 'error', `An error occurred: ${ error.message }` );
							}

						}
						else
						{

							authContainer.classList.remove( 'hidden' );
							form.classList.add( 'hidden' );
							clearAuthMessage();
							userDisplay.textContent = '';
							userDisplay.classList.add( 'hidden' );


							showEmailSetupBtn.classList.remove( 'hidden' );

							emailAuthSection.classList.add( 'hidden' );
							orDivider.classList.add( 'hidden' );


							if( !emailSignInBtn.classList.contains( 'hidden' ) )
							{
								toggleEmailAuthMode(); // Toggle it back to Sign Up
							}

							document.getElementById( 'passcode' ).parentElement.classList.remove( 'hidden' );
							document.getElementById( 'passcode' ).required = true;

							if( user && user.isAnonymous )
							{
								signOut( auth );
							}
						}
					} );
				}

				init();
			</script>

		</div>
		<div id="footer-placeholder"></div>
		<script src="/loader.js" defer></script>
	</body>
</html>