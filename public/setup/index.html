<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width-width, initial-scale=1.0">
		<title>Set Up New Location</title>
		<link rel="stylesheet" href="/css/style.css?v=1.0.7">
	</head>
	<body class="bg-gray-100">
		<div id="header-placeholder"></div>
		<div class="form-wrapper">
			<div class="form-container">
				<h1>Set Up New Box Location</h1>

				<form id="new-location-form" class="hidden">
					<div class="form-group">
						<label>Box ID to Set Up</label>
						<div id="box-id-display">Loading...</div>
					</div>
					<div class="form-group">
						<label for="passcode">Setup Code</label>
						<input type="password" id="passcode" name="passcode" required>
						<span id="toggle-passcode" style="display: block; text-align: right; font-size: 0.875rem; color: #3b82f6; cursor: pointer;  margin-bottom: 0.75rem;">show code</span>
					</div>
					<div class="hr-divider"></div>
					<div style="margin-bottom: 1.25rem;">
						<button id="gps-btn" type="button">
							Use My GPS Location
						</button>
						<div id="gps-error-msg"></div>
					</div>
					<div id="show-address-btn">
						Click <span>here</span> to type in the address
					</div>
					<input type="hidden" id="lat" name="lat">
					<input type="hidden" id="lon" name="lon">
					<input type="hidden" id="county" name="county">
					<input type="hidden" id="postalcode" name="postalcode">
					<div id="manual-address-fields" class="hidden">
						<div class="form-group">
							<label for="address">Full Street Address</label>
							<input type="text" id="address" name="address" required>
						</div>
						<div class="form-group">
							<label for="city">City</label>
							<input type="text" id="city" name="city">
						</div>
						<div class="form-group">
							<label for="state">State</label>
							<input type="text" id="state" name="state" value="GA" required>
						</div>
					</div>
					<div class="form-group" style="display: none;">
						<label for="boxes">Number of Boxes</label>
						<input type="number" id="boxes" name="boxes" value="1" min="1">
					</div>
					<div class="hr-divider"></div>
					<div class="form-group">
						<label for="label">Location Name (Label)</label>
						<input type="text" id="label" name="label" required>
					</div>
					<div class="form-group">
						<label for="contactName">Contact Name</label>
						<input type="text" id="contactName" name="contactName" required>
					</div>
					<div class="form-group">
						<label for="contactEmail">Contact Email</label>
						<input type="email" id="contactEmail" name="contactEmail">
					</div>
					<div class="form-group">
						<label for="contactPhone">Contact Phone</label>
						<input type="tel" id="contactPhone" name="contactPhone">
					</div>
					<div class="form-group">
						<button id="submit-btn" type="submit">Submit Location</button>
					</div>
					<div id="message-container"></div>
					<div style="text-align: center;"><p id="user-display"></p>
						<button id="sign-out-btn" type="button">
							Sign Out
						</button>
					</div>
				</form>
			</div>
			<script type="module">
				import { auth, db, functions, locationsCollectionPath } from '../js/firebase-init.js';
				import { showMessage } from '/js/utils.js';
				import {
					onAuthStateChanged,
					signOut
				} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
				import {
					doc,
					getDoc
				} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
				import {
					httpsCallable
				} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js';

				let scannedBoxId = null;
				let isAuthorizedVolunteer; // Firebase function ref
				const signOutBtn = document.getElementById( 'sign-out-btn' );
				const userDisplay = document.getElementById( 'user-display' );
				const form = document.getElementById( 'new-location-form' );
				const messageContainer = document.getElementById( 'message-container' );
				const submitBtn = document.getElementById( 'submit-btn' );
				const boxIdDisplay = document.getElementById( 'box-id-display' );
				const latInput = document.getElementById( 'lat' );
				const lonInput = document.getElementById( 'lon' );
				const gpsBtn = document.getElementById( 'gps-btn' );
				const addressInput = document.getElementById( 'address' );
				const cityInput = document.getElementById( 'city' );
				const stateInput = document.getElementById( 'state' );
				const countyInput = document.getElementById( 'county' );
				const postalCodeInput = document.getElementById( 'postalcode' );
				const showAddressBtn = document.getElementById( 'show-address-btn' );
				const manualAddressFields = document.getElementById( 'manual-address-fields' );
				const gpsErrorMsg = document.getElementById( 'gps-error-msg' );
				const passcode = document.getElementById( 'passcode' );
				const togglePasscode = document.getElementById( 'toggle-passcode' );


				async function getGeoLocation()
				{
					showMessage( '', '' );
					gpsErrorMsg.textContent = '';
					gpsBtn.disabled = true;
					gpsBtn.textContent = 'Searching...';
					gpsBtn.classList.remove( 'bg-red-500', 'bg-green-600' );
					gpsBtn.classList.add( 'bg-yellow-500' );
					if( !navigator.geolocation )
					{
						gpsErrorMsg.textContent = 'Geolocation is not supported by this browser.';
						gpsBtn.disabled = false;
						gpsBtn.textContent = 'Use My GPS Location';
						gpsBtn.classList.remove( 'bg-yellow-500' );
						gpsBtn.classList.add( 'bg-red-500' );
						manualAddressFields.classList.remove( 'hidden' );
						showAddressBtn.classList.add( 'hidden' );
						addressInput.focus();
						return;
					}
					navigator.geolocation.getCurrentPosition( async( position ) =>
					{
						const lat = position.coords.latitude;
						const lon = position.coords.longitude;
						latInput.value = lat;
						lonInput.value = lon;
						try
						{
							gpsBtn.textContent = 'Got GPS, Getting Address...';
							const geoApiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${ lat }&lon=${ lon }`;
							const response = await fetch( geoApiUrl );
							if( !response.ok )
							{
								throw new Error( `Address lookup failed (status: ${ response.status })` );
							}
							const data = await response.json();
							console.log( 'Reverse Geocode Response:', data ); // For your debugging
							if( data && data.address )
							{
								const addr = data.address;
								addressInput.value = `${ addr.house_number || '' } ${ addr.road || '' }`.trim();
								cityInput.value = addr.city || addr.town || addr.village || '';
								stateInput.value = addr.state || 'GA'; // Use found state, default to GA
								countyInput.value = addr.county || '';
								postalCodeInput.value = addr.postcode || '';
								const labelInput = document.getElementById( 'label' );
								if( labelInput.value === '' )
								{ // Only if not already filled
									labelInput.value = addr.amenity || addr.shop || addr.building || addr.office || '';
								}
								showMessage( 'success', 'Location and Address captured!' );
							}
							else
							{
								throw new Error( 'Address not found in API response.' );
							}
						}
						catch( geoError )
						{
							gpsErrorMsg.textContent = 'Got GPS, but failed to get address. Please type it manually.';
						}
						const latFixed = lat.toFixed( 4 );
						const lonFixed = lon.toFixed( 4 );
						gpsBtn.innerHTML = `
            Location Set (GPS)
            <div class="text-xs font-normal opacity-75 mt-1">
                Lat: ${ latFixed }, Lon: ${ lonFixed }
            </div>
        `;
						manualAddressFields.classList.remove( 'hidden' );
						showAddressBtn.classList.add( 'hidden' );
						document.getElementById( 'label' ).focus();
						gpsBtn.classList.remove( 'bg-yellow-500' );
						gpsBtn.classList.add( 'bg-green-600' ); // Success color
						gpsBtn.disabled = false;
					}, ( error ) =>
					{
						gpsErrorMsg.textContent = `Could not get location: ${ error.message }`;
						gpsBtn.textContent = 'Use My GPS Location';
						gpsBtn.classList.remove( 'bg-yellow-500', 'bg-green-600' );
						gpsBtn.classList.add( 'bg-red-500' );
						gpsBtn.disabled = false;
						latInput.value = '';
						lonInput.value = '';
						manualAddressFields.classList.remove( 'hidden' );
						showAddressBtn.classList.add( 'hidden' );
						addressInput.focus();
					}, {
						enableHighAccuracy: true,
						timeout: 10000,
						maximumAge: 0
					} );
				}


				async function handleFormSubmit( e )
				{
					e.preventDefault();
					const formData = new FormData( form );
					const contactName = formData.get( 'contactName' ).trim();
					const contactEmail = formData.get( 'contactEmail' ).trim();
					const contactPhone = formData.get( 'contactPhone' ).trim();
					if( !contactName )
					{
						showMessage( 'error', 'Please enter a Location Contact Name.' );
						return; // Stop the submission
					}
					if( !contactEmail && !contactPhone )
					{
						showMessage( 'error', 'Please provide either a Contact Email or a Contact Phone.' );
						return; // Stop the submission
					}
					if( !auth.currentUser || auth.currentUser.isAnonymous )
					{
						showMessage( 'error', 'You must be signed in to submit this form.' );
						console.error( 'Client Error: Submission attempted while user is logged out or anonymous.' );
						return;
					}
					if( !scannedBoxId )
					{
						return;
					}
					submitBtn.disabled = true;
					submitBtn.textContent = 'Submitting...';
					showMessage( '', '' );
					const payload = {
						boxId: scannedBoxId,
						label: formData.get( 'label' ),
						address: formData.get( 'address' ),
						city: formData.get( 'city' ),
						county: formData.get( 'county' ),
						state: formData.get( 'state' ),
						postalcode: formData.get( 'postalcode' ),
						boxes: 1,
						passcode: formData.get( 'passcode' ),
						contactName: contactName,
						contactEmail: contactEmail,
						contactPhone: contactPhone,
						lat: formData.get( 'lat' ) ? parseFloat( formData.get( 'lat' ) ) : null,
						lon: formData.get( 'lon' ) ? parseFloat( formData.get( 'lon' ) ) : null
					};
					console.log( 'Client: Submitting form with payload:', payload );
					try
					{
						const provisionBoxV2 = httpsCallable( functions, 'provisionBoxV2' );
						const result = await provisionBoxV2( payload );
						const newBoxId = result.data.boxId;
						form.reset();
						boxIdDisplay.textContent = scannedBoxId;
						setTimeout( () =>
						{
							window.location.href = `/status/?id=${ newBoxId }`;
						}, 2000 );
					}
					catch( error )
					{
						console.error( 'Error submitting location:', error );
						let displayMessage = `Submission failed: ${ error.message || 'An unknown error occurred.' }`;
						if( error.code )
						{
							displayMessage = `Error (${ error.code }): ${ error.message }`;
						}
						else if( error.name === 'FirebaseError' && error.message.includes( 'permission-denied' ) )
						{
							displayMessage = 'Permission Denied: Check the volunteer passcode.';
						}
						else if( error.name === 'FirebaseError' && error.message.includes( 'UNAUTHENTICATED' ) )
						{
							displayMessage = 'Authentication Required: Please sign out and sign in again, then retry.';
						}
						showMessage( 'error', displayMessage );
						submitBtn.disabled = false;
						submitBtn.textContent = 'Submit Location';
					}
				}

				function init()
				{
					const params = new URLSearchParams( window.location.search );
					scannedBoxId = params.get( 'id' );
					if( !scannedBoxId )
					{
						boxIdDisplay.textContent = 'ID NOT FOUND';
						showMessage( 'error', 'No Box ID found in URL. Please scan a valid QR code.' );
						submitBtn.disabled = true;
					}
					else
					{
						boxIdDisplay.textContent = scannedBoxId;
					}
					isAuthorizedVolunteer = httpsCallable( functions, 'isAuthorizedVolunteerV2' );
					gpsBtn.onclick = getGeoLocation;
					togglePasscode.onclick = function()
					{
						const type = passcode.getAttribute( 'type' ) === 'password' ? 'text' : 'password';
						passcode.setAttribute( 'type', type );
						this.textContent = ( type === 'password' ) ? 'show code' : 'hide code';
					};
					showAddressBtn.onclick = () =>
					{
						gpsErrorMsg.textContent = '';
						manualAddressFields.classList.remove( 'hidden' );
						showAddressBtn.classList.add( 'hidden' );
						addressInput.focus();
					};
					signOutBtn.onclick = () => signOut( auth );
					form.onsubmit = handleFormSubmit;
					onAuthStateChanged( auth, async( user ) =>
					{
						if( user && !user.isAnonymous )
						{
							if( !scannedBoxId )
							{
								form.classList.add( 'hidden' );
								showMessage( 'error', 'No Box ID found in URL. Cannot check status.' );
								return;
							}
							try
							{
								const locRef = doc( db, locationsCollectionPath, scannedBoxId );
								const locSnap = await getDoc( locRef );
								if( locSnap.exists() )
								{
									form.classList.add( 'hidden' );
									showMessage( 'success', 'This box is already set up. Redirecting to status page...' );
									window.location.href = `/status/?id=${ scannedBoxId }`;
									return;
								}
								form.classList.remove( 'hidden' );
								if( user.email )
								{
									let displayName = user.email;
									const atIndex = displayName.indexOf( '@' );
									if( atIndex !== -1 )
									{
										displayName = displayName.substring( 0, atIndex );
									}
									userDisplay.textContent = `Signed in as: ${ displayName }`;
									userDisplay.classList.remove( 'hidden' );
								}
								else
								{
									userDisplay.classList.add( 'hidden' );
								}
								const passcodeGroup = passcode.parentElement;
								const passcodeLabel = passcodeGroup.querySelector( 'label' );
								passcodeLabel.textContent = 'Verifying authorization...';
								const result = await isAuthorizedVolunteer();
								if( result.data.isAuthorized )
								{
									passcodeGroup.classList.add( 'hidden' );
									passcode.required = false;
									passcode.value = '';
									passcodeLabel.textContent = 'Password (Authorized)';
								}
								else
								{
									passcodeGroup.classList.remove( 'hidden' );
									passcode.required = true;
									passcodeLabel.textContent = 'One time setup code';
								}
							}
							catch( error )
							{
								form.classList.add( 'hidden' );
								showMessage( 'error', `An error occurred: ${ error.message }` );
							}
						}
						else
						{
							// User is not authenticated - redirect to login with return URL
							const currentUrl = window.location.pathname + window.location.search;
							window.location.href = '/login?returnUrl=' + encodeURIComponent( currentUrl );
						}
					} );
				}

				init();
			</script>
		</div>
		<div id="footer-placeholder"></div>
		<script src="/js/loader.js" defer></script>
	</body>
</html>