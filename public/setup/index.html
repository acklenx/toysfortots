<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Set Up New T4T Location</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			:root {
				--t4t-red: #cc0000;
				--marine-blue: #003366;
			}
			.form-container {
				max-width: 600px;
				margin: 30px auto;
				padding: 30px;
				background: white;
				border-radius: 8px;
				box-shadow: 0 2px 8px rgba(0,0,0,0.15);
			}
			.form-group {
				margin-bottom: 20px;
			}
			.form-group label {
				display: block;
				margin-bottom: 5px;
				font-weight: bold;
				color: #333;
			}
			.form-group input,
			.form-group select {
				width: 100%;
				padding: 10px;
				border: 1px solid #ccc;
				border-radius: 4px;
				box-sizing: border-box;
			}
			.form-group button {
				width: 100%;
				padding: 12px;
				background-color: var(--t4t-red);
				color: white;
				border: none;
				border-radius: 4px;
				font-size: 1rem;
				font-weight: bold;
				cursor: pointer;
				transition: background-color 0.2s;
			}
			.form-group button:hover {
				background-color: #a80000;
			}
			.form-group button:disabled {
				background-color: #ccc;
				cursor: not-allowed;
			}
			#auth-container {
				text-align: center;
				padding: 40px;
			}
			.message {
				text-align: center;
				padding: 15px;
				border-radius: 4px;
				margin-top: 20px;
				font-weight: 500;
			}
			.message.success {
				background-color: #d4edda;
				color: #155724;
			}
			.message.error {
				background-color: #f8d7da;
				color: #721c24;
			}
			#box-id-display {
				background-color: #f4f4f4;
				border: 1px solid #ddd;
				padding: 10px 15px;
				border-radius: 4px;
				text-align: center;
				font-family: monospace;
				font-size: 1.2rem;
				font-weight: bold;
				color: var(--marine-blue);
			}
		</style>
	</head>
	<body class="bg-gray-100">

		<div class="form-container">
			<h1 class="text-2xl font-bold text-center mb-6 text-gray-800">Set Up New Box Location</h1>

			<div id="auth-container">
				<p class="mb-4">You must be signed in to set up a new location.</p>
				<button id="sign-in-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">
					Sign In with Google
				</button>
			</div>

			<form id="new-location-form" class="hidden">

				<div class="form-group">
					<label>Box ID to Set Up</label>
					<div id="box-id-display">Loading...</div>
				</div>

				<div class="form-group">
					<label for="label">Business Name (Label)</label>
					<input type="text" id="label" name="label" required>
				</div>
				<div class="form-group">
					<label for="address">Full Street Address</label>
					<input type="text" id="address" name="address" required>
				</div>
				<div class="form-group">
					<label for="city">City</label>
					<input type="text" id="city" name="city" required>
				</div>
				<div class="form-group">
					<label for="state">State</label>
					<input type="text" id="state" name="state" value="GA" required>
				</div>
				<div class="form-group">
					<label for="boxes">Number of Boxes</label>
					<input type="number" id="boxes" name="boxes" value="1" min="1">
				</div>

				<div class="form-group">
					<label for="volunteer">Your Name (Volunteer)</label>
					<input type="text" id="volunteer" name="volunteer" list="volunteers-list" required>
					<datalist id="volunteers-list">
					</datalist>
				</div>

				<div class="form-group">
					<label for="passcode">Password</label>
					<input type="password" id="passcode" name="passcode" required>
				</div>

				<div class="form-group">
					<button id="submit-btn" type="submit">Submit Location</button>
				</div>

				<div id="message-container"></div>

				<div class="text-center">
					<button id="sign-out-btn" type="button" class="mt-4 text-sm text-gray-600 hover:text-gray-900">Sign Out</button>
				</div>
			</form>
		</div>

		<script type="module">
			// --- 1. IMPORTS ---
			import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
			import {
				getAuth,
				onAuthStateChanged,
				GoogleAuthProvider,
				signInWithPopup,
				signOut
			} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
			import {
				getFirestore,
				collection,
				getDocs
			} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
			// --- NEW: Import Functions ---
			import {
				getFunctions,
				httpsCallable
			} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";


			// --- 2. CONFIG & TOP-LEVEL VARS ---
			const firebaseConfig = {
				apiKey: "AIzaSyC3-oZseVLWFYFbmjAFEgQ-I6hNOgiPj9w",
				authDomain: "toysfortots-eae4d.firebaseapp.com",
				projectId: "toysfortots-eae4d",
				storageBucket: "toysfortots-eae4d.firebasestorage.app",
				messagingSenderId: "505039956655",
				appId: "1:505039956655:web:c750c66b28f7facd82025a"
			};

			const appId = firebaseConfig.projectId;
			let scannedBoxId = null;

			// --- Firestore Paths ---
			const contactsCollectionPath = `artifacts/${appId}/private/aCckkx6FbV1oKOhffIfD/data/V8dC2I8Lte56NJU2GyyY/contacts`;

			// Firebase instances
			let app, auth, db, functions, provisionBox; // Added functions

			// DOM Elements
			const authContainer = document.getElementById('auth-container');
			const signInBtn = document.getElementById('sign-in-btn');
			const signOutBtn = document.getElementById('sign-out-btn');
			const form = document.getElementById('new-location-form');
			const volunteersDatalist = document.getElementById('volunteers-list');
			const messageContainer = document.getElementById('message-container');
			const submitBtn = document.getElementById('submit-btn');
			const boxIdDisplay = document.getElementById('box-id-display');

			// --- 3. HELPER FUNCTIONS ---
			function showMessage(type, text) {
				messageContainer.innerHTML = `<div class="message ${type}">${text}</div>`;
			}

			// --- 4. CORE APP LOGIC ---

			async function fetchVolunteers() {
				try {
					const querySnapshot = await getDocs(collection(db, contactsCollectionPath));
					let options = '';
					querySnapshot.forEach((doc) => {
						const contact = doc.data();
						options += `<option value="${contact.callsign}"></option>`;
					});
					volunteersDatalist.innerHTML = options;
				} catch (error) {
					console.error("Error fetching volunteers:", error);
					showMessage('error', 'Could not load volunteer list. Check permissions.');
				}
			}

			/**
			 * Handles the form submission by calling a Cloud Function
			 */
			async function handleFormSubmit(e) {
				e.preventDefault();

				if (!scannedBoxId) {
					showMessage('error', 'No Box ID found. Cannot submit.');
					return;
				}

				submitBtn.disabled = true;
				submitBtn.textContent = 'Submitting...';
				showMessage('', '');

				// Get data from the form
				const formData = new FormData(form);

				// Build the payload for the Cloud Function
				const payload = {
					boxId: scannedBoxId,
					label: formData.get('label'),
					address: formData.get('address'),
					city: formData.get('city'),
					state: formData.get('state'),
					boxes: parseInt(formData.get('boxes'), 10),
					volunteer: formData.get('volunteer'),
					passcode: formData.get('passcode') // The new secret field
				};

				try {
					// --- Call the Cloud Function ---
					const result = await provisionBox(payload);

					// Success!
					showMessage('success', `Success! Location for Box ID: <strong>${result.data.boxId}</strong> has been saved.`);
					form.reset();
					boxIdDisplay.textContent = scannedBoxId;

				} catch (error) {
					console.error("Error submitting location:", error);
					// The HttpsError from the function will have a .message
					showMessage('error', `Submission failed: ${error.message}`);
				} finally {
					submitBtn.disabled = false;
					submitBtn.textContent = 'Submit Location';
				}
			}

			/**
			 * Initializes Firebase and sets up auth listener
			 */
			function init() {
				const params = new URLSearchParams(window.location.search);
				scannedBoxId = params.get('id');

				if (!scannedBoxId) {
					boxIdDisplay.textContent = "ID NOT FOUND";
					showMessage('error', 'No Box ID found in URL. Please scan a valid QR code.');
					submitBtn.disabled = true;
				} else {
					boxIdDisplay.textContent = scannedBoxId;
				}

				app = initializeApp(firebaseConfig);
				auth = getAuth(app);
				db = getFirestore(app);
				// --- NEW: Initialize Functions ---
				functions = getFunctions(app);
				provisionBox = httpsCallable(functions, 'provisionBox');

				const provider = new GoogleAuthProvider();

				signInBtn.onclick = () => signInWithPopup(auth, provider);
				signOutBtn.onclick = () => signOut(auth);
				form.onsubmit = handleFormSubmit;

				onAuthStateChanged(auth, (user) => {
					if (user && !user.isAnonymous) {
						authContainer.classList.add('hidden');
						form.classList.remove('hidden');
						fetchVolunteers();
					} else {
						authContainer.classList.remove('hidden');
						form.classList.add('hidden');
						volunteersDatalist.innerHTML = '';
						if (user && user.isAnonymous) {
							signOut(auth);
						}
					}
				});
			}
			init();
		</script>
	</body>
</html>
