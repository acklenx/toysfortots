<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width-width, initial-scale=1.0">
		<title>Set Up New Location</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<link rel="stylesheet" href="/style.css?v=1.0.7">
		<style>
			:root {
				--t4t-red: #cc0000;
				--marine-blue: #003366;
			}

			.form-container {
				max-width: 600px;
				margin: 0 auto;
				padding: 30px;
				background: white;
				border-radius: 8px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
			}

			.form-wrapper {
				padding: 20px 0;
			}

			.form-group {
				margin-bottom: 20px;

				label {
					display: block;
					margin-bottom: 5px;
					font-weight: bold;
					color: #333;
				}

				input,
				select {
					width: 100%;
					padding: 10px;
					border: 1px solid #ccc;
					border-radius: 4px;
					box-sizing: border-box;
				}

				button {
					width: 100%;
					padding: 12px;
					background-color: var(--t4t-red);
					color: white;
					border: none;
					border-radius: 4px;
					font-size: 1rem;
					font-weight: bold;
					cursor: pointer;
					transition: background-color 0.2s;

					&:hover {
						background-color: #a80000;
					}

					&:disabled {
						background-color: #ccc;
						cursor: not-allowed;
					}
				}
			}

			#auth-container {
				text-align: center;
				padding: 40px;
			}

			.message {
				text-align: center;
				padding: 15px;
				border-radius: 4px;
				margin-top: 20px;
				font-weight: 500;

				&.success {
					background-color: #d4edda;
					color: #155724;
				}

				&.error {
					background-color: #f8d7da;
					color: #721c24;
				}
			}

			#box-id-display {
				background-color: #f4f4f4;
				border: 1px solid #ddd;
				padding: 10px 15px;
				border-radius: 4px;
				text-align: center;
				font-family: monospace;
				font-size: 1.2rem;
				font-weight: bold;
				color: var(--marine-blue);
			}

			header {
				h1 {
					a:hover {
						text-decoration: underline;
					}
				}
				h2 {
					a:hover {
						text-decoration: underline;
					}
				}
			}

			.bg-marine-blue {
				background-color: var(--marine-blue);
			}
		</style>
	</head>
	<body class="bg-gray-100">

		<header>
			<div class="header-content">
				<a href="https://www.toysfortots.org" target="_blank" rel="noopener noreferrer">
					<img src="/images/t4t-logo.png" height="60" alt="Toys for Tots Logo" class="logo t4t-logo">
				</a>
				<div class="header-text">
					<a href="https://toysfortots.mcl1311.com/" rel="noopener noreferrer" style="color: var(--marine-blue);">
						<h1>Toys for Tots Drop-Off Locations</h1>
					</a>
					<a href="https://northatlanta.toysfortots.org/" target="_blank" rel="noopener noreferrer" style="color: var(--t4t-red);">
						<h2>North Metro Atlanta Area</h2>
					</a>
					<p class="sub-header">Coordinated by Marine Corps League Detachment #1311, Woodstock, GA</p>
				</div>
				<a href="/dashboard">
					<img src="/images/mcl-logo.png" height="80" alt="Marine Corps League Logo" class="logo mcl-logo">
				</a>
			</div>
		</header>

		<div class="form-wrapper">
			<div class="form-container">
				<h1 class="text-2xl font-bold text-center mb-6 text-gray-800">Set Up New Box Location</h1>

				<div id="auth-container">
					<p class="mb-4">You must be signed in to set up a new location.</p>

					<button id="sign-in-btn" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
						Sign In with Google
					</button>

					<button id="show-email-setup-btn" class="text-sm text-gray-600 hover:text-gray-900 mt-3">
						... or click <span class="text-blue-600 underline">here</span> to setup without Google
					</button>

					<div id="or-divider" class="my-4 text-gray-500 font-semibold hidden">-- OR --</div>

					<div id="email-auth-section" class="mt-4 p-4 border rounded-lg bg-gray-50 hidden">

						<h2 class="text-xl font-bold mb-4 text-gray-700" id="email-auth-title">Create <label for="auth-email">Account</label> with <label for="auth-password">Username</label></h2>

						<input type="text" id="auth-email" placeholder="Username" class="w-full p-2 mb-2 border rounded">

						<p id="password-hint" class="text-xs text-gray-500 mb-4">
							Please pick a new password.
						</p>

						<input type="password" id="auth-password" placeholder="Password" class="w-full p-2 mb-3 border rounded">

						<span id="toggle-password" class="block text-right text-sm text-blue-600 hover:underline cursor-pointer -mt-2 mb-3" style="display: block; text-align: right; font-size: 0.875rem; color: #3b82f6; cursor: pointer; margin-top: -0.5rem; margin-bottom: 0.75rem;">
    show password
</span>
						<button id="email-sign-in-btn" class="w-full px-6 py-3 bg-marine-blue text-white rounded-lg font-semibold hover:bg-blue-800 transition hidden">
							Sign In
						</button>
						<button id="email-sign-up-btn" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
							Create Account
						</button>

						<p class="text-sm mt-3">
							<button id="toggle-sign-up-btn" class="text-marine-blue hover:underline font-medium">
								Already have an account? Sign In
							</button>
						</p>
					</div>

				</div>
				<form id="new-location-form" class="hidden">

					<div class="form-group">
						<label>Box ID to Set Up</label>
						<div id="box-id-display">Loading...</div>
					</div>

					<div class="form-group">
						<label for="passcode">Setup Code</label>
						<input type="password" id="passcode" name="passcode" required>

						<span id="toggle-passcode" style="display: block; text-align: right; font-size: 0.875rem; color: #3b82f6; cursor: pointer;  margin-bottom: 0.75rem;">
       show code
   </span>
					</div>

					<div class="my-6 h-1 bg-gray-300"></div>

					<div class="mb-5">
						<button id="gps-btn" type="button" class="w-3/4 block mx-auto py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-md transition duration-200">
							Use My GPS Location
						</button>
						<div id="gps-error-msg" class="text-center text-sm text-red-600 mt-2"></div>
					</div>

					<div id="show-address-btn" class="text-center my-4 text-gray-700 cursor-pointer hover:text-gray-900">
						Click <span class="underline font-medium">here</span> to type in the address
					</div>

					<input type="hidden" id="lat" name="lat">
					<input type="hidden" id="lon" name="lon">
					<input type="hidden" id="county" name="county">
					<input type="hidden" id="postalcode" name="postalcode">

					<div id="manual-address-fields" class="hidden">
						<div class="form-group">
							<label for="address">Full Street Address</label>
							<input type="text" id="address" name="address" required>
						</div>
						<div class="form-group">
							<label for="city">City</label>
							<input type="text" id="city" name="city">
						</div>
						<div class="form-group">
							<label for="state">State</label>
							<input type="text" id="state" name="state" value="GA" required>
						</div>
					</div>

					<div class="form-group" style="display: none;">
						<label for="boxes">Number of Boxes</label>
						<input type="number" id="boxes" name="boxes" value="1" min="1">
					</div>

					<div class="my-6 h-1 bg-gray-300"></div>

					<div class="form-group">
						<label for="label">Location Name (Label)</label>
						<input type="text" id="label" name="label" required>
					</div>

					<div class="form-group">
						<label for="contactName">Contact Name</label>
						<input type="text" id="contactName" name="contactName" required>
					</div>

					<div class="form-group">
						<label for="contactEmail">Contact Email</label>
						<input type="email" id="contactEmail" name="contactEmail" required>
					</div>

					<div class="form-group">
						<label for="contactPhone">Contact Phone</label>
						<input type="tel" id="contactPhone" name="contactPhone">
					</div>



					<div class="form-group">
						<button id="submit-btn" type="submit">Submit Location</button>
					</div>

					<div id="message-container"></div>

					<div class="text-center">
						<button id="sign-out-btn" type="button" class="mt-4 text-sm text-gray-600 hover:text-gray-900">
							Sign Out
						</button>
					</div>
				</form>
			</div>

			<script type="module">
				// --- 1. IMPORTS (No change needed here, we use the same auth import) ---
				import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
				import {
					getAuth,
					onAuthStateChanged,
					GoogleAuthProvider,
					signInWithPopup,
					signOut,
					// NEW IMPORTS:
					createUserWithEmailAndPassword,
					signInWithEmailAndPassword
				} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
				import {
					getFirestore,
					doc,
					getDoc
				} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
				// --- Import Functions ---
				import {
					getFunctions,
					httpsCallable
				} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js';


				// --- 2. CONFIG & TOP-LEVEL VARS ---
				const firebaseConfig = {
					apiKey: 'AIzaSyC3-oZseVLWFYFbmjAFEgQ-I6hNOgiPj9w',
					authDomain: 'toysfortots-eae4d.firebaseapp.com',
					projectId: 'toysfortots-eae4d',
					storageBucket: 'toysfortots-eae4d.firebasestorage.app',
					messagingSenderId: '505039956655',
					appId: '1:505039956655:web:c750c66b28f7facd82025a'
				};

				const appId = firebaseConfig.projectId;
				let scannedBoxId = null;
				const publicDocumentId = '01';
				const dataDocumentId = '01';
				const locationsCollectionPath = `artifacts/${ appId }/public/${ publicDocumentId }/data/${ dataDocumentId }/locations`;

				// Firebase instances
				let app, auth, db, functions, provisionBox, isAuthorizedVolunteer;

				// DOM Elements
				const authContainer = document.getElementById( 'auth-container' );
				const signInBtn = document.getElementById( 'sign-in-btn' ); // Google Sign In
				const signOutBtn = document.getElementById( 'sign-out-btn' );
				const form = document.getElementById( 'new-location-form' );
				const messageContainer = document.getElementById( 'message-container' );
				const submitBtn = document.getElementById( 'submit-btn' );
				const boxIdDisplay = document.getElementById( 'box-id-display' );
				const latInput = document.getElementById('lat');
				const lonInput = document.getElementById('lon');
				const gpsBtn = document.getElementById('gps-btn');
				const addressInput = document.getElementById('address');
				const cityInput = document.getElementById('city');
				const stateInput = document.getElementById('state');
				const countyInput = document.getElementById('county');
				const postalCodeInput = document.getElementById('postalcode');
				const showAddressBtn = document.getElementById('show-address-btn');
				const manualAddressFields = document.getElementById('manual-address-fields');
				const gpsErrorMsg = document.getElementById('gps-error-msg');
				const passcode = document.getElementById('passcode');
				const togglePasscode = document.getElementById('toggle-passcode');
				// --- NEW/MODIFIED EMAIL DOM ELEMENTS ---
				const showEmailSetupBtn = document.getElementById('show-email-setup-btn');
				const orDivider = document.getElementById('or-divider');
				const emailAuthSection = document.getElementById('email-auth-section');
				const emailAuthTitle = document.getElementById('email-auth-title');
				const authEmail = document.getElementById('auth-email');
				const authPassword = document.getElementById('auth-password');
				const togglePassword = document.getElementById('toggle-password');
				const passwordHint = document.getElementById('password-hint'); // New
				const emailSignInBtn = document.getElementById('email-sign-in-btn');
				const emailSignUpBtn = document.getElementById('email-sign-up-btn');
				const toggleSignUpBtn = document.getElementById('toggle-sign-up-btn');


				// --- 3. HELPER FUNCTIONS ---
				function showMessage( type, text )
				{
					messageContainer.innerHTML = `<div class="message ${ type }">${ text }</div>`;
				}


				/**
				 * Uses the browser's Geolocation API to get coordinates and fill address fields.
				 */
				/**
				 * Uses the browser's Geolocation API to get coordinates and fill address fields.
				 */


				/**
				 * Uses the browser's Geolocation API, then performs reverse geocoding
				 * to get coordinates AND address, filling the form fields.
				 */
				async function getGeoLocation() {
					// --- Clear old messages ---
					showMessage('', '');
					gpsErrorMsg.textContent = '';
					gpsBtn.disabled = true;

					// Reset button appearance while searching
					gpsBtn.textContent = 'Searching...';
					gpsBtn.classList.remove('bg-red-500', 'bg-green-600');
					gpsBtn.classList.add('bg-yellow-500');

					if (!navigator.geolocation) {
						gpsErrorMsg.textContent = 'Geolocation is not supported by this browser.';
						gpsBtn.disabled = false;
						gpsBtn.textContent = 'Use My GPS Location';
						gpsBtn.classList.remove('bg-yellow-500');
						gpsBtn.classList.add('bg-red-500');
						manualAddressFields.classList.remove('hidden');
						showAddressBtn.classList.add('hidden');
						addressInput.focus();
						return;
					}

					// 1. GET GPS COORDINATES
					navigator.geolocation.getCurrentPosition(async (position) => {
						const lat = position.coords.latitude;
						const lon = position.coords.longitude;

						// Populate hidden fields
						latInput.value = lat;
						lonInput.value = lon;

						try {
							// 2. GET ADDRESS (REVERSE GEOCODING)
							gpsBtn.textContent = 'Got GPS, Getting Address...';
							const geoApiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;

							const response = await fetch(geoApiUrl);
							if (!response.ok) {
								throw new Error(`Address lookup failed (status: ${response.status})`);
							}
							const data = await response.json();

							console.log('Reverse Geocode Response:', data); // For your debugging
							// Populate address fields
							if (data && data.address) {
								const addr = data.address;

								// Construct the street address (house number + road)
								const street = `${addr.house_number || ''} ${addr.road || ''}`.trim();

								addressInput.value = street;
								cityInput.value = addr.city || addr.town || addr.village || '';
								stateInput.value = addr.state || 'GA'; // Use found state, default to GA
								countyInput.value = addr.county || '';
								postalCodeInput.value = addr.postcode || '';
								// Bonus: Try to find a good "Location Name"
								const labelInput = document.getElementById('label');
								if (labelInput.value === '') { // Only if not already filled
									labelInput.value = addr.amenity || addr.shop || addr.building || addr.office || '';
								}

								showMessage('success', 'Location and Address captured!');
							} else {
								throw new Error('Address not found in API response.');
							}

						} catch (geoError) {
							console.error('Reverse Geocoding Error:', geoError);
							gpsErrorMsg.textContent = 'Got GPS, but failed to get address. Please type it manually.';
							// We still continue, to show the manual fields
						}

						// 3. SHOW FIELDS AND SET SUCCESS STATE (this runs after try/catch)
						const latFixed = lat.toFixed(4);
						const lonFixed = lon.toFixed(4);

						gpsBtn.innerHTML = `
            Location Set (GPS)
            <div class="text-xs font-normal opacity-75 mt-1">
                Lat: ${latFixed}, Lon: ${lonFixed}
            </div>
        `;

						manualAddressFields.classList.remove('hidden');
						showAddressBtn.classList.add('hidden');

						// Focus the "Location Name" field first, as address is likely filled
						document.getElementById('label').focus();

						gpsBtn.classList.remove('bg-yellow-500');
						gpsBtn.classList.add('bg-green-600'); // Success color
						gpsBtn.disabled = false;

					}, (error) => {
						// --- THIS IS THE GEOLOCATION ERROR CALLBACK ---
						console.error('Geolocation Error:', error);
						gpsErrorMsg.textContent = `Could not get location: ${error.message}`;

						gpsBtn.textContent = 'Use My GPS Location';
						gpsBtn.classList.remove('bg-yellow-500', 'bg-green-600');
						gpsBtn.classList.add('bg-red-500');
						gpsBtn.disabled = false;
						latInput.value = '';
						lonInput.value = '';

						manualAddressFields.classList.remove('hidden');
						showAddressBtn.classList.add('hidden');
						addressInput.focus();

					}, {
						enableHighAccuracy: true,
						timeout: 10000, // Increased timeout to 10s
						maximumAge: 0
					});
				}

				function showAuthMessage(type, text) {
					const emailAuthSection = document.getElementById('email-auth-section');
					let msgDiv = document.getElementById('auth-msg');
					if (!msgDiv) {
						msgDiv = document.createElement('div');
						msgDiv.id = 'auth-msg';
						// Insert before the email input
						emailAuthSection.insertBefore(msgDiv, authEmail);
					}
					msgDiv.innerHTML = `<div class="message ${type} mt-3 mb-3">${text}</div>`;
				}

				function clearAuthMessage() {
					const msgDiv = document.getElementById('auth-msg');
					if (msgDiv) {
						msgDiv.remove();
					}
				}

				// --- 4. NEW EMAIL/PASSWORD HANDLERS ---

				// --- 4. NEW EMAIL/PASSWORD HANDLERS ---
				async function handleEmailSignIn() {
					clearAuthMessage();
					const username = authEmail.value; // Get username
					const password = authPassword.value;
					if (!username || !password) {
						showAuthMessage('error', 'Please enter both username and password.');
						return;
					}

					// Add validation to prevent users from entering an email
					if (username.includes('@')) {
						showAuthMessage('error', 'Username cannot contain "@" symbol. Just enter the username.');
						return;
					}

					// Construct the full email
					const email = `${username}@toysfortots.mcl1311.com`;

					try {
						await signInWithEmailAndPassword(auth, email, password);
					} catch (error) {
						console.error('Email Sign In Error:', error);
						// Provide a user-friendly error
						if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
							showAuthMessage('error', 'Sign in failed: Invalid username or password.');
						} else {
							showAuthMessage('error', `Sign in failed: ${error.message}`);
						}
					}
				}

				async function handleEmailSignUp() {
					clearAuthMessage();
					const username = authEmail.value; // Get username
					const password = authPassword.value;
					// const retypePassword = authPasswordRetype.value; // <-- REMOVED

					if (!username || !password) { // <-- MODIFIED (removed retypePassword)
						showAuthMessage('error', 'Please fill out all fields.');
						return;
					}

					// Add validation to prevent users from entering an email
					if (username.includes('@')) {
						showAuthMessage('error', 'Username cannot contain "@" symbol.');
						return;
					}

					if (password.length < 6) {
						showAuthMessage('error', 'Password must be at least 6 characters.');
						return;
					}

					const email = `${username}@toysfortots.mcl1311.com`;

					try {
						await createUserWithEmailAndPassword(auth, email, password);
					} catch (error) {
						console.error('Email Sign Up Error:', error);
						// Provide a user-friendly error
						if (error.code === 'auth/email-already-in-use') {
							showAuthMessage('error', 'Sign up failed: This username is already taken.');
						} else {
							showAuthMessage('error', `Sign up failed: ${error.message}`);
						}
					}
				}

				function toggleEmailAuthMode() {
					clearAuthMessage();
					// Clear passwords when toggling
					authPassword.value = '';
					const isSignUpMode = emailSignInBtn.classList.contains('hidden');

					if (isSignUpMode) {
						// Switch to Sign In
						emailAuthTitle.textContent = 'Sign In with Username';
						emailSignInBtn.classList.remove('hidden');
						emailSignUpBtn.classList.add('hidden');
						passwordHint.classList.add('hidden'); // Hide hint
						toggleSignUpBtn.textContent = 'New user? Create an account';
					} else {
						emailAuthTitle.textContent = 'Create Account with Username';
						emailSignInBtn.classList.add('hidden');
						emailSignUpBtn.classList.remove('hidden');
						passwordHint.classList.remove('hidden');
						toggleSignUpBtn.textContent = 'Already have an account? Sign In';
					}
				}


				// New handler to show the email section
				function showEmailSetup() {
					emailAuthSection.classList.remove('hidden');
					orDivider.classList.remove('hidden');
					showEmailSetupBtn.classList.add('hidden'); // Hide the button after clicking
				}
				// --- END NEW EMAIL/PASSWORD HANDLERS ---


				/**
				 * Handles the form submission by calling a Cloud Function
				 */

				// --- 4. CORE APP LOGIC ---

				/**
				 * Handles the form submission by calling a Cloud Function
				 */
				async function handleFormSubmit( e )
				{
					e.preventDefault();

					if( !auth.currentUser || auth.currentUser.isAnonymous ) {
						showMessage( 'error', 'You must be signed in to submit this form.' );
						console.error('Client Error: Submission attempted while user is logged out or anonymous.');
						return;
					}

					if( !scannedBoxId )
					{
						showMessage( 'error', 'No Box ID found. Cannot submit.' );
						return;
					}

					submitBtn.disabled = true;
					submitBtn.textContent = 'Submitting...';
					showMessage( '', '' );

					// Get data from the form
					const formData = new FormData( form );

					// Build the payload (UPDATED to include lat/lon)
					const payload = {
						boxId: scannedBoxId,
						label: formData.get( 'label' ),
						address: formData.get( 'address' ),
						city: formData.get( 'city' ),
						county: formData.get( 'county' ),
						state: formData.get( 'state' ),
						postalcode: formData.get( 'postalcode' ),
						boxes: 1,
						passcode: formData.get( 'passcode' ),
						contactName: formData.get( 'contactName' ),
						contactEmail: formData.get( 'contactEmail' ),
						contactPhone: formData.get( 'contactPhone' ),
						// --- NEW: GPS Coordinates from hidden fields ---
						lat: formData.get( 'lat' ) ? parseFloat(formData.get('lat')) : null,
						lon: formData.get( 'lon' ) ? parseFloat(formData.get('lon')) : null
					};
					console.log('Client: Submitting form with payload:', payload );

					try
					{
						// Ensure you're calling the correct V2 function name
						const provisionBoxV2 = httpsCallable( functions, 'provisionBoxV2' );

						console.log('Client: Attempting to call provisionBoxV2 with payload:', payload);
						const result = await provisionBoxV2( payload );
						console.log('Client: provisionBoxV2 returned success.', result.data);

						// --- SUCCESS BLOCK ---
						const newBoxId = result.data.boxId;
						showMessage( 'success', `Success! Box ID: <strong>${ newBoxId }</strong> saved. Redirecting in 2 seconds...` );

						form.reset();
						boxIdDisplay.textContent = scannedBoxId;

						setTimeout( () =>
						{
							window.location.href = `/status/?id=${ newBoxId }`;
						}, 2000 );

					}
					catch( error )
					{
						// Enhanced error logging to catch UNAUTHENTICATED or network issues
						console.error( 'Error submitting location:', error );

						let displayMessage = `Submission failed: ${ error.message || 'An unknown error occurred.' }`;

						if (error.code) {
							// Check if it's an HttpsError from the server
							console.error(`Error Code: ${error.code}. Details: ${error.details}`);
							displayMessage = `Error (${error.code}): ${error.message}`;
						} else if (error.name === 'FirebaseError' && error.message.includes('permission-denied')) {
							// Fallback for older SDK error handling
							displayMessage = 'Permission Denied: Check the volunteer passcode.';
						} else if (error.name === 'FirebaseError' && error.message.includes('UNAUTHENTICATED')) {
							// The function was rejected by the transport layer
							displayMessage = 'Authentication Required: Please sign out and sign in again, then retry.';
							console.error('CRITICAL: Callable function rejected request due to missing/invalid auth token.');
						}

						showMessage( 'error', displayMessage );
						submitBtn.disabled = false;
						submitBtn.textContent = 'Submit Location';
					}
				}


				/**
				 * Initializes Firebase and sets up auth listener
				 */
				/**
				 * Initializes Firebase and sets up auth listener
				 */
				function init()
				{
					const params = new URLSearchParams( window.location.search );
					scannedBoxId = params.get( 'id' );

					if( !scannedBoxId )
					{
						boxIdDisplay.textContent = 'ID NOT FOUND';
						showMessage( 'error', 'No Box ID found in URL. Please scan a valid QR code.' );
						submitBtn.disabled = true;
					}
					else
					{
						boxIdDisplay.textContent = scannedBoxId;
					}

					app = initializeApp( firebaseConfig );
					auth = getAuth( app );
					db = getFirestore( app );

					// --- CRITICAL FIX: Explicitly set the function region ---
					functions = getFunctions( app, 'us-central1' );

					provisionBox = httpsCallable( functions, 'provisionBoxV2' );
					isAuthorizedVolunteer = httpsCallable( functions, 'isAuthorizedVolunteerV2' );

					const provider = new GoogleAuthProvider();

					showEmailSetupBtn.onclick = showEmailSetup;
					emailSignInBtn.onclick = handleEmailSignIn;
					emailSignUpBtn.onclick = handleEmailSignUp;
					toggleSignUpBtn.onclick = toggleEmailAuthMode;
					gpsBtn.onclick = getGeoLocation;

					togglePassword.onclick = function() {
						const type = authPassword.getAttribute('type') === 'password' ? 'text' : 'password';
						authPassword.setAttribute('type', type);
						this.textContent = (type === 'password') ? 'show password' : 'hide password';
					};

					togglePasscode.onclick = function() {
						const type = passcode.getAttribute('type') === 'password' ? 'text' : 'password';
						passcode.setAttribute('type', type);
						this.textContent = (type === 'password') ? 'show code' : 'hide code';
					};

					showAddressBtn.onclick = () => {
						gpsErrorMsg.textContent = '';
						manualAddressFields.classList.remove('hidden');
						showAddressBtn.classList.add('hidden');
						addressInput.focus();
					};

					signInBtn.onclick = () => signInWithPopup( auth, provider );
					signOutBtn.onclick = () => signOut( auth );
					form.onsubmit = handleFormSubmit;

					onAuthStateChanged( auth, async( user ) =>
					{
						if( user && !user.isAnonymous )
						{
							clearAuthMessage();

							if( !scannedBoxId )
							{
								authContainer.classList.add( 'hidden' );
								form.classList.add( 'hidden' );
								showMessage( 'error', 'No Box ID found in URL. Cannot check status.' );
								return;
							}

							try
							{
								const locRef = doc( db, locationsCollectionPath, scannedBoxId );
								const locSnap = await getDoc( locRef );

								if( locSnap.exists() )
								{
									authContainer.classList.add( 'hidden' );
									form.classList.add( 'hidden' );
									showMessage( 'success', 'This box is already set up. Redirecting to status page...' );

									window.location.href = `/status/?id=${ scannedBoxId }`;
									return;
								}

								authContainer.classList.add( 'hidden' );
								form.classList.remove( 'hidden' );
								showEmailSetupBtn.classList.remove('hidden'); // Ensure this is visible on auth -> form transition

								const passcodeGroup = passcode.parentElement;
								const passcodeLabel = passcodeGroup.querySelector( 'label' );

								passcodeLabel.textContent = 'Verifying authorization...';
								const result = await isAuthorizedVolunteer();

								if( result.data.isAuthorized )
								{
									passcodeGroup.classList.add( 'hidden' );
									passcode.required = false;
									passcode.value = '';
									passcodeLabel.textContent = 'Password (Authorized)';
								}
								else
								{
									passcodeGroup.classList.remove( 'hidden' );
									passcode.required = true;
									passcodeLabel.textContent = 'One time setup code';
								}

							}
							catch( error )
							{
								console.error( 'Setup page check failed:', error );
								authContainer.classList.add( 'hidden' );
								form.classList.add( 'hidden' );
								showMessage( 'error', `An error occurred: ${ error.message }` );
							}

						}
						else
						{
							// User is signed out
							authContainer.classList.remove( 'hidden' );
							form.classList.add( 'hidden' );
							clearAuthMessage();

							// Make sure email setup button is visible again
							showEmailSetupBtn.classList.remove('hidden');
							// And email section is hidden
							emailAuthSection.classList.add('hidden');
							orDivider.classList.add('hidden');


							// Reset email auth form to default "Sign Up" mode
							// Check if it's currently in "Sign In" mode (Sign In button is VISIBLE)
							if (!emailSignInBtn.classList.contains('hidden')) {
								toggleEmailAuthMode(); // Toggle it back to Sign Up
							}

							document.getElementById( 'passcode' ).parentElement.classList.remove( 'hidden' );
							document.getElementById( 'passcode' ).required = true;

							if( user && user.isAnonymous )
							{
								signOut( auth );
							}
						}
					} );
				}
				init();
			</script>

		</div>
		<footer>
			<p>When our certified volunteers in Marine Corps League attire arrive to service a drop-off box, they are
				official representatives of this Toys for Tots campaign.</p>
			<img src="/images/gunny-bear.png" height="100" alt="Marine Bear Mascot" class="footer-bear" onclick="if(event.shiftKey){document.location='/print/';} else {document.location='/box/?id=007';}">
		</footer>
	</body>
</html>