import{db,locationSuggestionsCollectionPath}from"./firebase-init.js";import{collection,query,where,getDocs,orderBy,limit}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";function escapeHtml(t){return t?String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function normalizeForSearch(t){return(t||"").toLowerCase().trim()}export async function searchByAddress(t,e=10){if(!t||t.length<3)return[];const n=normalizeForSearch(t),a=collection(db,locationSuggestionsCollectionPath);try{const t=query(a,where("searchAddress",">=",n),where("searchAddress","<=",n+""),orderBy("searchAddress"),limit(e)),o=await getDocs(t),r=[];return o.forEach(t=>{r.push({id:t.id,...t.data()})}),r}catch(t){return console.error("Error searching by address:",t),[]}}export async function searchByLabel(t,e=10){if(!t||t.length<2)return[];const n=normalizeForSearch(t),a=collection(db,locationSuggestionsCollectionPath);try{const t=query(a,where("searchLabel",">=",n),where("searchLabel","<=",n+""),orderBy("searchLabel"),limit(e)),o=await getDocs(t),r=[];return o.forEach(t=>{r.push({id:t.id,...t.data()})}),r}catch(t){return console.error("Error searching by label:",t),[]}}export async function findExactMatchByAddress(t){const e=await searchByAddress(t,5),n=normalizeForSearch(t);return e.find(t=>t.searchAddress===n)||null}export function autoFillFormFields(t,e={}){const n={label:"label",address:"address",city:"city",state:"state",contactName:"contactName",contactEmail:"contactEmail",contactPhone:"contactPhone",...e},a=(t,e)=>{const n=document.getElementById(t);n&&!n.value&&e&&(n.value=e)};a(n.label,t.label),a(n.address,t.address),a(n.city,t.city),a(n.state,t.state),a(n.contactName,t.contactName),a(n.contactEmail,t.contactEmail),a(n.contactPhone,t.contactPhone)}export function createAutocomplete(t,e,n,a=300){let o,r,c=-1,s=[];function l(){r.querySelectorAll(".autocomplete-item").forEach((t,e)=>{t.style.backgroundColor=e===c?"#e3f2fd":"white"})}function i(){c>=0&&c<s.length&&(n(s[c]),r.style.display="none",c=-1)}r=function(){const e=document.createElement("div");return e.className="autocomplete-dropdown",e.style.cssText="\n\t\t\tposition: absolute;\n\t\t\tbackground: white;\n\t\t\tborder: 1px solid #ccc;\n\t\t\tborder-top: none;\n\t\t\tmax-height: 200px;\n\t\t\toverflow-y: auto;\n\t\t\tz-index: 1000;\n\t\t\tbox-shadow: 0 4px 6px rgba(0,0,0,0.1);\n\t\t",e.style.display="none",t.parentElement.style.position="relative",t.parentElement.appendChild(e),e}(),t.addEventListener("input",i=>{const d=i.target.value;if(clearTimeout(o),c=-1,d.length<2)return r.style.display="none",void(s=[]);o=setTimeout(async()=>{const a=await e(d);if(s=a,0===a.length)return r.style.display="none",void(s=[]);r.innerHTML=a.map(t=>`\n\t\t\t\t<div class="autocomplete-item" data-id="${escapeHtml(t.id)}" style="\n\t\t\t\t\tpadding: 10px;\n\t\t\t\t\tcursor: pointer;\n\t\t\t\t\tborder-bottom: 1px solid #eee;\n\t\t\t\t">\n\t\t\t\t\t<div style="font-weight: bold;">${escapeHtml(t.label||"(No label)")}</div>\n\t\t\t\t\t<div style="font-size: 0.875rem; color: #666;">${escapeHtml(t.address||"")}, ${escapeHtml(t.city||"")}</div>\n\t\t\t\t</div>\n\t\t\t`).join(""),r.style.display="block",r.style.top=t.offsetHeight+"px",r.style.left="0",r.style.width=t.offsetWidth+"px",r.querySelectorAll(".autocomplete-item").forEach((t,e)=>{t.addEventListener("mouseenter",()=>{c=e,l()}),t.addEventListener("click",()=>{const e=t.getAttribute("data-id"),o=a.find(t=>t.id===e);o&&(n(o),r.style.display="none",c=-1)})})},a)}),document.addEventListener("click",e=>{e.target===t||r.contains(e.target)||(r.style.display="none",c=-1)}),t.addEventListener("keydown",t=>{if("block"===r.style.display)switch(t.key){case"ArrowDown":t.preventDefault(),c=Math.min(c+1,s.length-1),l();break;case"ArrowUp":t.preventDefault(),c=Math.max(c-1,0),l();break;case"Enter":t.preventDefault(),i();break;case"Tab":-1===c&&s.length>0?(t.preventDefault(),c=0,i()):c>=0&&(t.preventDefault(),i());break;case"Escape":t.preventDefault(),r.style.display="none",c=-1}})}