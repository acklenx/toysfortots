import{db,locationSuggestionsCollectionPath}from"./firebase-init.js";import{collection,query,where,getDocs,orderBy,limit}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";function normalizeForSearch(t){return(t||"").toLowerCase().trim()}export async function searchByAddress(t,e=10){if(!t||t.length<3)return[];const n=normalizeForSearch(t),o=collection(db,locationSuggestionsCollectionPath);try{const t=query(o,where("searchAddress",">=",n),where("searchAddress","<=",n+""),orderBy("searchAddress"),limit(e)),a=await getDocs(t),r=[];return a.forEach(t=>{r.push({id:t.id,...t.data()})}),r}catch(t){return console.error("Error searching by address:",t),[]}}export async function searchByLabel(t,e=10){if(!t||t.length<2)return[];const n=normalizeForSearch(t),o=collection(db,locationSuggestionsCollectionPath);try{const t=query(o,where("searchLabel",">=",n),where("searchLabel","<=",n+""),orderBy("searchLabel"),limit(e)),a=await getDocs(t),r=[];return a.forEach(t=>{r.push({id:t.id,...t.data()})}),r}catch(t){return console.error("Error searching by label:",t),[]}}export async function findExactMatchByAddress(t){const e=await searchByAddress(t,5),n=normalizeForSearch(t);return e.find(t=>t.searchAddress===n)||null}export function autoFillFormFields(t,e={}){const n={label:"label",address:"address",city:"city",state:"state",contactName:"contactName",contactEmail:"contactEmail",contactPhone:"contactPhone",...e},o=(t,e)=>{const n=document.getElementById(t);n&&!n.value&&e&&(n.value=e)};o(n.label,t.label),o(n.address,t.address),o(n.city,t.city),o(n.state,t.state),o(n.contactName,t.contactName),o(n.contactEmail,t.contactEmail),o(n.contactPhone,t.contactPhone)}export function createAutocomplete(t,e,n,o=300){let a,r,s=-1,c=[];function i(){r.querySelectorAll(".autocomplete-item").forEach((t,e)=>{t.style.backgroundColor=e===s?"#e3f2fd":"white"})}function l(){s>=0&&s<c.length&&(n(c[s]),r.style.display="none",s=-1)}r=function(){const e=document.createElement("div");return e.className="autocomplete-dropdown",e.style.cssText="\n\t\t\tposition: absolute;\n\t\t\tbackground: white;\n\t\t\tborder: 1px solid #ccc;\n\t\t\tborder-top: none;\n\t\t\tmax-height: 200px;\n\t\t\toverflow-y: auto;\n\t\t\tz-index: 1000;\n\t\t\tbox-shadow: 0 4px 6px rgba(0,0,0,0.1);\n\t\t",e.style.display="none",t.parentElement.style.position="relative",t.parentElement.appendChild(e),e}(),t.addEventListener("input",l=>{const d=l.target.value;if(clearTimeout(a),s=-1,d.length<2)return r.style.display="none",void(c=[]);a=setTimeout(async()=>{const o=await e(d);if(c=o,0===o.length)return r.style.display="none",void(c=[]);r.innerHTML=o.map(t=>`\n\t\t\t\t<div class="autocomplete-item" data-id="${t.id}" style="\n\t\t\t\t\tpadding: 10px;\n\t\t\t\t\tcursor: pointer;\n\t\t\t\t\tborder-bottom: 1px solid #eee;\n\t\t\t\t">\n\t\t\t\t\t<div style="font-weight: bold;">${t.label||"(No label)"}</div>\n\t\t\t\t\t<div style="font-size: 0.875rem; color: #666;">${t.address||""}, ${t.city||""}</div>\n\t\t\t\t</div>\n\t\t\t`).join(""),r.style.display="block",r.style.top=t.offsetHeight+"px",r.style.left="0",r.style.width=t.offsetWidth+"px",r.querySelectorAll(".autocomplete-item").forEach((t,e)=>{t.addEventListener("mouseenter",()=>{s=e,i()}),t.addEventListener("click",()=>{const e=t.getAttribute("data-id"),a=o.find(t=>t.id===e);a&&(n(a),r.style.display="none",s=-1)})})},o)}),document.addEventListener("click",e=>{e.target===t||r.contains(e.target)||(r.style.display="none",s=-1)}),t.addEventListener("keydown",t=>{if("block"===r.style.display)switch(t.key){case"ArrowDown":t.preventDefault(),s=Math.min(s+1,c.length-1),i();break;case"ArrowUp":t.preventDefault(),s=Math.max(s-1,0),i();break;case"Enter":t.preventDefault(),l();break;case"Tab":-1===s&&c.length>0?(t.preventDefault(),s=0,l()):s>=0&&(t.preventDefault(),l());break;case"Escape":t.preventDefault(),r.style.display="none",s=-1}})}